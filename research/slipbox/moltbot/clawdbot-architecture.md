# Clawdbot 系统架构文档

本文档集包含 Clawdbot 项目的完整架构分析和 ASCII 图表。

## 统一架构模型（6 层）

所有文档采用统一的 6 层架构模型：

| 层 | 名称 | 职责 |
|---|---|---|
| 1 | Entry Layer | 入口层：UI、Channel Plugins、HTTP Endpoints |
| 2 | Gateway Layer | 网关层：协调者，HTTP/WS 服务，Channel 管理 |
| 3 | Routing Layer | 路由层：Preflight、路由解析、会话键生成 |
| 4 | Agents Layer | 代理层：Agent 运行时、工具系统、认证轮换 |
| 5 | Infrastructure Layer | 基础设施层：纯工具箱，被动服务 |
| 6 | External Services | 外部服务：LLM 提供商 |

**关键设计原则：**
- 依赖方向单向自顶向下
- Gateway 是协调者，独立于 Infrastructure Layer
- Infrastructure Layer 是纯支撑服务层（Servant Pattern），从不调用上层

## 文档索引

| 文档 | 内容 |
|------|------|
| [01-system-overview.md](01-system-overview.md) | 系统整体架构（6 层）、CLI 命令结构 |
| [02-message-flow.md](02-message-flow.md) | 消息处理流程、时序图 |
| [03-plugin-system.md](03-plugin-system.md) | 插件系统架构、扩展目录结构 |
| [04-agent-runtime.md](04-agent-runtime.md) | Agent 运行时架构、入口点 |
| [05-agent-tools.md](05-agent-tools.md) | 工具系统、Bash 执行流程 |
| [06-agent-streaming.md](06-agent-streaming.md) | 流式事件处理、Delta 处理机制 |
| [07-agent-auth.md](07-agent-auth.md) | 认证轮换逻辑、Cooldown 机制 |
| [08-agent-session.md](08-agent-session.md) | 会话状态管理、压缩、历史管理 |
| [09-end-to-end-detailed.md](09-end-to-end-detailed.md) | 端到端详细架构图（6 层全景、Gateway Layer、Agents Layer、Infrastructure Layer、时序图） |

## 图表字符集参考

### 边框字符
```
水平线: ─ ━ ═
垂直线: │ ┃ ║
角落:   ┌ ┐ └ ┘ (细线)
T 形:   ├ ┤ ┬ ┴
交叉:   ┼
```

### 箭头符号
```
单向: → ← ↑ ↓ ▼ ▲
双向: ↔
```

### 特殊符号
```
条件: ◇
列表: •
```

## 生成信息

- 生成时间: 2026-01-26
- 项目版本: 2026.1.25
- 分析范围: 核心代码 + 扩展插件

---

# 系统整体架构

本文档采用统一的 6 层架构模型，与 [09-end-to-end-detailed.md](09-end-to-end-detailed.md) 保持一致。

## 1. 全栈架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          1. ENTRY LAYER (入口层)                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  User Interfaces                         Channel Plugins                 │   │
│  │  ┌──────────────┐  ┌──────────────┐     ┌──────────────┐ ┌───────────┐  │   │
│  │  │   CLI Tool   │  │   TUI        │     │  Telegram    │ │ WhatsApp  │  │   │
│  │  │  (Commander) │  │  (Pi-TUI)    │     │  (Grammy)    │ │ (Baileys) │  │   │
│  │  ├──────────────┤  ├──────────────┤     ├──────────────┤ ├───────────┤  │   │
│  │  │  Control UI  │  │ Mobile Apps  │     │  Discord     │ │  Slack    │  │   │
│  │  │    (Web)     │  │ (iOS/Android)│     │  (Carbon)    │ │  (Bolt)   │  │   │
│  │  └──────────────┘  └──────────────┘     ├──────────────┤ ├───────────┤  │   │
│  │                                         │  Signal      │ │  Matrix   │  │   │
│  │  HTTP Endpoints                         │  iMessage    │ │  LINE     │  │   │
│  │  ┌──────────────┐  ┌──────────────┐     └──────────────┘ └───────────┘  │   │
│  │  │  OpenAI API  │  │   Webhooks   │                                     │   │
│  │  │  /v1/chat/*  │  │   /hooks/*   │                                     │   │
│  │  └──────────────┘  └──────────────┘                                     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          2. GATEWAY LAYER (网关层)                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                    Gateway Server (server.impl.ts)                       │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐  │   │
│  │  │ HTTP Server  │  │  WebSocket   │  │   Channel    │  │    Node     │  │   │
│  │  │   (Hono)     │  │   Server     │  │   Manager    │  │  Registry   │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └─────────────┘  │   │
│  │                                                                          │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│  │  │           RPC Method Registry (40+ request handlers)             │    │   │
│  │  │   agent, chat, config, channels, health, sessions, send, cron   │    │   │
│  │  └─────────────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          3. ROUTING LAYER (路由层)                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐  │   │
│  │  │  Preflight   │─>│    Route     │─>│ Session Key  │─>│  Inbound    │  │   │
│  │  │    Check     │  │  Resolution  │  │  Generation  │  │ Debouncer   │  │   │
│  │  │              │  │              │  │              │  │             │  │   │
│  │  │ • Allowlist  │  │ • Agent bind │  │ • agent:id:  │  │ • Merge msg │  │   │
│  │  │ • Mention    │  │ • Priority   │  │   ch:dm:peer │  │ • 300ms buf │  │   │
│  │  │ • Self-check │  │ • Default    │  │ • Thread sfx │  │ • Ctrl skip │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └─────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          4. AGENTS LAYER (代理层)                                │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐  │   │
│  │  │ Agent Runtime│  │    Tool      │  │   Auth       │  │  Session    │  │   │
│  │  │  (Pi-Agent)  │  │   System     │  │  Profiles    │  │  Manager    │  │   │
│  │  │              │  │              │  │              │  │             │  │   │
│  │  │ • Embedded   │  │ • Policy     │  │ • Rotation   │  │ • JSONL     │  │   │
│  │  │   runner     │  │   pipeline   │  │ • Cooldown   │  │ • WriteLock │  │   │
│  │  │ • Stream     │  │ • Bash exec  │  │ • Fallback   │  │ • Compaction│  │   │
│  │  │   handler    │  │ • Result proc│  │ • Failover   │  │ • Hist limit│  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └─────────────┘  │   │
│  │                                                                          │   │
│  │  ┌──────────────┐  ┌──────────────┐                                     │   │
│  │  │   Plugins    │  │   Subagent   │                                     │   │
│  │  │   Runtime    │  │   Registry   │                                     │   │
│  │  │   (Jiti)     │  │              │                                     │   │
│  │  └──────────────┘  └──────────────┘                                     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      5. INFRASTRUCTURE LAYER (基础设施层)                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  纯工具箱层 - 提供支撑服务，被上层调用，从不调用上层 (Servant Pattern)       │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │  System           Events              Process             Network        │   │
│  │  ┌─────────────┐  ┌─────────────┐     ┌─────────────┐  ┌─────────────┐  │   │
│  │  │gateway-lock │  │agent-events │     │command-queue│  │  bonjour    │  │   │
│  │  │ports        │  │system-events│     │exec         │  │  tailscale  │  │   │
│  │  │env          │  │heartbeat    │     │spawn-utils  │  │  ssh-tunnel │  │   │
│  │  │machine-name │  │             │     │             │  │  fetch      │  │   │
│  │  └─────────────┘  └─────────────┘     └─────────────┘  └─────────────┘  │   │
│  │                                                                          │   │
│  │  Config           Storage             Delivery           Utilities       │   │
│  │  ┌─────────────┐  ┌─────────────┐     ┌─────────────┐  ┌─────────────┐  │   │
│  │  │loadConfig() │  │sessions     │     │outbound/    │  │retry        │  │   │
│  │  │hotReload()  │  │media        │     │deliver      │  │backoff      │  │   │
│  │  │envSubstitute│  │memory       │     │payloads     │  │dedupe       │  │   │
│  │  │jsonSchema   │  │             │     │             │  │archive      │  │   │
│  │  └─────────────┘  └─────────────┘     └─────────────┘  └─────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        6. EXTERNAL SERVICES (外部服务)                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │  Anthropic   │  │   OpenAI     │  │   Google     │  │   GitHub     │        │
│  │   Claude     │  │   GPT        │  │   Gemini     │  │   Copilot    │        │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘        │
│  ┌──────────────┐  ┌──────────────┐                                            │
│  │   Groq       │  │   Deepgram   │                                            │
│  └──────────────┘  └──────────────┘                                            │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 层次角色说明

| 层 | 角色 | 依赖方向 |
|---|---|---|
| Entry Layer | 接收外部请求（UI/Channel/HTTP） | → Gateway |
| Gateway Layer | 协调者，管理连接和分发 | → Routing, Agents |
| Routing Layer | 路由决策，会话键生成 | → Agents |
| Agents Layer | 核心业务逻辑执行 | → Infrastructure, External |
| Infrastructure Layer | 纯工具箱，被动服务 | ← (被上层调用) |
| External Services | LLM 提供商 | ← (被 Agents 调用) |

**依赖方向原则：** 单向自顶向下，Infrastructure Layer 是纯支撑服务层，从不调用上层。

## 2. CLI 命令结构图

```
                              clawdbot (entry.ts)
                                      │
                                      ▼
                            ┌─────────────────┐
                            │  build-program  │
                            │ (commander.js)  │
                            └────────┬────────┘
                                     │
        ┌────────────────┬───────────┼───────────┬────────────────┐
        │                │           │           │                │
        ▼                ▼           ▼           ▼                ▼
   ┌─────────┐     ┌─────────┐  ┌─────────┐  ┌─────────┐   ┌─────────────┐
   │  setup  │     │ onboard │  │configure│  │  agent  │   │   gateway   │
   └─────────┘     └─────────┘  └─────────┘  └────┬────┘   └──────┬──────┘
                                                  │               │
                        ┌─────────────────────────┤               │
                        │                         │               │
                        ▼                         ▼               ▼
                  ┌──────────┐             ┌──────────┐     ┌──────────┐
                  │  agents  │             │  message │     │   run    │
                  │   list   │             │   send   │     │  status  │
                  │   add    │             └──────────┘     │   stop   │
                  │  config  │                              └──────────┘
                  └──────────┘

   ┌─────────┐     ┌─────────┐  ┌─────────┐  ┌─────────┐   ┌─────────────┐
   │channels │     │  doctor │  │  health │  │  status │   │   memory    │
   │  add    │     │         │  │         │  │         │   │   status    │
   │ status  │     │         │  │         │  │         │   │   search    │
   └─────────┘     └─────────┘  └─────────┘  └─────────┘   └─────────────┘
```

## 3. 核心模块依赖关系图

```
                    ┌─────────────────────┐
                    │      entry.ts       │
                    │   (CLI 入口点)      │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │   cli/program.ts    │
                    │   (命令注册器)      │
                    └──────────┬──────────┘
                               │
          ┌────────────────────┼────────────────────┐
          │                    │                    │
          ▼                    ▼                    ▼
   ┌────────────┐       ┌────────────┐       ┌────────────┐
   │  commands/ │       │  gateway/  │       │   agents/  │
   │  (CLI 命令)│       │  (服务器)  │       │  (Agent)   │
   └─────┬──────┘       └─────┬──────┘       └─────┬──────┘
         │                    │                    │
         │              ┌─────┴─────┐              │
         │              │           │              │
         ▼              ▼           ▼              ▼
   ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐
   │  channels/ │ │  plugins/  │ │auto-reply/ │ │   media-   │
   │  (通道)    │ │  (插件)    │ │ (自动回复) │ │understanding│
   └─────┬──────┘ └─────┬──────┘ └─────┬──────┘ └─────┬──────┘
         │              │              │              │
         └──────────────┼──────────────┼──────────────┘
                        │              │
                        ▼              ▼
                 ┌────────────┐  ┌────────────┐
                 │   config/  │  │   infra/   │
                 │  (配置)    │  │  (基础设施)│
                 └────────────┘  └────────────┘
```

## 4. 关键发现

| 组件 | 入口文件 | 职责 |
|------|----------|------|
| CLI 入口 | `src/entry.ts` | 命令行解析、环境初始化 |
| 程序构建 | `src/cli/program.ts` | Commander.js 命令注册 |
| Gateway | `src/gateway/server.impl.ts` | WebSocket/HTTP 核心服务 |
| Agent | `src/agents/pi-embedded-runner/run.ts` | Agent 运行时 |
| 插件 | `src/plugins/runtime/index.ts` | 插件加载和注册 |
| 通道 | `src/channels/plugins/index.ts` | 消息通道管理 |

---

# 消息处理流程

## 1. 消息处理时序图

```
  User          Channel        Gateway         Agent          Provider
    │              │              │              │               │
    │  Message     │              │              │               │
    │─────────────>│              │              │               │
    │              │              │              │               │
    │              │  Inbound     │              │               │
    │              │─────────────>│              │               │
    │              │              │              │               │
    │              │              │  Route to    │               │
    │              │              │  Agent       │               │
    │              │              │─────────────>│               │
    │              │              │              │               │
    │              │              │              │  API Call     │
    │              │              │              │──────────────>│
    │              │              │              │               │
    │              │              │              │  Response     │
    │              │              │              │<──────────────│
    │              │              │              │               │
    │              │              │  Reply       │               │
    │              │              │<─────────────│               │
    │              │              │              │               │
    │              │  Outbound    │              │               │
    │              │<─────────────│              │               │
    │              │              │              │               │
    │  Response    │              │              │               │
    │<─────────────│              │              │               │
    │              │              │              │               │
```

## 2. 详细消息处理流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Message Processing Pipeline                              │
│                                                                                  │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                    Phase 1: Inbound Processing                            │  │
│  │                                                                            │  │
│  │    Channel (Telegram/Discord/WhatsApp/...)                                │  │
│  │         │                                                                  │  │
│  │         ▼                                                                  │  │
│  │    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │  │
│  │    │ Receive Msg │───>│ Validate    │───>│ Check       │                 │  │
│  │    │ (webhook/ws)│    │ Allowlist   │    │ Mention     │                 │  │
│  │    └─────────────┘    └─────────────┘    └─────────────┘                 │  │
│  │                                                │                          │  │
│  │                                 ┌──────────────┴──────────────┐           │  │
│  │                                 ▼                             ▼           │  │
│  │                          ┌───────────┐                 ┌───────────┐      │  │
│  │                          │  Allowed  │                 │  Ignored  │      │  │
│  │                          └─────┬─────┘                 └───────────┘      │  │
│  └────────────────────────────────┼──────────────────────────────────────────┘  │
│                                   │                                             │
│                                   ▼                                             │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                    Phase 2: Media Processing                              │  │
│  │                                                                            │  │
│  │    ◇ Has Attachments?                                                     │  │
│  │    │                                                                       │  │
│  │    ├─ Yes ──> ┌─────────────────────────────────────────────────────┐     │  │
│  │    │          │  Media Understanding Pipeline                        │     │  │
│  │    │          │  • Image → Vision API (Claude/GPT-4V/Gemini)        │     │  │
│  │    │          │  • Audio → Transcription (Deepgram/Groq/OpenAI)     │     │  │
│  │    │          │  • Document → Text extraction                        │     │  │
│  │    │          └─────────────────────────────────────────────────────┘     │  │
│  │    │                                                                       │  │
│  │    └─ No ───> Continue with text only                                     │  │
│  │                                                                            │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                   │                                             │
│                                   ▼                                             │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                    Phase 3: Command Detection                             │  │
│  │                                                                            │  │
│  │    ◇ Is Control Command? (starts with !)                                 │  │
│  │    │                                                                       │  │
│  │    ├─ Yes ──> Route to command handler (!reset, !config, etc.)           │  │
│  │    │                                                                       │  │
│  │    └─ No ───> Continue to Agent                                          │  │
│  │                                                                            │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                   │                                             │
│                                   ▼                                             │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                    Phase 4: Agent Processing                              │  │
│  │                                                                            │  │
│  │    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │  │
│  │    │ Resolve     │───>│ Build       │───>│ Run         │                 │  │
│  │    │ Session     │    │ Context     │    │ Embedded    │                 │  │
│  │    │             │    │             │    │ Pi Agent    │                 │  │
│  │    └─────────────┘    └─────────────┘    └─────────────┘                 │  │
│  │                                                │                          │  │
│  │                                                ▼                          │  │
│  │                                    ┌───────────────────┐                  │  │
│  │                                    │ Stream Response   │                  │  │
│  │                                    │ (with tool calls) │                  │  │
│  │                                    └───────────────────┘                  │  │
│  │                                                                            │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                   │                                             │
│                                   ▼                                             │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                    Phase 5: Reply Dispatch                                │  │
│  │                                                                            │  │
│  │    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │  │
│  │    │ Format      │───>│ Chunk if    │───>│ Send via    │                 │  │
│  │    │ Response    │    │ too long    │    │ Channel     │                 │  │
│  │    └─────────────┘    └─────────────┘    └─────────────┘                 │  │
│  │                                                                            │  │
│  │    Chunking modes:                                                        │  │
│  │    • text_end   → Complete text blocks                                   │  │
│  │    • sentence   → Sentence boundaries                                    │  │
│  │    • paragraph  → Paragraph boundaries                                   │  │
│  │    • none       → All at once                                            │  │
│  │                                                                            │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 3. 通道特定处理

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Channel-Specific Handling                                     │
│                                                                                  │
│  ┌─────────────────────────┐    ┌─────────────────────────┐                    │
│  │       Telegram          │    │        Discord          │                    │
│  │  ┌───────────────────┐  │    │  ┌───────────────────┐  │                    │
│  │  │ • Markdown format │  │    │  │ • Discord markdown│  │                    │
│  │  │ • Inline buttons  │  │    │  │ • Embeds support  │  │                    │
│  │  │ • Reactions       │  │    │  │ • Slash commands  │  │                    │
│  │  │ • Topic support   │  │    │  │ • Thread support  │  │                    │
│  │  └───────────────────┘  │    │  └───────────────────┘  │                    │
│  └─────────────────────────┘    └─────────────────────────┘                    │
│                                                                                  │
│  ┌─────────────────────────┐    ┌─────────────────────────┐                    │
│  │        Slack            │    │       WhatsApp          │                    │
│  │  ┌───────────────────┐  │    │  ┌───────────────────┐  │                    │
│  │  │ • mrkdwn format   │  │    │  │ • Plain text      │  │                    │
│  │  │ • Block Kit       │  │    │  │ • Media support   │  │                    │
│  │  │ • App mentions    │  │    │  │ • Status messages │  │                    │
│  │  │ • Workflows       │  │    │  │ • Group settings  │  │                    │
│  │  └───────────────────┘  │    │  └───────────────────┘  │                    │
│  └─────────────────────────┘    └─────────────────────────┘                    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 4. 数据流总结

```
User Message
     │
     ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Channel    │───>│  Gateway    │───>│   Agent     │───>│  Provider   │
│  Receive    │    │  Route      │    │  Process    │    │  API Call   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  Channel    │<───│  Gateway    │<───│   Agent     │<────────┘
│  Send       │    │  Dispatch   │    │  Format     │
└─────────────┘    └─────────────┘    └─────────────┘
     │
     ▼
User Response
```

---

# 插件系统架构

## 1. 插件系统组件图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Plugin Runtime System                         │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    Plugin Loader (Jiti)                       │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐   │   │
│  │  │ Load Config │──│ Resolve Deps │──│ Initialize Plugins │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘   │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                │                                     │
│         ┌──────────────────────┼──────────────────────┐             │
│         │                      │                      │             │
│         ▼                      ▼                      ▼             │
│  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐       │
│  │  Channel    │       │   Auth      │       │   Memory    │       │
│  │  Plugins    │       │  Plugins    │       │  Plugins    │       │
│  │             │       │             │       │             │       │
│  │ • WhatsApp  │       │ • Anthropic │       │ • LanceDB   │       │
│  │ • Telegram  │       │ • OpenAI    │       │ • Core      │       │
│  │ • Discord   │       │ • Google    │       │             │       │
│  │ • Slack     │       │ • Copilot   │       │             │       │
│  │ • Matrix    │       │ • Qwen      │       │             │       │
│  │ • MS Teams  │       │             │       │             │       │
│  │ • Zalo      │       │             │       │             │       │
│  │ • Nostr     │       │             │       │             │       │
│  └─────────────┘       └─────────────┘       └─────────────┘       │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
                    ┌─────────────────────────┐
                    │      Plugin SDK         │
                    │  (clawdbot/plugin-sdk)  │
                    │                         │
                    │  • Channel Registration │
                    │  • Auth Provider API    │
                    │  • Memory Provider API  │
                    │  • Hooks System         │
                    └─────────────────────────┘
```

## 2. 扩展目录结构 (extensions/)

```
extensions/
│
├─ 消息通道插件 ────────────────────────────────────────────────────────
│  │
│  ├─ telegram/          Telegram Bot 集成 (Grammy)
│  │  ├─ package.json
│  │  └─ src/
│  │     ├─ monitor.ts   消息监听
│  │     ├─ send.ts      消息发送
│  │     └─ probe.ts     健康检查
│  │
│  ├─ discord/           Discord Bot 集成 (Carbon)
│  ├─ slack/             Slack App 集成 (Bolt)
│  ├─ signal/            Signal 私有消息
│  ├─ whatsapp/          WhatsApp Web (Baileys)
│  ├─ imessage/          iMessage (BlueBubbles)
│  ├─ bluebubbles/       BlueBubbles 服务端
│  ├─ line/              LINE 消息平台
│  ├─ matrix/            Matrix 协议
│  ├─ msteams/           Microsoft Teams
│  ├─ googlechat/        Google Chat
│  ├─ zalo/              Zalo 官方 API
│  ├─ zalouser/          Zalo 用户账号
│  ├─ nostr/             Nostr 去中心化协议
│  ├─ tlon/              Urbit Tlon
│  ├─ mattermost/        Mattermost 自托管
│  ├─ nextcloud-talk/    Nextcloud Talk
│  └─ voice-call/        语音通话支持
│
├─ 认证提供者插件 ──────────────────────────────────────────────────────
│  │
│  ├─ google-antigravity-auth/   Google Antigravity OAuth
│  ├─ google-gemini-cli-auth/    Gemini CLI 认证
│  ├─ copilot-proxy/             GitHub Copilot 代理
│  └─ qwen-portal-auth/          通义千问 Portal 认证
│
├─ 内存/存储插件 ───────────────────────────────────────────────────────
│  │
│  ├─ memory-core/       核心内存接口
│  └─ memory-lancedb/    LanceDB 向量存储
│
└─ 功能增强插件 ────────────────────────────────────────────────────────
   │
   ├─ llm-task/          LLM 任务处理
   ├─ lobster/           Lobster 界面美化
   ├─ open-prose/        开放文本处理
   └─ diagnostics-otel/  OpenTelemetry 诊断

共计: 27 个扩展插件
```

## 3. 插件加载流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Plugin Loading Flow                                      │
│                                                                                  │
│  Gateway Start                                                                  │
│       │                                                                         │
│       ▼                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  loadGatewayPlugins() (server-plugins.ts)                                │   │
│  │                                                                          │   │
│  │  1. Scan extension directories                                          │   │
│  │     • Built-in: extensions/                                             │   │
│  │     • User: ~/.clawdbot/plugins/                                        │   │
│  │                                                                          │   │
│  │  2. For each plugin directory:                                          │   │
│  │     ┌───────────────────────────────────────────────────────────────┐   │   │
│  │     │  • Read package.json                                          │   │   │
│  │     │  • Validate clawdbot plugin manifest                          │   │   │
│  │     │  • Check dependencies                                          │   │   │
│  │     │  • Run npm install --omit=dev (if needed)                     │   │   │
│  │     └───────────────────────────────────────────────────────────────┘   │   │
│  │                                                                          │   │
│  │  3. Load plugin via Jiti (TypeScript runtime)                           │   │
│  │     ┌───────────────────────────────────────────────────────────────┐   │   │
│  │     │  const plugin = jiti(pluginPath)                              │   │   │
│  │     │  plugin.register(registry)                                    │   │   │
│  │     └───────────────────────────────────────────────────────────────┘   │   │
│  │                                                                          │   │
│  │  4. Register plugin in PluginRegistry                                   │   │
│  │     ┌───────────────────────────────────────────────────────────────┐   │   │
│  │     │  registry.channels.push(channelPlugin)                        │   │   │
│  │     │  registry.authProviders.push(authPlugin)                      │   │   │
│  │     │  registry.memoryProviders.push(memoryPlugin)                  │   │   │
│  │     └───────────────────────────────────────────────────────────────┘   │   │
│  │                                                                          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│       │                                                                         │
│       ▼                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Plugin Registry (Active)                                                │   │
│  │                                                                          │   │
│  │  channels: [                                                             │   │
│  │    { id: "telegram", plugin: TelegramPlugin, meta: {...} },             │   │
│  │    { id: "discord", plugin: DiscordPlugin, meta: {...} },               │   │
│  │    ...                                                                   │   │
│  │  ]                                                                       │   │
│  │                                                                          │   │
│  │  authProviders: [...]                                                    │   │
│  │  memoryProviders: [...]                                                  │   │
│  │                                                                          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 4. Channel Plugin 接口

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         ChannelPlugin Interface                                  │
│                                                                                  │
│  interface ChannelPlugin {                                                      │
│    // 唯一标识                                                                  │
│    id: ChannelId;                                                               │
│                                                                                  │
│    // 元数据                                                                    │
│    meta: {                                                                       │
│      name: string;           // 显示名称                                        │
│      order?: number;         // 排序权重                                        │
│      icon?: string;          // 图标                                            │
│    };                                                                            │
│                                                                                  │
│    // 核心方法                                                                  │
│    monitor?: (config) => Promise<void>;     // 启动消息监听                    │
│    send?: (params) => Promise<SendResult>;  // 发送消息                        │
│    probe?: () => Promise<ProbeResult>;      // 健康检查                        │
│                                                                                  │
│    // 配置方法                                                                  │
│    configure?: (ctx) => Promise<void>;      // 交互式配置                      │
│    resolveAllowlist?: (cfg) => string[];    // 解析白名单                      │
│                                                                                  │
│    // 目录服务                                                                  │
│    listPeersLive?: () => Promise<Peer[]>;   // 列出联系人                      │
│    listGroupsLive?: () => Promise<Group[]>; // 列出群组                        │
│  }                                                                               │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 5. 插件类型汇总

| 类型 | 数量 | 示例 |
|------|------|------|
| 消息通道 | 17 | telegram, discord, slack, whatsapp |
| 认证提供者 | 4 | copilot-proxy, google-gemini-cli-auth |
| 内存存储 | 2 | memory-core, memory-lancedb |
| 功能增强 | 4 | llm-task, lobster, diagnostics-otel |
| **合计** | **27** | |

---

# Agent 运行时架构

## 1. Agent 运行时总体架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Agent Runtime System                                   │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                      Entry Points (入口层)                               │    │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────┐    │    │
│  │  │  CLI Command   │  │ Gateway Route  │  │    Subagent Spawn      │    │    │
│  │  │  (agent.ts)    │  │(agent-via-gw)  │  │ (sessions_spawn tool)  │    │    │
│  │  └───────┬────────┘  └───────┬────────┘  └───────────┬────────────┘    │    │
│  └──────────┼───────────────────┼───────────────────────┼─────────────────┘    │
│             │                   │                       │                       │
│             └───────────────────┼───────────────────────┘                       │
│                                 ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                   Session Resolution (会话解析层)                        │    │
│  │  ┌────────────────────────────────────────────────────────────────┐    │    │
│  │  │  resolveSession()                                               │    │    │
│  │  │  ├─ Load session store from disk                               │    │    │
│  │  │  ├─ Determine session key (per-sender/channel/explicit)        │    │    │
│  │  │  ├─ Check freshness (reset policy)                             │    │    │
│  │  │  └─ Preserve thinking/verbose if fresh                         │    │    │
│  │  └────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                 │                                               │
│                                 ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                   runEmbeddedPiAgent (核心运行器)                        │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │    │
│  │  │   Resolve   │  │   Ensure    │  │   Validate  │  │   Resolve   │    │    │
│  │  │   Lanes     │──│ Auth Store  │──│   Model     │──│  Workspace  │    │    │
│  │  │ (并发控制)  │  │ (认证存储)  │  │  (模型校验) │  │  (工作区)   │    │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │    │
│  │                                 │                                       │    │
│  │                                 ▼                                       │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │    │
│  │  │              runEmbeddedAttempt (单次尝试执行)                    │  │    │
│  │  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐        │  │    │
│  │  │  │ Create Session│  │ Build System  │  │ Register Tools│        │  │    │
│  │  │  │ (Pi-Agent)    │──│ Prompt        │──│ + Subscribe   │        │  │    │
│  │  │  └───────────────┘  └───────────────┘  └───────────────┘        │  │    │
│  │  └──────────────────────────────────────────────────────────────────┘  │    │
│  │                                 │                                       │    │
│  │                    ┌────────────┴────────────┐                          │    │
│  │                    │                         │                          │    │
│  │                    ▼                         ▼                          │    │
│  │            ┌─────────────┐           ┌─────────────┐                    │    │
│  │            │   Success   │           │   Failover  │                    │    │
│  │            │   Return    │           │   (Retry)   │                    │    │
│  │            └─────────────┘           └─────────────┘                    │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 2. Pi-Agent-Core 集成时序图

```
  Clawdbot            SessionManager           Pi-Agent-Core          Provider
     │                    │                        │                      │
     │  initSession()     │                        │                      │
     │───────────────────>│                        │                      │
     │                    │                        │                      │
     │                    │  Load/Create .jsonl    │                      │
     │                    │  (session file)        │                      │
     │                    │<───────────────────────│                      │
     │                    │                        │                      │
     │  registerTools()   │                        │                      │
     │───────────────────────────────────────────>│                      │
     │                    │                        │                      │
     │  subscribeStreaming()                       │                      │
     │───────────────────────────────────────────>│                      │
     │                    │                        │                      │
     │  runPrompt(message)│                        │                      │
     │───────────────────────────────────────────>│                      │
     │                    │                        │                      │
     │                    │                        │  API Request         │
     │                    │                        │─────────────────────>│
     │                    │                        │                      │
     │                    │                        │  Stream Deltas       │
     │                    │                        │<─────────────────────│
     │                    │                        │                      │
     │  onDelta (text, tool_call, reasoning)       │                      │
     │<────────────────────────────────────────────│                      │
     │                    │                        │                      │
     │  Tool Execution    │                        │                      │
     │  (bash, memory, etc)                        │                      │
     │───────────────────>│                        │                      │
     │                    │                        │                      │
     │  Tool Result       │                        │                      │
     │<───────────────────│                        │                      │
     │                    │                        │                      │
     │  onComplete        │                        │                      │
     │<────────────────────────────────────────────│                      │
     │                    │                        │                      │
     │                    │  Flush session file    │                      │
     │                    │───────────────────────>│                      │
     │                    │                        │                      │
```

## 3. 系统提示 (System Prompt) 结构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    System Prompt Generation (system-prompt.ts)                   │
│                                                                                  │
│  PromptMode: "full" (主 Agent)                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  ┌────────────────────────────────────────────────────────────────┐     │    │
│  │  │ 1. Identity & User Context (身份)                              │     │    │
│  │  │    "你是 [Agent Name], 由 [User] 创建..."                      │     │    │
│  │  └────────────────────────────────────────────────────────────────┘     │    │
│  │  ┌────────────────────────────────────────────────────────────────┐     │    │
│  │  │ 2. Current Time & Timezone (时间)                              │     │    │
│  │  │    "当前时间: 2026-01-26 14:30 PST"                            │     │    │
│  │  └────────────────────────────────────────────────────────────────┘     │    │
│  │  ┌────────────────────────────────────────────────────────────────┐     │    │
│  │  │ 3. Skills (技能)                                               │     │    │
│  │  │    "可用技能: /commit, /review-pr, ..."                        │     │    │
│  │  │    "通过读取 SKILL.md 了解技能详情"                             │     │    │
│  │  └────────────────────────────────────────────────────────────────┘     │    │
│  │  ┌────────────────────────────────────────────────────────────────┐     │    │
│  │  │ 4. Memory Recall (记忆)                                        │     │    │
│  │  │    "回答前先搜索 MEMORY.md 和 memory/*.md"                     │     │    │
│  │  └────────────────────────────────────────────────────────────────┘     │    │
│  │  ┌────────────────────────────────────────────────────────────────┐     │    │
│  │  │ 5. Messaging (消息)                                            │     │    │
│  │  │    "使用 message 工具发送消息到通道"                            │     │    │
│  │  │    "[[reply_to_current]] 标签..."                              │     │    │
│  │  └────────────────────────────────────────────────────────────────┘     │    │
│  │  ┌────────────────────────────────────────────────────────────────┐     │    │
│  │  │ 6. Tooling (工具)                                              │     │    │
│  │  │    "可用工具: read, write, exec, memory_search, ..."          │     │    │
│  │  │    "通道特定提示: Telegram 使用 Markdown, Discord 使用..."     │     │    │
│  │  └────────────────────────────────────────────────────────────────┘     │    │
│  │  ┌────────────────────────────────────────────────────────────────┐     │    │
│  │  │ 7. Workspace & Runtime (运行时)                                │     │    │
│  │  │    "工作目录: /path/to/workspace"                              │     │    │
│  │  │    "Agent ID: abc123"                                          │     │    │
│  │  └────────────────────────────────────────────────────────────────┘     │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  PromptMode: "minimal" (Subagent)                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │    仅包含: Tooling + Workspace + Runtime                                │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  PromptMode: "none"                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │    仅包含: 单行身份描述                                                  │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 4. Subagent 生命周期

```
                              sessions_spawn 调用
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                     Subagent Registry (subagent-registry.ts)                     │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                      SubagentRunRecord (数据结构)                        │    │
│  │  {                                                                       │    │
│  │    runId: "uuid",                                                       │    │
│  │    childSessionKey: "sub-session-123",                                  │    │
│  │    requesterSessionKey: "parent-session",                               │    │
│  │    requesterOrigin: { channel: "telegram", chatId: "..." },            │    │
│  │    task: "执行某任务",                                                   │    │
│  │    cleanup: "delete" | "keep",                                          │    │
│  │    createdAt: timestamp,                                                │    │
│  │    startedAt?: timestamp,                                               │    │
│  │    endedAt?: timestamp,                                                 │    │
│  │    outcome?: { success: true, summary: "..." }                          │    │
│  │  }                                                                       │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Subagent Lifecycle (生命周期)                           │
│                                                                                  │
│     ┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐            │
│     │ Created │─────>│ Started │─────>│  Ended  │─────>│ Cleanup │            │
│     │(注册)   │      │(运行中) │      │(完成)   │      │(清理)   │            │
│     └─────────┘      └─────────┘      └─────────┘      └─────────┘            │
│          │                │                │                │                  │
│          ▼                ▼                ▼                ▼                  │
│     ┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐            │
│     │ Persist │      │ Track   │      │Announce │      │ Archive │            │
│     │ to Disk │      │ Events  │      │ to      │      │ Session │            │
│     │         │      │         │      │ Parent  │      │ Delete  │            │
│     └─────────┘      └─────────┘      └─────────┘      └─────────┘            │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                      Sweeper (定时清理器, 每60秒)                         │    │
│  │  • 检查已归档的 subagent runs                                            │    │
│  │  • 删除过期会话文件                                                       │    │
│  │  • 清理 subagent-runs.json 记录                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 5. 核心文件导航

```
src/agents/
│
├─ 入口与运行时 ─────────────────────────────────────────────────────────────────
│  ├─ pi-embedded-runner/
│  │  ├─ run.ts                    # 主运行器 (runEmbeddedPiAgent)
│  │  ├─ run/attempt.ts            # 单次尝试执行
│  │  ├─ run/params.ts             # 参数定义
│  │  └─ session-manager-init.ts   # Pi-Agent 会话初始化
│  │
│  ├─ pi-embedded-subscribe.ts     # 流式事件订阅 (19 KB)
│  └─ system-prompt.ts             # 系统提示生成 (26 KB)
│
├─ Subagent 系统 ────────────────────────────────────────────────────────────────
│  ├─ subagent-registry.ts         # 注册表 (11 KB)
│  ├─ subagent-announce.ts         # 完成通知流程 (16 KB)
│  └─ subagent-announce-queue.ts   # 队列管理
│
├─ 模型选择 ─────────────────────────────────────────────────────────────────────
│  ├─ model-auth.ts                # 认证解析 (11 KB)
│  ├─ model-selection.ts           # 模型选择 (16 KB)
│  └─ model-fallback.ts            # 失败回退 (10 KB)
│
└─ 基础设施 ─────────────────────────────────────────────────────────────────────
   ├─ agent-scope.ts               # Agent 目录解析 (6 KB)
   ├─ workspace.ts                 # 工作区初始化 (7 KB)
   └─ identity.ts                  # 身份配置
```

---

# 工具系统架构

## 1. 工具系统总览

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Tool System (工具系统)                                │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                      Tool Registry (pi-tools.ts)                         │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                      │                                          │
│         ┌────────────────┬───────────┼───────────┬────────────────┐            │
│         │                │           │           │                │            │
│         ▼                ▼           ▼           ▼                ▼            │
│  ┌─────────────┐  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐  │
│  │ File Ops    │  │ Bash Tools  │ │ Memory Tools│ │ Session Ops │ │Messaging│  │
│  │ (group:fs)  │  │(group:runtime)│(group:memory)│(group:sessions)│(message)│  │
│  └──────┬──────┘  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └────┬────┘  │
│         │                │               │               │              │       │
│         ▼                ▼               ▼               ▼              ▼       │
│  ┌───────────┐    ┌───────────┐   ┌───────────┐   ┌───────────┐  ┌──────────┐  │
│  │ • read    │    │ • exec    │   │ • search  │   │ • spawn   │  │ • send   │  │
│  │ • write   │    │ • process │   │ • get     │   │ • list    │  │ • reply  │  │
│  │ • edit    │    │ • send_key│   │           │   │ • history │  │ • poll   │  │
│  │ • patch   │    │ • abort   │   │           │   │ • send    │  │          │  │
│  └───────────┘    └───────────┘   └───────────┘   └───────────┘  └──────────┘  │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                      Tool Policy System (访问控制)                       │    │
│  │                                                                          │    │
│  │   TOOL_PROFILES:                                                        │    │
│  │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │    │
│  │   │  "minimal"  │  │  "coding"   │  │ "messaging" │  │   "full"    │   │    │
│  │   │ session_    │  │ group:fs    │  │ group:msg   │  │ (无限制)    │   │    │
│  │   │ status only │  │ group:rt    │  │ sessions_*  │  │             │   │    │
│  │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 2. 工具组定义

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Tool Groups (tool-policy.ts)                             │
│                                                                                  │
│  TOOL_GROUPS = {                                                                │
│    "group:memory": [                                                            │
│      "memory_search",     // 语义搜索 MEMORY.md                                │
│      "memory_get"         // 获取记忆片段                                       │
│    ],                                                                            │
│                                                                                  │
│    "group:fs": [                                                                │
│      "read",              // 读取文件                                           │
│      "write",             // 写入文件                                           │
│      "edit",              // 编辑文件                                           │
│      "apply_patch"        // 应用补丁                                           │
│    ],                                                                            │
│                                                                                  │
│    "group:runtime": [                                                           │
│      "exec",              // 执行 shell 命令                                    │
│      "process"            // 管理长时间运行进程                                 │
│    ],                                                                            │
│                                                                                  │
│    "group:sessions": [                                                          │
│      "sessions_list",     // 列出会话                                           │
│      "sessions_history",  // 查看历史                                           │
│      "sessions_send",     // 发送到会话                                         │
│      "sessions_spawn",    // 创建子 agent                                       │
│      "session_status"     // 当前会话状态                                       │
│    ],                                                                            │
│                                                                                  │
│    "group:messaging": [                                                         │
│      "message"            // 发送消息到通道                                     │
│    ],                                                                            │
│                                                                                  │
│    "group:web": [                                                               │
│      "web_search",        // 网络搜索                                           │
│      "web_fetch"          // 获取网页内容                                       │
│    ],                                                                            │
│                                                                                  │
│    "group:browser": [                                                           │
│      "browser_*"          // 浏览器自动化                                       │
│    ]                                                                             │
│  }                                                                               │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 3. Bash 工具执行流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       Bash Tool Execution Pipeline                               │
│                                                                                  │
│  Tool Call: exec { command: "ls -la", workdir: "/project" }                     │
│                                      │                                          │
│                                      ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                    Phase 1: Security Evaluation                           │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │  requiresExecApproval(command, security, safeBins)                  │  │  │
│  │  │                                                                      │  │  │
│  │  │    ┌─────────────┐     ┌─────────────┐     ┌─────────────┐         │  │  │
│  │  │    │ evaluateShell│────>│ Check Safe  │────>│ Match Allow │         │  │  │
│  │  │    │ Allowlist    │     │ Binaries    │     │ Patterns    │         │  │  │
│  │  │    └─────────────┘     └─────────────┘     └─────────────┘         │  │  │
│  │  │                                 │                                    │  │  │
│  │  │                    ┌────────────┴────────────┐                      │  │  │
│  │  │                    ▼                         ▼                      │  │  │
│  │  │              ┌─────────┐               ┌─────────┐                  │  │  │
│  │  │              │ Allowed │               │ Requires│                  │  │  │
│  │  │              │ (skip)  │               │ Approval│                  │  │  │
│  │  │              └────┬────┘               └────┬────┘                  │  │  │
│  │  └───────────────────┼────────────────────────┼────────────────────────┘  │  │
│  └──────────────────────┼────────────────────────┼───────────────────────────┘  │
│                         │                        │                              │
│                         │                        ▼                              │
│                         │       ┌────────────────────────────────┐             │
│                         │       │  Approval Request Flow         │             │
│                         │       │  ┌──────────────────────────┐  │             │
│                         │       │  │ Gateway UI Notification  │  │             │
│                         │       │  │ • Show command details   │  │             │
│                         │       │  │ • Wait for user response │  │             │
│                         │       │  │ • Timeout: 120s default  │  │             │
│                         │       │  └──────────────────────────┘  │             │
│                         │       │              │                  │             │
│                         │       │     ┌────────┴────────┐        │             │
│                         │       │     ▼                 ▼        │             │
│                         │       │ ┌───────┐       ┌───────┐      │             │
│                         │       │ │Approve│       │ Deny  │      │             │
│                         │       │ └───┬───┘       └───┬───┘      │             │
│                         │       └─────┼───────────────┼──────────┘             │
│                         │             │               │                        │
│                         └─────────────┤               │                        │
│                                       │               ▼                        │
│                                       │        ┌─────────────┐                 │
│                                       │        │Return Error │                 │
│                                       │        │"Denied"     │                 │
│                                       │        └─────────────┘                 │
│                                       ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                    Phase 2: Execution Environment                         │  │
│  │                                                                            │  │
│  │    ◇ Sandbox Enabled?                                                     │  │
│  │    │                                                                       │  │
│  │    ├─ Yes ──> ┌─────────────────────────────────────────┐                 │  │
│  │    │          │ Docker Sandbox Execution                 │                 │  │
│  │    │          │ • buildDockerExecArgs()                  │                 │  │
│  │    │          │ • Map volumes, env, network              │                 │  │
│  │    │          │ • Run in isolated container              │                 │  │
│  │    │          └─────────────────────────────────────────┘                 │  │
│  │    │                                                                       │  │
│  │    └─ No ───> ┌─────────────────────────────────────────┐                 │  │
│  │               │ PTY Spawn (Local Execution)              │                 │  │
│  │               │ • getShellPathFromLoginShell()           │                 │  │
│  │               │ • spawnWithFallback(shell, ["-c", cmd])  │                 │  │
│  │               │ • Terminal: cols=120, rows=40            │                 │  │
│  │               └─────────────────────────────────────────┘                 │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                       │                                        │
│                                       ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                    Phase 3: Process Management                            │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │  ProcessSession (bash-process-registry.ts)                          │  │  │
│  │  │  {                                                                   │  │  │
│  │  │    id: "session-abc",                                                │  │  │
│  │  │    slug: "ls-la-proj",                                               │  │  │
│  │  │    state: "running" | "exited" | "backgrounded",                     │  │  │
│  │  │    output: "total 24\ndrwxr-xr-x...",                                │  │  │
│  │  │    pid: 12345,                                                       │  │  │
│  │  │    startedAt: timestamp,                                             │  │  │
│  │  │    exitCode?: 0                                                      │  │  │
│  │  │  }                                                                   │  │  │
│  │  └─────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                            │  │
│  │  Output Handling:                                                         │  │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                   │  │
│  │  │ onData()    │───>│ appendOutput│───>│ Truncate if │                   │  │
│  │  │ (stream)    │    │ to buffer   │    │ > 200KB     │                   │  │
│  │  └─────────────┘    └─────────────┘    └─────────────┘                   │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                       │                                        │
│                                       ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                    Phase 4: Result Handling                               │  │
│  │                                                                            │  │
│  │    ◇ Timeout / Background?                                                │  │
│  │    │                                                                       │  │
│  │    ├─ Timeout ──> Return partial output + "timed out" status              │  │
│  │    │                                                                       │  │
│  │    ├─ Background ──> markBackgrounded(), return session ID               │  │
│  │    │                 (process continues, notify on exit)                   │  │
│  │    │                                                                       │  │
│  │    └─ Complete ──> Return { exitCode, output, durationMs }                │  │
│  │                                                                            │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 4. Memory 工具架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Memory Tool System                                       │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    memory_search Tool                                    │    │
│  │                                                                          │    │
│  │  Input: { query: "user preferences", limit: 5 }                         │    │
│  │                                                                          │    │
│  │  Process:                                                                │    │
│  │  1. Load MEMORY.md + memory/*.md files                                  │    │
│  │  2. Generate embeddings (OpenAI/Gemini/Local)                           │    │
│  │  3. Vector similarity search                                             │    │
│  │  4. Hybrid: combine with BM25 text search                               │    │
│  │  5. Return top N snippets with path + line numbers                      │    │
│  │                                                                          │    │
│  │  Output: [                                                               │    │
│  │    { path: "MEMORY.md", line: 42, content: "User prefers..." },         │    │
│  │    { path: "memory/prefs.md", line: 10, content: "..." }                │    │
│  │  ]                                                                       │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    memory_get Tool                                       │    │
│  │                                                                          │    │
│  │  Input: { path: "MEMORY.md", startLine: 40, endLine: 50 }               │    │
│  │                                                                          │    │
│  │  Process:                                                                │    │
│  │  1. Validate file exists and is in allowed paths                        │    │
│  │  2. Read specified line range                                            │    │
│  │  3. Apply line limit to keep context small                              │    │
│  │                                                                          │    │
│  │  Output: { content: "Lines 40-50 content here..." }                     │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 5. 工具文件导航

```
src/agents/
│
├─ 工具注册 ─────────────────────────────────────────────────────────────────────
│  ├─ pi-tools.ts                  # 工具注册中心 (1200+ LOC)
│  ├─ pi-tools.policy.ts           # 策略评估
│  └─ tool-policy.ts               # 策略组和配置 (400+ LOC)
│
├─ Bash 执行 ────────────────────────────────────────────────────────────────────
│  ├─ bash-tools.exec.ts           # Bash 执行引擎 (51 KB)
│  ├─ bash-tools.process.ts        # 进程管理 (21 KB)
│  ├─ bash-tools.shared.ts         # 共享工具函数
│  └─ bash-process-registry.ts     # 进程注册表 (7 KB)
│
├─ Memory 工具 ──────────────────────────────────────────────────────────────────
│  └─ tools/
│     ├─ memory-tool.ts            # memory_search / memory_get
│     └─ common.ts                 # 工具辅助函数
│
└─ 其他工具 ─────────────────────────────────────────────────────────────────────
   └─ tools/
      ├─ gateway.ts                # gateway_* 工具
      ├─ nodes.ts                  # nodes_* 工具
      ├─ nodes-utils.ts            # 节点工具辅助
      └─ whatsapp-actions.ts       # WhatsApp 特定操作
```

---

# 流式事件处理

## 1. 流式处理架构总览

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                     Streaming Event Handler (pi-embedded-subscribe.ts)           │
│                                                                                  │
│  Provider API Response (Streaming)                                              │
│          │                                                                      │
│          ▼                                                                      │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                    Delta Event Stream                                      │  │
│  │  { type: "content_block_delta", delta: { text: "Hello" } }                │  │
│  │  { type: "content_block_delta", delta: { text: " world" } }               │  │
│  │  { type: "tool_use", name: "exec", input: {...} }                         │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│          │                                                                      │
│          ▼                                                                      │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                    State Machine (EmbeddedPiSubscribeState)               │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │  {                                                                   │  │  │
│  │  │    assistantTexts: ["Hello world"],    // 累积的文本块              │  │  │
│  │  │    toolMetas: [{name, id, status}],    // 工具调用元数据            │  │  │
│  │  │    deltaBuffer: "",                     // 当前 delta 缓冲          │  │  │
│  │  │    blockBuffer: "",                     // 当前块缓冲               │  │  │
│  │  │    blockState: {                                                     │  │  │
│  │  │      thinking: false,                   // <think> 标签状态         │  │  │
│  │  │      final: false,                      // <final> 标签状态         │  │  │
│  │  │      inlineCode: {...}                  // 代码块追踪               │  │  │
│  │  │    },                                                                │  │  │
│  │  │    messagingToolSentTexts: [],          // 去重追踪                 │  │  │
│  │  │    ...                                                               │  │  │
│  │  │  }                                                                   │  │  │
│  │  └─────────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 2. Delta 处理流水线

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Delta Processing Pipeline                                     │
│                                                                                  │
│  Provider Stream                                                                │
│       │                                                                         │
│       ▼                                                                         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                         │
│  │ Accumulate  │───>│ Scan Tags   │───>│ Emit Chunks │                         │
│  │ Delta Text  │    │ <think>     │    │ (blocks)    │                         │
│  │             │    │ <final>     │    │             │                         │
│  └─────────────┘    └─────────────┘    └─────────────┘                         │
│       │                  │                  │                                   │
│       ▼                  ▼                  ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                    Reasoning Detection                                   │   │
│  │                                                                          │   │
│  │    Text: "Let me think... <think>analyzing the problem</think>"         │   │
│  │                                                                          │   │
│  │    ◇ reasoningMode?                                                     │   │
│  │    │                                                                     │   │
│  │    ├─ "off"    ──> Strip <think> tags, show only final text            │   │
│  │    ├─ "on"     ──> Include reasoning in final response                  │   │
│  │    └─ "stream" ──> Stream reasoning to onReasoningStream callback       │   │
│  │                                                                          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 3. 块级分块策略

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Block-Level Chunking                                          │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  EmbeddedBlockChunker                                                    │    │
│  │                                                                          │    │
│  │  Text blocks are emitted based on blockReplyBreak mode:                 │    │
│  │                                                                          │    │
│  │    ┌─────────────┐                                                      │    │
│  │    │ "text_end"  │ → Emit when text block completes                     │    │
│  │    │             │   (default, waits for full response)                 │    │
│  │    └─────────────┘                                                      │    │
│  │                                                                          │    │
│  │    ┌─────────────┐                                                      │    │
│  │    │ "sentence"  │ → Emit at sentence boundaries (. ! ?)                │    │
│  │    │             │   (good for streaming to chat)                       │    │
│  │    └─────────────┘                                                      │    │
│  │                                                                          │    │
│  │    ┌─────────────┐                                                      │    │
│  │    │ "paragraph" │ → Emit at paragraph boundaries (\n\n)                │    │
│  │    │             │   (balance between speed and coherence)              │    │
│  │    └─────────────┘                                                      │    │
│  │                                                                          │    │
│  │    ┌─────────────┐                                                      │    │
│  │    │ "none"      │ → Accumulate all, emit at end                        │    │
│  │    │             │   (best for non-streaming use cases)                 │    │
│  │    └─────────────┘                                                      │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 4. 工具调用追踪

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Tool Call Handling                                            │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Tool Meta Tracking (toolMetaById Map)                                   │    │
│  │                                                                          │    │
│  │    Tool ID          State                                               │    │
│  │    ─────────────────────────────────────────────                        │    │
│  │    "tool-id-1"  →  { name: "exec", status: "pending", startedAt }       │    │
│  │    "tool-id-2"  →  { name: "read", status: "running", ... }             │    │
│  │    "tool-id-3"  →  { name: "message", status: "done", result }          │    │
│  │                                                                          │    │
│  │  Status transitions:                                                    │    │
│  │  pending → running → done/error                                         │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Messaging Tool Deduplication                                            │    │
│  │                                                                          │    │
│  │  Problem: LLM may send duplicate "message" tool calls                   │    │
│  │                                                                          │    │
│  │  Solution:                                                               │    │
│  │  ┌────────────────────────────────────────────────────────────────┐     │    │
│  │  │ 1. Normalize text (whitespace, punctuation)                    │     │    │
│  │  │    "Hello,  world!" → "hello world"                           │     │    │
│  │  │                                                                 │     │    │
│  │  │ 2. Track sent texts in messagingToolSentTextsNormalized        │     │    │
│  │  │    ["hello world", "how are you"]                             │     │    │
│  │  │                                                                 │     │    │
│  │  │ 3. Skip if normalized text already sent to same target         │     │    │
│  │  │    isMessagingToolDuplicateNormalized() → true/false          │     │    │
│  │  └────────────────────────────────────────────────────────────────┘     │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 5. 回调事件发射

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Callback Emission                                             │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Callback                    Purpose                                     │    │
│  │  ───────────────────────────────────────────────────────────────────    │    │
│  │                                                                          │    │
│  │  onPartialReply(text)     → 部分回复 (流式输出到 UI)                    │    │
│  │                             Called on each delta chunk                   │    │
│  │                                                                          │    │
│  │  onBlockReply(block)      → 块级回复 (完整段落/句子)                    │    │
│  │                             Called based on blockReplyBreak mode         │    │
│  │                                                                          │    │
│  │  onReasoningStream(text)  → 推理流 (thinking 内容)                      │    │
│  │                             Only when reasoningMode="stream"             │    │
│  │                                                                          │    │
│  │  onToolStart(meta)        → 工具开始执行                                │    │
│  │                             { id, name, input }                          │    │
│  │                                                                          │    │
│  │  onToolEnd(meta, result)  → 工具执行完成                                │    │
│  │                             { id, name, result, error? }                 │    │
│  │                                                                          │    │
│  │  onComplete(summary)      → 完整响应完成                                │    │
│  │                             { assistantTexts, toolMetas, ... }           │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 6. 内联代码追踪

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Inline Code State Tracking                                    │
│                                                                                  │
│  Problem: Code spans (`code`) and code blocks (```) can span multiple deltas   │
│                                                                                  │
│  Solution: Track state across chunks                                            │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  InlineCodeState {                                                       │    │
│  │    inCodeSpan: boolean,       // Currently inside `code`                │    │
│  │    inCodeBlock: boolean,      // Currently inside ```                   │    │
│  │    codeBlockLang?: string,    // Language of current code block         │    │
│  │    backtickCount: number      // Track ` or ``` boundaries              │    │
│  │  }                                                                       │    │
│  │                                                                          │    │
│  │  Example processing:                                                     │    │
│  │                                                                          │    │
│  │  Delta 1: "Here is some `cod"     → inCodeSpan = true                   │    │
│  │  Delta 2: "e` in the text"        → inCodeSpan = false                  │    │
│  │  Delta 3: "\n```python\ndef"      → inCodeBlock = true, lang = "python" │    │
│  │  Delta 4: " hello():\n  pass\n"   → still in code block                 │    │
│  │  Delta 5: "```\nDone!"            → inCodeBlock = false                 │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 7. 关键文件

| 文件 | 大小 | 职责 |
|------|------|------|
| `pi-embedded-subscribe.ts` | 19 KB | 主流式事件处理器 |
| `pi-embedded-subscribe.handlers.ts` | - | 事件处理函数 |
| `pi-embedded-subscribe.types.ts` | - | 类型定义 |
| `pi-embedded-block-chunker.ts` | - | 块级分块逻辑 |
| `pi-embedded-helpers.ts` | - | 辅助函数 (去重、归一化) |

---

# 认证轮换逻辑

## 1. 认证系统架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                     Auth Profile Rotation System                                 │
│                                                                                  │
│  API Request                                                                    │
│       │                                                                         │
│       ▼                                                                         │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │              resolveAuthProfileOrder() - 配置解析                         │  │
│  │                                                                            │  │
│  │    Inputs:                                                                │  │
│  │    • store: AuthProfileStore (持久化存储)                                 │  │
│  │    • cfg: ClawdbotConfig (配置文件)                                       │  │
│  │    • provider: "anthropic" | "openai" | "google" | ...                   │  │
│  │                                                                            │  │
│  │    Resolution Order:                                                      │  │
│  │    1. store.order[provider]         → 存储的显式顺序                     │  │
│  │    2. cfg.auth.order[provider]      → 配置的显式顺序                     │  │
│  │    3. cfg.auth.profiles (filtered)  → 配置中的 profile 列表             │  │
│  │    4. listProfilesForProvider()     → 存储中匹配 provider 的所有 profile │  │
│  │                                                                            │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 2. 认证数据结构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Auth Profile Store Structure                              │
│                                                                                  │
│  File: ~/.clawdbot/agents/<agentId>/auth-profiles.json                          │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  AuthProfileStore {                                                      │    │
│  │    version: number,                                                      │    │
│  │                                                                          │    │
│  │    profiles: {                                                           │    │
│  │      "anthropic-main": {                                                │    │
│  │        type: "api_key",                                                 │    │
│  │        provider: "anthropic",                                           │    │
│  │        key: "sk-ant-..."                                                │    │
│  │      },                                                                  │    │
│  │      "openai-work": {                                                   │    │
│  │        type: "api_key",                                                 │    │
│  │        provider: "openai",                                              │    │
│  │        key: "sk-..."                                                    │    │
│  │      },                                                                  │    │
│  │      "claude-cli": {                                                    │    │
│  │        type: "oauth",                                                   │    │
│  │        provider: "anthropic",                                           │    │
│  │        refresh: "refresh_token_...",                                    │    │
│  │        access: "access_token_...",                                      │    │
│  │        expires: 1706...                                                 │    │
│  │      }                                                                   │    │
│  │    },                                                                    │    │
│  │                                                                          │    │
│  │    order: {                                                              │    │
│  │      "anthropic": ["anthropic-main", "claude-cli"]                      │    │
│  │    },                                                                    │    │
│  │                                                                          │    │
│  │    lastGood: {                                                           │    │
│  │      "anthropic": "anthropic-main"                                      │    │
│  │    },                                                                    │    │
│  │                                                                          │    │
│  │    usageStats: {                                                         │    │
│  │      "anthropic-main": {                                                │    │
│  │        lastUsed: 1706...,                                               │    │
│  │        errorCount: 0,                                                   │    │
│  │        cooldownUntil: undefined,                                        │    │
│  │        disabledUntil: undefined                                         │    │
│  │      }                                                                   │    │
│  │    }                                                                     │    │
│  │  }                                                                       │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  Credential Types:                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                 │
│  │    api_key      │  │     token       │  │     oauth       │                 │
│  │  • key: string  │  │ • token: string │  │ • refresh: str  │                 │
│  │  • provider     │  │ • expires?: num │  │ • access: str   │                 │
│  │                 │  │ • provider      │  │ • expires?: num │                 │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                 │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 3. Profile 筛选和验证

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│              Profile Filtering & Validation                                      │
│                                                                                  │
│    For each profile in baseOrder:                                               │
│                                                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                                                                          │  │
│    │  ◇ Credential exists in store?                                          │  │
│    │  │                                                                       │  │
│    │  └─ No ──> Skip profile                                                 │  │
│    │                                                                          │  │
│    │  ◇ Provider matches requested provider?                                 │  │
│    │  │                                                                       │  │
│    │  └─ No ──> Skip profile                                                 │  │
│    │                                                                          │  │
│    │  ◇ Credential valid?                                                    │  │
│    │  │                                                                       │  │
│    │  │  api_key:                                                            │  │
│    │  │    └─ key?.trim() truthy?                                           │  │
│    │  │                                                                       │  │
│    │  │  token:                                                              │  │
│    │  │    └─ token truthy AND (no expires OR now < expires)?               │  │
│    │  │                                                                       │  │
│    │  │  oauth:                                                              │  │
│    │  │    └─ access OR refresh truthy?                                     │  │
│    │  │                                                                       │  │
│    │  └─ Invalid ──> Skip profile                                            │  │
│    │                                                                          │  │
│    │  ✓ Valid ──> Add to filtered list                                       │  │
│    │                                                                          │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 4. Cooldown 排序

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│              Cooldown Sorting                                                    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Separate profiles into two buckets:                                     │    │
│  │                                                                          │    │
│  │  available[]  ← Profiles NOT in cooldown                                │    │
│  │  inCooldown[] ← Profiles in cooldown (sorted by cooldownUntil)          │    │
│  │                                                                          │    │
│  │  Example:                                                                │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │    │
│  │  │  Input profiles: [A, B, C, D]                                   │    │    │
│  │  │                                                                  │    │    │
│  │  │  A: cooldownUntil = undefined  → available                      │    │    │
│  │  │  B: cooldownUntil = 1706000000 → inCooldown (expires first)     │    │    │
│  │  │  C: cooldownUntil = undefined  → available                      │    │    │
│  │  │  D: cooldownUntil = 1706100000 → inCooldown (expires later)     │    │    │
│  │  │                                                                  │    │    │
│  │  │  Final order: [A, C, B, D]                                      │    │    │
│  │  └─────────────────────────────────────────────────────────────────┘    │    │
│  │                                                                          │    │
│  │  This ensures:                                                           │    │
│  │  • Available profiles tried first                                       │    │
│  │  • Cooldown profiles used as fallback (earliest expiry first)           │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 5. 成功和失败处理

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│              Profile Usage Lifecycle                                             │
│                                                                                  │
│    ┌───────────────────────────────────────────────────────────────────────┐    │
│    │                    Request Flow                                        │    │
│    │                                                                        │    │
│    │     Select Profile[0]                                                 │    │
│    │           │                                                            │    │
│    │           ▼                                                            │    │
│    │     Make API Request                                                  │    │
│    │           │                                                            │    │
│    │     ┌─────┴─────┐                                                     │    │
│    │     ▼           ▼                                                     │    │
│    │  Success      Error                                                   │    │
│    │     │           │                                                      │    │
│    │     ▼           ▼                                                     │    │
│    │  markAuth    markAuth                                                 │    │
│    │  ProfileUsed ProfileFailure                                           │    │
│    │                                                                        │    │
│    └───────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │              markAuthProfileUsed() - 成功时调用                          │    │
│  │                                                                          │    │
│  │    Updates:                                                              │    │
│  │    • lastUsed: Date.now()                                               │    │
│  │    • errorCount: 0                 ← 重置错误计数                       │    │
│  │    • cooldownUntil: undefined      ← 清除冷却                           │    │
│  │    • disabledUntil: undefined      ← 清除禁用                           │    │
│  │    • disabledReason: undefined                                          │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │              markAuthProfileFailure() - 失败时调用                       │    │
│  │                                                                          │    │
│  │    Failure Reasons:                                                      │    │
│  │    • "auth"       → 认证失败 (401, invalid key)                         │    │
│  │    • "rate_limit" → 速率限制 (429)                                      │    │
│  │    • "billing"    → 账单问题 (402, quota exceeded)                      │    │
│  │    • "timeout"    → 请求超时                                             │    │
│  │    • "unknown"    → 其他错误                                             │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 6. Cooldown 计算

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│              Cooldown Calculation                                                │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  calculateAuthProfileCooldownMs(errorCount)                              │    │
│  │                                                                          │    │
│  │  Formula: min(1 hour, 5 minutes × 5^(errorCount-1))                     │    │
│  │                                                                          │    │
│  │  Examples:                                                               │    │
│  │  ┌───────────────────────────────────────────────────────────────┐      │    │
│  │  │  errorCount │  Calculation           │  Result                │      │    │
│  │  │  ───────────┼────────────────────────┼─────────────────────── │      │    │
│  │  │      1      │  5min × 5^0 = 5min     │  5 minutes             │      │    │
│  │  │      2      │  5min × 5^1 = 25min    │  25 minutes            │      │    │
│  │  │      3      │  5min × 5^2 = 125min   │  60 minutes (capped)   │      │    │
│  │  │      4+     │  5min × 5^3+ = ...     │  60 minutes (max)      │      │    │
│  │  └───────────────────────────────────────────────────────────────┘      │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Billing-specific:                                                       │    │
│  │                                                                          │    │
│  │  • billingBackoffMs: 30 minutes initial                                 │    │
│  │  • billingMaxMs: 24 hours max                                           │    │
│  │  • Exponential backoff per consecutive billing failure                  │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 7. Failover 流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│              Failover Flow (model-fallback.ts)                                   │
│                                                                                  │
│    Profile[0] fails                                                             │
│         │                                                                        │
│         ▼                                                                        │
│    markAuthProfileFailure()                                                     │
│         │                                                                        │
│         ▼                                                                        │
│    ◇ More profiles available?                                                   │
│    │                                                                             │
│    ├─ Yes ──> Re-resolve order                                                  │
│    │          │                                                                  │
│    │          ▼                                                                  │
│    │          Failed profile now in cooldown, moved to end                      │
│    │          │                                                                  │
│    │          ▼                                                                  │
│    │          Try Profile[1] (now Profile[0])                                   │
│    │          │                                                                  │
│    │          ▼                                                                  │
│    │          ◇ Success?                                                        │
│    │          │                                                                  │
│    │          ├─ Yes ──> Return response                                        │
│    │          │                                                                  │
│    │          └─ No ───> Repeat failover                                        │
│    │                                                                             │
│    └─ No ───> Return error to user                                              │
│               "All auth profiles exhausted"                                      │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 8. 外部 CLI 同步

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│              External CLI Sync (external-cli-sync.ts)                            │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  syncExternalCliCredentials()                                            │    │
│  │                                                                          │    │
│  │  Purpose: Mirror Claude CLI OAuth credentials into Clawdbot auth store  │    │
│  │                                                                          │    │
│  │  Flow:                                                                   │    │
│  │  ┌─────────────┐        ┌─────────────┐        ┌─────────────┐          │    │
│  │  │ Claude CLI  │───────>│ Sync Logic  │───────>│ Clawdbot    │          │    │
│  │  │ OAuth Token │        │             │        │ Auth Store  │          │    │
│  │  │ (~/.claude) │        │ • Compare   │        │ (profiles)  │          │    │
│  │  └─────────────┘        │   freshness │        └─────────────┘          │    │
│  │                         │ • Skip if   │                                  │    │
│  │                         │   API key   │                                  │    │
│  │                         │   exists    │                                  │    │
│  │                         └─────────────┘                                  │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 9. 关键文件

```
src/agents/auth-profiles/
├─ types.ts                  # 数据结构定义
├─ store.ts                  # 存储层 (load/save/lock)
├─ profiles.ts               # Profile 列表操作
├─ order.ts                  # 配置轮换逻辑
├─ usage.ts                  # 使用统计 (cooldown/failure)
├─ oauth.ts                  # OAuth 刷新
└─ external-cli-sync.ts      # 外部 CLI 同步
```

---

# 会话状态管理

## 1. 会话存储架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Session Storage Architecture                             │
│                                                                                  │
│  ~/.clawdbot/agents/<agentId>/sessions/                                         │
│       │                                                                         │
│       ├── <session-key-1>.jsonl     # 会话日志 (JSONL 格式)                    │
│       ├── <session-key-1>.jsonl.lock # 写锁文件                                 │
│       ├── <session-key-2>.jsonl                                                 │
│       └── ...                                                                   │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    Session File Structure (JSONL)                        │    │
│  │                                                                          │    │
│  │  Line 1: { "type": "session", "id": "uuid", "cwd": "/path" }            │    │
│  │  Line 2: { "type": "message", "message": { "role": "user", ... } }      │    │
│  │  Line 3: { "type": "message", "message": { "role": "assistant", ... } } │    │
│  │  Line 4: { "type": "message", "message": { "role": "toolResult", ... } }│    │
│  │  ...                                                                     │    │
│  │  Line N: { "type": "compaction", "summary": "...", "keepFrom": "id" }   │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  Session Key 格式:                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  agent:<agentId>:<channel>:<type>:<userId>                              │    │
│  │                                                                          │    │
│  │  示例:                                                                   │    │
│  │  • agent:default:telegram:dm:123456789                                  │    │
│  │  • agent:default:discord:group:987654321                                │    │
│  │  • agent:helper:telegram:dm:123456789:thread:42                         │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 2. 会话写锁机制

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Session Write Lock (session-write-lock.ts)              │
│                                                                                  │
│  目的: 防止多个进程同时写入同一会话文件                                         │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                      Lock File Structure                                 │    │
│  │                                                                          │    │
│  │  <session>.jsonl.lock:                                                   │    │
│  │  {                                                                       │    │
│  │    "pid": 12345,                    // 持锁进程 ID                       │    │
│  │    "createdAt": "2026-01-26T..."    // 创建时间                          │    │
│  │  }                                                                       │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                      Lock Acquisition Flow                               │    │
│  │                                                                          │    │
│  │  acquireSessionWriteLock(sessionFile)                                    │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  ┌─────────────┐     已持有?     ┌─────────────┐                        │    │
│  │  │ Check       │───── Yes ──────>│ Increment   │                        │    │
│  │  │ HELD_LOCKS  │                 │ count       │                        │    │
│  │  │ Map         │                 │ return lock │                        │    │
│  │  └──────┬──────┘                 └─────────────┘                        │    │
│  │         │ No                                                             │    │
│  │         ▼                                                                │    │
│  │  ┌─────────────┐                                                        │    │
│  │  │ Try create  │──── EEXIST ──>  检查锁文件                             │    │
│  │  │ lock file   │                     │                                   │    │
│  │  │ (exclusive) │                     ▼                                   │    │
│  │  └──────┬──────┘              ┌─────────────┐                           │    │
│  │         │ Success             │ Stale/Dead? │                           │    │
│  │         ▼                     │ (>30min or  │                           │    │
│  │  ┌─────────────┐              │ pid dead)   │                           │    │
│  │  │ Write PID   │              └──────┬──────┘                           │    │
│  │  │ Store in    │                     │                                   │    │
│  │  │ HELD_LOCKS  │              Yes ───┼──> 删除锁, 重试                  │    │
│  │  │ Return lock │              No  ───┼──> 等待重试 (50-1000ms)          │    │
│  │  └─────────────┘                     │                                   │    │
│  │                              Timeout (10s) ──> 抛出错误                 │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                      Lock Release Flow                                   │    │
│  │                                                                          │    │
│  │  lock.release()                                                          │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  ┌─────────────┐                                                        │    │
│  │  │ Decrement   │                                                        │    │
│  │  │ count       │                                                        │    │
│  │  └──────┬──────┘                                                        │    │
│  │         │                                                                │    │
│  │         ▼                                                                │    │
│  │  ◇ count == 0?                                                          │    │
│  │  │                                                                       │    │
│  │  ├─ No  ──> 保持锁 (其他调用还在使用)                                   │    │
│  │  │                                                                       │    │
│  │  └─ Yes ──> 删除 HELD_LOCKS 条目                                        │    │
│  │             关闭文件句柄                                                 │    │
│  │             删除锁文件                                                   │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 3. 会话初始化流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Session Manager Initialization (session-manager-init.ts)     │
│                                                                                  │
│  问题背景:                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Pi-Agent SessionManager 的持久化特性:                                   │    │
│  │                                                                          │    │
│  │  • 文件存在但无 assistant 消息 → flushed=true, 不持久化首条 user 消息  │    │
│  │  • 文件不存在 → 内存构建新会话, 首条 assistant 时一起持久化 (正常)     │    │
│  │                                                                          │    │
│  │  解决方案: prepareSessionManagerForRun() 规范化文件状态                 │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    Preparation Flow                                      │    │
│  │                                                                          │    │
│  │  prepareSessionManagerForRun()                                           │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │    │
│  │  │  解析 SessionManager 内部状态:                                   │    │    │
│  │  │  • fileEntries: 文件条目数组                                     │    │    │
│  │  │  • flushed: 是否已持久化                                         │    │    │
│  │  │  • byId: ID 映射                                                 │    │    │
│  │  └─────────────────────────────────────────────────────────────────┘    │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  ◇ 文件不存在 && 有 header?                                             │    │
│  │  │                                                                       │    │
│  │  ├─ Yes ──> 更新 header.id 和 header.cwd                                │    │
│  │  │          更新 sm.sessionId                                            │    │
│  │  │          返回                                                         │    │
│  │  │                                                                       │    │
│  │  └─ No                                                                   │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  ◇ 文件存在 && 有 header && 无 assistant?                               │    │
│  │  │                                                                       │    │
│  │  ├─ Yes ──> 重置文件为空                                                │    │
│  │  │          保留 header, 清空 byId/labelsById                           │    │
│  │  │          设置 flushed=false                                          │    │
│  │  │                                                                       │    │
│  │  └─ No  ──> 无需处理                                                    │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 4. 历史限制机制

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    History Limiting (history.ts)                                 │
│                                                                                  │
│  目的: 减少长期 DM 会话的 token 消耗                                            │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    limitHistoryTurns 算法                                │    │
│  │                                                                          │    │
│  │  输入: messages[], limit (用户轮次数)                                   │    │
│  │                                                                          │    │
│  │  Messages:  [U1] [A1] [U2] [A2] [T2] [A2'] [U3] [A3] [U4] [A4]          │    │
│  │              │         │                    │         │                 │    │
│  │              └─ Turn 1 ┴─── Turn 2 ─────────┴ Turn 3 ─┴─ Turn 4 ───    │    │
│  │                                                                          │    │
│  │  limit=2 时:                                                            │    │
│  │  从后向前计数 user 消息, 第 3 个 user 处截断                            │    │
│  │                                                                          │    │
│  │  结果:     ────────────────────────────── [U3] [A3] [U4] [A4]          │    │
│  │            (丢弃前面的消息)                                              │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    配置解析流程                                          │    │
│  │                                                                          │    │
│  │  getDmHistoryLimitFromSessionKey(sessionKey, config)                     │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │    │
│  │  │  Session Key 解析:                                               │    │    │
│  │  │  "agent:default:telegram:dm:123456789:thread:42"                 │    │    │
│  │  │       ↓                                                          │    │    │
│  │  │  provider = "telegram"                                           │    │    │
│  │  │  kind = "dm"                                                     │    │    │
│  │  │  userId = "123456789" (thread 后缀已剥离)                        │    │    │
│  │  └─────────────────────────────────────────────────────────────────┘    │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │    │
│  │  │  配置优先级:                                                      │    │    │
│  │  │                                                                   │    │    │
│  │  │  1. config.channels.telegram.dms["123456789"].historyLimit       │    │    │
│  │  │     (特定用户配置)                                               │    │    │
│  │  │                                                                   │    │    │
│  │  │  2. config.channels.telegram.dmHistoryLimit                      │    │    │
│  │  │     (通道默认配置)                                               │    │    │
│  │  │                                                                   │    │    │
│  │  │  3. undefined (不限制)                                           │    │    │
│  │  └─────────────────────────────────────────────────────────────────┘    │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 5. 会话压缩架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Session Compaction Architecture                               │
│                                                                                  │
│  触发时机: 上下文窗口即将溢出时自动触发                                         │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    Compaction Flow (compact.ts)                          │    │
│  │                                                                          │    │
│  │  compactEmbeddedPiSession(params)                                        │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │    │
│  │  │  Lane Queueing (避免并发冲突)                                    │    │    │
│  │  │                                                                   │    │    │
│  │  │  sessionLane ─┐                                                  │    │    │
│  │  │               ├──> 串行执行                                      │    │    │
│  │  │  globalLane ──┘                                                  │    │    │
│  │  └─────────────────────────────────────────────────────────────────┘    │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  compactEmbeddedPiSessionDirect(params)                                  │    │
│  │       │                                                                  │    │
│  │       ├──> 解析模型、获取 API Key                                       │    │
│  │       ├──> 初始化工作区、沙箱                                           │    │
│  │       ├──> 加载技能、构建系统提示                                       │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │    │
│  │  │  Session Lock & Manager                                          │    │    │
│  │  │                                                                   │    │    │
│  │  │  acquireSessionWriteLock()                                       │    │    │
│  │  │       │                                                          │    │    │
│  │  │       ▼                                                          │    │    │
│  │  │  SessionManager.open(sessionFile)                                │    │    │
│  │  │       │                                                          │    │    │
│  │  │       ▼                                                          │    │    │
│  │  │  guardSessionManager() (工具结果保护)                            │    │    │
│  │  └─────────────────────────────────────────────────────────────────┘    │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │    │
│  │  │  History Processing                                              │    │    │
│  │  │                                                                   │    │    │
│  │  │  1. sanitizeSessionHistory()  - 清理历史                         │    │    │
│  │  │  2. validateGeminiTurns()     - Gemini 格式校验                  │    │    │
│  │  │  3. validateAnthropicTurns()  - Anthropic 格式校验               │    │    │
│  │  │  4. limitHistoryTurns()       - 应用历史限制                     │    │    │
│  │  └─────────────────────────────────────────────────────────────────┘    │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  session.compact(customInstructions)                                     │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  返回 EmbeddedPiCompactResult:                                           │    │
│  │  {                                                                       │    │
│  │    ok: true,                                                             │    │
│  │    compacted: true,                                                      │    │
│  │    result: {                                                             │    │
│  │      summary: "压缩摘要...",                                             │    │
│  │      firstKeptEntryId: "entry-id",                                       │    │
│  │      tokensBefore: 128000,                                               │    │
│  │      tokensAfter: 8000,                                                  │    │
│  │      details: { readFiles, modifiedFiles }                               │    │
│  │    }                                                                     │    │
│  │  }                                                                       │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 6. 压缩摘要生成

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Compaction Summarization (compaction.ts)                      │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    summarizeInStages 流程                                │    │
│  │                                                                          │    │
│  │  输入: messages[], model, apiKey, reserveTokens, maxChunkTokens         │    │
│  │                                                                          │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  ◇ 消息数 < minMessagesForSplit (4) 或 tokens < maxChunkTokens?        │    │
│  │  │                                                                       │    │
│  │  ├─ Yes ──> summarizeWithFallback() (单次摘要)                          │    │
│  │  │                                                                       │    │
│  │  └─ No                                                                   │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │    │
│  │  │  Stage 1: 分割消息                                               │    │    │
│  │  │                                                                   │    │    │
│  │  │  splitMessagesByTokenShare(messages, parts=2)                    │    │    │
│  │  │                                                                   │    │    │
│  │  │  [msg1, msg2, msg3, msg4, msg5, msg6]                            │    │    │
│  │  │           │                  │                                    │    │    │
│  │  │           ▼                  ▼                                    │    │    │
│  │  │       [chunk1]           [chunk2]                                 │    │    │
│  │  │  (按 token 数均分)                                                │    │    │
│  │  └─────────────────────────────────────────────────────────────────┘    │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │    │
│  │  │  Stage 2: 分别摘要各块                                           │    │    │
│  │  │                                                                   │    │    │
│  │  │  for each chunk:                                                 │    │    │
│  │  │    summarizeWithFallback(chunk) ──> partialSummary              │    │    │
│  │  │                                                                   │    │    │
│  │  │  partialSummaries = [summary1, summary2]                         │    │    │
│  │  └─────────────────────────────────────────────────────────────────┘    │    │
│  │       │                                                                  │    │
│  │       ▼                                                                  │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │    │
│  │  │  Stage 3: 合并摘要                                               │    │    │
│  │  │                                                                   │    │    │
│  │  │  instructions = "Merge these partial summaries into a single    │    │    │
│  │  │                  cohesive summary. Preserve decisions, TODOs,   │    │    │
│  │  │                  open questions, and any constraints."          │    │    │
│  │  │                                                                   │    │    │
│  │  │  summarizeWithFallback(summaryMessages, instructions)            │    │    │
│  │  │       │                                                          │    │    │
│  │  │       ▼                                                          │    │    │
│  │  │  finalSummary                                                    │    │    │
│  │  └─────────────────────────────────────────────────────────────────┘    │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    Adaptive Chunk Ratio                                  │    │
│  │                                                                          │    │
│  │  computeAdaptiveChunkRatio(messages, contextWindow)                      │    │
│  │                                                                          │    │
│  │  BASE_CHUNK_RATIO = 0.4 (默认)                                          │    │
│  │  MIN_CHUNK_RATIO  = 0.15 (最小)                                         │    │
│  │  SAFETY_MARGIN    = 1.2 (20% 缓冲)                                      │    │
│  │                                                                          │    │
│  │  avgRatio = (avgTokens * SAFETY_MARGIN) / contextWindow                 │    │
│  │                                                                          │    │
│  │  if avgRatio > 0.1:                                                     │    │
│  │    reduction = min(avgRatio * 2, BASE - MIN)                            │    │
│  │    return max(MIN, BASE - reduction)                                    │    │
│  │  else:                                                                  │    │
│  │    return BASE                                                          │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 7. 压缩安全守卫

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Compaction Safeguard Extension                                │
│                    (pi-extensions/compaction-safeguard.ts)                       │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    Extension Hook                                        │    │
│  │                                                                          │    │
│  │  api.on("session_before_compact", async (event, ctx) => { ... })        │    │
│  │                                                                          │    │
│  │  event 包含:                                                             │    │
│  │  • preparation.messagesToSummarize  - 需要摘要的消息                    │    │
│  │  • preparation.turnPrefixMessages   - 分割轮次前缀                      │    │
│  │  • preparation.fileOps              - 文件操作记录                      │    │
│  │  • preparation.tokensBefore         - 压缩前 token 数                   │    │
│  │  • preparation.firstKeptEntryId     - 保留的首条目 ID                   │    │
│  │  • customInstructions               - 自定义指令                        │    │
│  │  • signal                           - 取消信号                          │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    Safeguard Processing                                  │    │
│  │                                                                          │    │
│  │  1. 收集工具失败信息                                                    │    │
│  │     ┌────────────────────────────────────────────────────────────┐      │    │
│  │     │  collectToolFailures(messages)                              │      │    │
│  │     │  → 提取 isError=true 的 toolResult                         │      │    │
│  │     │  → 格式化: "- toolName (status=error): message..."         │      │    │
│  │     │  → 最多保留 8 条                                           │      │    │
│  │     └────────────────────────────────────────────────────────────┘      │    │
│  │                                                                          │    │
│  │  2. 计算文件操作列表                                                    │    │
│  │     ┌────────────────────────────────────────────────────────────┐      │    │
│  │     │  computeFileLists(fileOps)                                  │      │    │
│  │     │  • readFiles = fileOps.read - modified                     │      │    │
│  │     │  • modifiedFiles = fileOps.edited ∪ fileOps.written        │      │    │
│  │     └────────────────────────────────────────────────────────────┘      │    │
│  │                                                                          │    │
│  │  3. 历史修剪 (新内容占用过多上下文时)                                   │    │
│  │     ┌────────────────────────────────────────────────────────────┐      │    │
│  │     │  if newContentTokens > maxHistoryTokens (50%):              │      │    │
│  │     │    pruneHistoryForContextShare()                            │      │    │
│  │     │    → 按块丢弃旧消息直到符合预算                             │      │    │
│  │     └────────────────────────────────────────────────────────────┘      │    │
│  │                                                                          │    │
│  │  4. 分阶段摘要                                                          │    │
│  │     ┌────────────────────────────────────────────────────────────┐      │    │
│  │     │  summarizeInStages({                                        │      │    │
│  │     │    messages: messagesToSummarize,                          │      │    │
│  │     │    maxChunkTokens: contextWindow * adaptiveRatio,          │      │    │
│  │     │    ...                                                      │      │    │
│  │     │  })                                                         │      │    │
│  │     │                                                             │      │    │
│  │     │  if (isSplitTurn):                                         │      │    │
│  │     │    summarizeInStages(turnPrefixMessages)                   │      │    │
│  │     │    → 合并: "history\n\n---\n\nTurn Context: prefix"        │      │    │
│  │     └────────────────────────────────────────────────────────────┘      │    │
│  │                                                                          │    │
│  │  5. 附加元数据                                                          │    │
│  │     ┌────────────────────────────────────────────────────────────┐      │    │
│  │     │  summary += toolFailureSection                              │      │    │
│  │     │  summary += formatFileOperations(readFiles, modifiedFiles) │      │    │
│  │     │                                                             │      │    │
│  │     │  最终格式:                                                  │      │    │
│  │     │  ───────────────────────────────────────────────────────   │      │    │
│  │     │  <摘要文本>                                                 │      │    │
│  │     │                                                             │      │    │
│  │     │  ## Tool Failures                                          │      │    │
│  │     │  - exec (exitCode=1): command not found...                 │      │    │
│  │     │                                                             │      │    │
│  │     │  <read-files>                                              │      │    │
│  │     │  /path/to/file1.ts                                         │      │    │
│  │     │  /path/to/file2.ts                                         │      │    │
│  │     │  </read-files>                                             │      │    │
│  │     │                                                             │      │    │
│  │     │  <modified-files>                                          │      │    │
│  │     │  /path/to/edited.ts                                        │      │    │
│  │     │  </modified-files>                                         │      │    │
│  │     └────────────────────────────────────────────────────────────┘      │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    Fallback Handling                                     │    │
│  │                                                                          │    │
│  │  当摘要生成失败时 (无模型、无 API Key、生成异常):                       │    │
│  │                                                                          │    │
│  │  fallbackSummary =                                                       │    │
│  │    "Summary unavailable due to context limits. Older messages were      │    │
│  │     truncated." + toolFailureSection + fileOpsSummary                   │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 8. 会话生命周期总览

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Session Lifecycle Overview                                    │
│                                                                                  │
│  ┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐                │
│  │ Create  │─────>│  Run    │─────>│ Compact │─────>│  End    │                │
│  │         │      │         │      │(自动)   │      │         │                │
│  └────┬────┘      └────┬────┘      └────┬────┘      └────┬────┘                │
│       │                │                │                │                       │
│       ▼                ▼                ▼                ▼                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                          │    │
│  │  Create:                                                                 │    │
│  │  • resolveSession() 确定 session key                                    │    │
│  │  • 创建/加载 .jsonl 文件                                                 │    │
│  │  • 写入 session header                                                   │    │
│  │                                                                          │    │
│  │  Run:                                                                    │    │
│  │  • acquireSessionWriteLock() 获取写锁                                   │    │
│  │  • SessionManager.open() 加载历史                                       │    │
│  │  • prepareSessionManagerForRun() 规范化状态                             │    │
│  │  • 执行对话轮次                                                          │    │
│  │  • 追加消息到 .jsonl                                                     │    │
│  │  • 释放写锁                                                              │    │
│  │                                                                          │    │
│  │  Compact (自动触发):                                                     │    │
│  │  • 检测到上下文即将溢出                                                  │    │
│  │  • limitHistoryTurns() 应用 DM 历史限制                                 │    │
│  │  • session.compact() 调用压缩                                           │    │
│  │  • compaction-safeguard 生成摘要                                        │    │
│  │  • 写入 compaction 条目                                                  │    │
│  │                                                                          │    │
│  │  End (Subagent):                                                         │    │
│  │  • SubagentRegistry 标记 endedAt                                        │    │
│  │  • Sweeper 定时清理过期会话文件                                          │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 9. 关键文件

| 文件 | 大小 | 职责 |
|------|------|------|
| `pi-embedded-runner/compact.ts` | 19 KB | 会话压缩核心逻辑 |
| `pi-embedded-runner/history.ts` | 3 KB | 历史限制算法 |
| `pi-embedded-runner/session-manager-init.ts` | 2 KB | SessionManager 初始化 |
| `session-write-lock.ts` | 4 KB | 会话文件写锁 |
| `compaction.ts` | 11 KB | 压缩摘要生成算法 |
| `pi-extensions/compaction-safeguard.ts` | 9 KB | 压缩安全守卫扩展 |
| `session-tool-result-guard.ts` | - | 工具结果保护 |
| `session-transcript-repair.ts` | - | 会话记录修复 |
