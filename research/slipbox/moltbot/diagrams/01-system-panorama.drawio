<mxGraphModel dx="1200" dy="800" grid="0" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="1200" math="0" shadow="0">
  <root>
    <mxCell id="0"/>
    <mxCell id="1" parent="0"/>
    
    <!-- Title -->
    <mxCell id="title" value="Clawdbot 系统分层架构全景图" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1;fontSize=28;fontColor=#202124;sketch=1;" parent="1" vertex="1">
      <mxGeometry x="400" y="20" width="600" height="50" as="geometry"/>
    </mxCell>
    
    <!-- Entry Layer Background -->
    <mxCell id="entry-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=3;fillColor=#C6DAFC;strokeColor=#1A73E8;opacity=50;" parent="1" vertex="1">
      <mxGeometry x="40" y="90" width="1520" height="160" as="geometry"/>
    </mxCell>
    <mxCell id="entry-label" value="ENTRY LAYER (入口层)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1;fontSize=18;fontColor=#0D47A1;sketch=1;" parent="1" vertex="1">
      <mxGeometry x="60" y="95" width="300" height="30" as="geometry"/>
    </mxCell>
    
    <!-- Channel Plugins -->
    <mxCell id="channels-box" value="" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fillColor=#A8C7FA;strokeColor=#1A73E8;" parent="1" vertex="1">
      <mxGeometry x="60" y="130" width="500" height="100" as="geometry"/>
    </mxCell>
    <mxCell id="channels-title" value="Channel Plugins" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1;fontSize=14;fontColor=#0D47A1;" parent="1" vertex="1">
      <mxGeometry x="60" y="130" width="500" height="25" as="geometry"/>
    </mxCell>
    <mxCell id="telegram" value="Telegram&#xa;Grammy" style="ellipse;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontStyle=1;fontSize=11;fillColor=#4285F4;strokeColor=#1A73E8;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="75" y="160" width="70" height="55" as="geometry"/>
    </mxCell>
    <mxCell id="discord" value="Discord&#xa;Carbon" style="ellipse;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontStyle=1;fontSize=11;fillColor=#4285F4;strokeColor=#1A73E8;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="155" y="160" width="70" height="55" as="geometry"/>
    </mxCell>
    <mxCell id="slack" value="Slack&#xa;Bolt" style="ellipse;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontStyle=1;fontSize=11;fillColor=#4285F4;strokeColor=#1A73E8;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="235" y="160" width="70" height="55" as="geometry"/>
    </mxCell>
    <mxCell id="whatsapp" value="WhatsApp&#xa;Baileys" style="ellipse;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontStyle=1;fontSize=11;fillColor=#4285F4;strokeColor=#1A73E8;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="315" y="160" width="70" height="55" as="geometry"/>
    </mxCell>
    <mxCell id="signal" value="Signal" style="ellipse;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontStyle=1;fontSize=11;fillColor=#4285F4;strokeColor=#1A73E8;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="395" y="160" width="70" height="55" as="geometry"/>
    </mxCell>
    <mxCell id="matrix" value="Matrix" style="ellipse;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontStyle=1;fontSize=11;fillColor=#4285F4;strokeColor=#1A73E8;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="475" y="160" width="70" height="55" as="geometry"/>
    </mxCell>
    
    <!-- HTTP Endpoints -->
    <mxCell id="http-box" value="" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fillColor=#A8C7FA;strokeColor=#1A73E8;" parent="1" vertex="1">
      <mxGeometry x="580" y="130" width="450" height="100" as="geometry"/>
    </mxCell>
    <mxCell id="http-title" value="HTTP Endpoints (Hono Server)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1;fontSize=14;fontColor=#0D47A1;" parent="1" vertex="1">
      <mxGeometry x="580" y="130" width="450" height="25" as="geometry"/>
    </mxCell>
    <mxCell id="control-ui" value="Control UI" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontStyle=1;fontSize=11;fillColor=#4285F4;strokeColor=#1A73E8;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="600" y="165" width="80" height="45" as="geometry"/>
    </mxCell>
    <mxCell id="openai-api" value="OpenAI API&#xa;/v1/chat/*" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontStyle=1;fontSize=11;fillColor=#4285F4;strokeColor=#1A73E8;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="695" y="165" width="80" height="45" as="geometry"/>
    </mxCell>
    <mxCell id="webhooks" value="Webhooks&#xa;/hooks/*" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontStyle=1;fontSize=11;fillColor=#4285F4;strokeColor=#1A73E8;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="790" y="165" width="80" height="45" as="geometry"/>
    </mxCell>
    <mxCell id="a2ui" value="Canvas&#xa;/a2ui/*" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontStyle=1;fontSize=11;fillColor=#4285F4;strokeColor=#1A73E8;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="885" y="165" width="80" height="45" as="geometry"/>
    </mxCell>
    <mxCell id="tools-invoke" value="Tools&#xa;/tools/invoke" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontStyle=1;fontSize=11;fillColor=#4285F4;strokeColor=#1A73E8;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="980" y="165" width="80" height="45" as="geometry"/>
    </mxCell>
    
    <!-- WebSocket -->
    <mxCell id="ws-box" value="WebSocket&#xa;GatewayWs" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontStyle=1;fontSize=12;fillColor=#A8C7FA;strokeColor=#1A73E8;fontColor=#0D47A1;" parent="1" vertex="1">
      <mxGeometry x="1050" y="130" width="120" height="100" as="geometry"/>
    </mxCell>
    
    <!-- Node Registry -->
    <mxCell id="node-reg" value="Node&#xa;Registry" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontStyle=1;fontSize=12;fillColor=#A8C7FA;strokeColor=#1A73E8;fontColor=#0D47A1;" parent="1" vertex="1">
      <mxGeometry x="1190" y="130" width="100" height="100" as="geometry"/>
    </mxCell>
    
    <!-- Mobile -->
    <mxCell id="mobile" value="Mobile&#xa;Apps" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontStyle=1;fontSize=12;fillColor=#A8C7FA;strokeColor=#1A73E8;fontColor=#0D47A1;" parent="1" vertex="1">
      <mxGeometry x="1310" y="130" width="90" height="100" as="geometry"/>
    </mxCell>
    
    <!-- Desktop -->
    <mxCell id="desktop" value="Desktop&#xa;App" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontStyle=1;fontSize=12;fillColor=#A8C7FA;strokeColor=#1A73E8;fontColor=#0D47A1;" parent="1" vertex="1">
      <mxGeometry x="1420" y="130" width="90" height="100" as="geometry"/>
    </mxCell>
    
    <!-- Routing Layer Background -->
    <mxCell id="routing-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=3;fillColor=#FEEFC3;strokeColor=#E37400;opacity=50;" parent="1" vertex="1">
      <mxGeometry x="40" y="270" width="1520" height="130" as="geometry"/>
    </mxCell>
    <mxCell id="routing-label" value="ROUTING LAYER (路由层)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1;fontSize=18;fontColor=#5D4200;sketch=1;" parent="1" vertex="1">
      <mxGeometry x="60" y="275" width="300" height="30" as="geometry"/>
    </mxCell>
    
    <mxCell id="preflight" value="Preflight Check&#xa;• Allowlist&#xa;• Mention check&#xa;• Bot self-check" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#FDE293;strokeColor=#E37400;fontColor=#5D4200;" parent="1" vertex="1">
      <mxGeometry x="80" y="310" width="140" height="70" as="geometry"/>
    </mxCell>
    
    <mxCell id="route-resolve" value="Route Resolution&#xa;• Agent Binding&#xa;• Priority match&#xa;• Default agent" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#FDE293;strokeColor=#E37400;fontColor=#5D4200;" parent="1" vertex="1">
      <mxGeometry x="260" y="310" width="140" height="70" as="geometry"/>
    </mxCell>
    
    <mxCell id="session-key" value="Session Key Gen&#xa;• agent:id:ch:dm&#xa;• Thread suffix&#xa;• Subagent prefix" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#FDE293;strokeColor=#E37400;fontColor=#5D4200;" parent="1" vertex="1">
      <mxGeometry x="440" y="310" width="140" height="70" as="geometry"/>
    </mxCell>
    
    <mxCell id="debouncer" value="Inbound Debouncer&#xa;• Merge rapid msg&#xa;• Control cmd skip&#xa;• Buffer timeout" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#FDE293;strokeColor=#E37400;fontColor=#5D4200;" parent="1" vertex="1">
      <mxGeometry x="620" y="310" width="140" height="70" as="geometry"/>
    </mxCell>
    
    <!-- Routing arrows -->
    <mxCell id="r-arrow1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;sketch=1;curveFitting=1;jiggle=2;html=1;strokeWidth=3;strokeColor=#E37400;endArrow=classic;" parent="1" source="preflight" target="route-resolve" edge="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="r-arrow2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;sketch=1;curveFitting=1;jiggle=2;html=1;strokeWidth=3;strokeColor=#E37400;endArrow=classic;" parent="1" source="route-resolve" target="session-key" edge="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="r-arrow3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;sketch=1;curveFitting=1;jiggle=2;html=1;strokeWidth=3;strokeColor=#E37400;endArrow=classic;" parent="1" source="session-key" target="debouncer" edge="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    
    <!-- Agents Layer Background -->
    <mxCell id="agents-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=3;fillColor=#FAD2CF;strokeColor=#C5221F;opacity=50;" parent="1" vertex="1">
      <mxGeometry x="40" y="420" width="1520" height="280" as="geometry"/>
    </mxCell>
    <mxCell id="agents-label" value="AGENTS LAYER (代理层)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1;fontSize=18;fontColor=#7F0000;sketch=1;" parent="1" vertex="1">
      <mxGeometry x="60" y="425" width="300" height="30" as="geometry"/>
    </mxCell>
    
    <!-- Agent Runtime Box -->
    <mxCell id="runtime-box" value="" style="rounded=1;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fillColor=#F28B82;strokeColor=#C5221F;opacity=70;" parent="1" vertex="1">
      <mxGeometry x="60" y="460" width="1480" height="220" as="geometry"/>
    </mxCell>
    <mxCell id="runtime-title" value="Agent Runtime (runEmbeddedPiAgent)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1;fontSize=16;fontColor=#7F0000;sketch=1;" parent="1" vertex="1">
      <mxGeometry x="80" y="465" width="400" height="25" as="geometry"/>
    </mxCell>
    
    <!-- Main Flow Steps -->
    <mxCell id="step1" value="1. Resolve&#xa;Model" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#EA4335;strokeColor=#C5221F;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="90" y="500" width="90" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="step2" value="2. Auth&#xa;Profile" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#EA4335;strokeColor=#C5221F;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="200" y="500" width="90" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="step3" value="3. Session&#xa;Lock" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#EA4335;strokeColor=#C5221F;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="310" y="500" width="90" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="step4" value="4. Create&#xa;Tools" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#EA4335;strokeColor=#C5221F;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="420" y="500" width="90" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="step5" value="5. Load&#xa;History" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#EA4335;strokeColor=#C5221F;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="530" y="500" width="90" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="step6" value="6. Stream&#xa;Request" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#EA4335;strokeColor=#C5221F;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="640" y="500" width="90" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="step7" value="7. Execute&#xa;Tools" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#EA4335;strokeColor=#C5221F;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="750" y="500" width="90" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="step8" value="8. Persist&#xa;Result" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#EA4335;strokeColor=#C5221F;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="860" y="500" width="90" height="50" as="geometry"/>
    </mxCell>
    
    <!-- Step arrows -->
    <mxCell id="s-arrow1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;sketch=1;curveFitting=1;jiggle=2;html=1;strokeWidth=2;strokeColor=#C5221F;endArrow=classic;" parent="1" source="step1" target="step2" edge="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="s-arrow2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;sketch=1;curveFitting=1;jiggle=2;html=1;strokeWidth=2;strokeColor=#C5221F;endArrow=classic;" parent="1" source="step2" target="step3" edge="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="s-arrow3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;sketch=1;curveFitting=1;jiggle=2;html=1;strokeWidth=2;strokeColor=#C5221F;endArrow=classic;" parent="1" source="step3" target="step4" edge="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="s-arrow4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;sketch=1;curveFitting=1;jiggle=2;html=1;strokeWidth=2;strokeColor=#C5221F;endArrow=classic;" parent="1" source="step4" target="step5" edge="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="s-arrow5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;sketch=1;curveFitting=1;jiggle=2;html=1;strokeWidth=2;strokeColor=#C5221F;endArrow=classic;" parent="1" source="step5" target="step6" edge="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="s-arrow6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;sketch=1;curveFitting=1;jiggle=2;html=1;strokeWidth=2;strokeColor=#C5221F;endArrow=classic;" parent="1" source="step6" target="step7" edge="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="s-arrow7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;sketch=1;curveFitting=1;jiggle=2;html=1;strokeWidth=2;strokeColor=#C5221F;endArrow=classic;" parent="1" source="step7" target="step8" edge="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    
    <!-- Subsystems -->
    <mxCell id="tool-system" value="Tool System&#xa;• createTools()&#xa;• policyFilter&#xa;• bashExec" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#FAD2CF;strokeColor=#C5221F;fontColor=#7F0000;" parent="1" vertex="1">
      <mxGeometry x="90" y="580" width="130" height="80" as="geometry"/>
    </mxCell>
    <mxCell id="stream-handler" value="Streaming Handler&#xa;• subscribePI()&#xa;• eventHandler&#xa;• blockChunker" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#FAD2CF;strokeColor=#C5221F;fontColor=#7F0000;" parent="1" vertex="1">
      <mxGeometry x="240" y="580" width="130" height="80" as="geometry"/>
    </mxCell>
    <mxCell id="auth-profiles" value="Auth Profiles&#xa;• resolveOrder()&#xa;• filterCooldown&#xa;• calculateCD" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#FAD2CF;strokeColor=#C5221F;fontColor=#7F0000;" parent="1" vertex="1">
      <mxGeometry x="390" y="580" width="130" height="80" as="geometry"/>
    </mxCell>
    <mxCell id="session-mgr" value="Session Manager&#xa;• .jsonl files&#xa;• writeLock&#xa;• compaction" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#FAD2CF;strokeColor=#C5221F;fontColor=#7F0000;" parent="1" vertex="1">
      <mxGeometry x="540" y="580" width="130" height="80" as="geometry"/>
    </mxCell>
    
    <!-- pi-ai lib -->
    <mxCell id="pi-ai" value="pi-ai lib&#xa;(LLM calls)" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=12;fontStyle=1;fillColor=#EA4335;strokeColor=#C5221F;fontColor=#FFFFFF;" parent="1" vertex="1">
      <mxGeometry x="990" y="500" width="100" height="50" as="geometry"/>
    </mxCell>
    
    <!-- Reply Dispatcher -->
    <mxCell id="reply-dispatch" value="Reply Dispatcher&#xa;• buildPayloads()&#xa;• chunkMessages()" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#FAD2CF;strokeColor=#C5221F;fontColor=#7F0000;" parent="1" vertex="1">
      <mxGeometry x="1110" y="500" width="130" height="60" as="geometry"/>
    </mxCell>
    
    <!-- Diagnostics -->
    <mxCell id="diagnostics" value="Diagnostics&#xa;• SubsystemLog&#xa;• DiagEvents&#xa;• UsageTrack" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#FAD2CF;strokeColor=#C5221F;fontColor=#7F0000;" parent="1" vertex="1">
      <mxGeometry x="1260" y="500" width="120" height="80" as="geometry"/>
    </mxCell>
    
    <!-- Subagent -->
    <mxCell id="subagent" value="Subagent&#xa;Spawner" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#FAD2CF;strokeColor=#C5221F;fontColor=#7F0000;" parent="1" vertex="1">
      <mxGeometry x="1400" y="500" width="100" height="60" as="geometry"/>
    </mxCell>
    
    <!-- Infrastructure Layer Background -->
    <mxCell id="infra-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=3;fillColor=#CEEAD6;strokeColor=#188038;opacity=50;" parent="1" vertex="1">
      <mxGeometry x="40" y="720" width="1520" height="180" as="geometry"/>
    </mxCell>
    <mxCell id="infra-label" value="INFRASTRUCTURE LAYER (基础设施层)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1;fontSize=18;fontColor=#0B5323;sketch=1;" parent="1" vertex="1">
      <mxGeometry x="60" y="725" width="400" height="30" as="geometry"/>
    </mxCell>
    
    <!-- Gateway Server -->
    <mxCell id="gateway-server" value="Gateway Server&#xa;• HTTP Server (Hono)&#xa;• WebSocket Handler&#xa;• Request Handlers (40+)" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#A8DAB5;strokeColor=#188038;fontColor=#0B5323;" parent="1" vertex="1">
      <mxGeometry x="80" y="760" width="200" height="80" as="geometry"/>
    </mxCell>
    
    <!-- Command Queue -->
    <mxCell id="cmd-queue" value="Command Queue&#xa;• Main Lane&#xa;• Cron Lane&#xa;• Subagent Lane" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#A8DAB5;strokeColor=#188038;fontColor=#0B5323;" parent="1" vertex="1">
      <mxGeometry x="310" y="760" width="150" height="80" as="geometry"/>
    </mxCell>
    
    <!-- Config System -->
    <mxCell id="config-system" value="Config System&#xa;• loadConfig()&#xa;• hotReload()&#xa;• envSubstitute" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#A8DAB5;strokeColor=#188038;fontColor=#0B5323;" parent="1" vertex="1">
      <mxGeometry x="490" y="760" width="150" height="80" as="geometry"/>
    </mxCell>
    
    <!-- Health Monitor -->
    <mxCell id="health-monitor" value="Health Monitor&#xa;• buildSnapshot&#xa;• healthCache&#xa;• presenceVer" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#A8DAB5;strokeColor=#188038;fontColor=#0B5323;" parent="1" vertex="1">
      <mxGeometry x="670" y="760" width="150" height="80" as="geometry"/>
    </mxCell>
    
    <!-- Channel Manager -->
    <mxCell id="channel-mgr" value="Channel Manager&#xa;• start/stop&#xa;• getRuntime&#xa;• abortCtrl" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#A8DAB5;strokeColor=#188038;fontColor=#0B5323;" parent="1" vertex="1">
      <mxGeometry x="850" y="760" width="150" height="80" as="geometry"/>
    </mxCell>
    
    <!-- File System -->
    <mxCell id="filesystem" value="File System&#xa;• JSONL I/O&#xa;• Lock files&#xa;• Credentials" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#A8DAB5;strokeColor=#188038;fontColor=#0B5323;" parent="1" vertex="1">
      <mxGeometry x="1030" y="760" width="150" height="80" as="geometry"/>
    </mxCell>
    
    <!-- Process Manager -->
    <mxCell id="process-mgr" value="Process Manager&#xa;• bash exec&#xa;• sandbox&#xa;• sidecars" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#A8DAB5;strokeColor=#188038;fontColor=#0B5323;" parent="1" vertex="1">
      <mxGeometry x="1210" y="760" width="150" height="80" as="geometry"/>
    </mxCell>
    
    <!-- Plugin Loader -->
    <mxCell id="plugin-loader" value="Plugin Loader&#xa;• loadPlugins()&#xa;• validateManifest" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=11;fontStyle=1;fillColor=#A8DAB5;strokeColor=#188038;fontColor=#0B5323;" parent="1" vertex="1">
      <mxGeometry x="1390" y="760" width="140" height="80" as="geometry"/>
    </mxCell>
    
    <!-- External Services Background -->
    <mxCell id="external-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=3;fillColor=#F1F3F4;strokeColor=#5F6368;opacity=50;" parent="1" vertex="1">
      <mxGeometry x="40" y="920" width="1520" height="100" as="geometry"/>
    </mxCell>
    <mxCell id="external-label" value="EXTERNAL SERVICES (外部服务)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1;fontSize=18;fontColor=#202124;sketch=1;" parent="1" vertex="1">
      <mxGeometry x="60" y="925" width="350" height="30" as="geometry"/>
    </mxCell>
    
    <mxCell id="anthropic" value="Anthropic&#xa;Claude API" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=12;fontStyle=1;fillColor=#DADCE0;strokeColor=#5F6368;fontColor=#202124;" parent="1" vertex="1">
      <mxGeometry x="100" y="960" width="120" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="google" value="Google&#xa;Gemini API" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=12;fontStyle=1;fillColor=#DADCE0;strokeColor=#5F6368;fontColor=#202124;" parent="1" vertex="1">
      <mxGeometry x="260" y="960" width="120" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="openai" value="OpenAI&#xa;GPT API" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=12;fontStyle=1;fillColor=#DADCE0;strokeColor=#5F6368;fontColor=#202124;" parent="1" vertex="1">
      <mxGeometry x="420" y="960" width="120" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="github" value="GitHub&#xa;Copilot" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=12;fontStyle=1;fillColor=#DADCE0;strokeColor=#5F6368;fontColor=#202124;" parent="1" vertex="1">
      <mxGeometry x="580" y="960" width="120" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="telegram-api" value="Telegram&#xa;Bot API" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=12;fontStyle=1;fillColor=#DADCE0;strokeColor=#5F6368;fontColor=#202124;" parent="1" vertex="1">
      <mxGeometry x="740" y="960" width="120" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="discord-api" value="Discord&#xa;API" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=12;fontStyle=1;fillColor=#DADCE0;strokeColor=#5F6368;fontColor=#202124;" parent="1" vertex="1">
      <mxGeometry x="900" y="960" width="120" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="slack-api" value="Slack&#xa;API" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=12;fontStyle=1;fillColor=#DADCE0;strokeColor=#5F6368;fontColor=#202124;" parent="1" vertex="1">
      <mxGeometry x="1060" y="960" width="120" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="whatsapp-api" value="WhatsApp&#xa;Web" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=12;fontStyle=1;fillColor=#DADCE0;strokeColor=#5F6368;fontColor=#202124;" parent="1" vertex="1">
      <mxGeometry x="1220" y="960" width="120" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="other-api" value="Other&#xa;Providers" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fontSize=12;fontStyle=1;fillColor=#DADCE0;strokeColor=#5F6368;fontColor=#202124;" parent="1" vertex="1">
      <mxGeometry x="1380" y="960" width="120" height="50" as="geometry"/>
    </mxCell>
    
    <!-- Main flow arrows between layers -->
    <mxCell id="layer-arrow1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;sketch=1;curveFitting=1;jiggle=2;html=1;strokeWidth=4;strokeColor=#1A73E8;endArrow=classic;dashed=1;" parent="1" edge="1">
      <mxGeometry relative="1" as="geometry">
        <mxPoint x="300" y="240" as="sourcePoint"/>
        <mxPoint x="300" y="270" as="targetPoint"/>
      </mxGeometry>
    </mxCell>
    <mxCell id="layer-arrow2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;sketch=1;curveFitting=1;jiggle=2;html=1;strokeWidth=4;strokeColor=#E37400;endArrow=classic;dashed=1;" parent="1" edge="1">
      <mxGeometry relative="1" as="geometry">
        <mxPoint x="500" y="390" as="sourcePoint"/>
        <mxPoint x="500" y="420" as="targetPoint"/>
      </mxGeometry>
    </mxCell>
    <mxCell id="layer-arrow3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;sketch=1;curveFitting=1;jiggle=2;html=1;strokeWidth=4;strokeColor=#C5221F;endArrow=classic;dashed=1;" parent="1" edge="1">
      <mxGeometry relative="1" as="geometry">
        <mxPoint x="700" y="700" as="sourcePoint"/>
        <mxPoint x="700" y="720" as="targetPoint"/>
      </mxGeometry>
    </mxCell>
    <mxCell id="layer-arrow4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;sketch=1;curveFitting=1;jiggle=2;html=1;strokeWidth=4;strokeColor=#188038;endArrow=classic;dashed=1;" parent="1" edge="1">
      <mxGeometry relative="1" as="geometry">
        <mxPoint x="900" y="900" as="sourcePoint"/>
        <mxPoint x="900" y="920" as="targetPoint"/>
      </mxGeometry>
    </mxCell>
    
    <!-- Legend -->
    <mxCell id="legend-box" value="" style="rounded=1;whiteSpace=wrap;html=1;sketch=1;curveFitting=1;jiggle=2;strokeWidth=2;fillColor=#FFFFFF;strokeColor=#5F6368;" parent="1" vertex="1">
      <mxGeometry x="1420" y="50" width="130" height="120" as="geometry"/>
    </mxCell>
    <mxCell id="legend-title" value="图例 Legend" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1;fontSize=12;fontColor=#202124;" parent="1" vertex="1">
      <mxGeometry x="1420" y="55" width="130" height="20" as="geometry"/>
    </mxCell>
    <mxCell id="leg1" value="" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;fillColor=#C6DAFC;strokeColor=#1A73E8;strokeWidth=2;" parent="1" vertex="1">
      <mxGeometry x="1430" y="80" width="20" height="15" as="geometry"/>
    </mxCell>
    <mxCell id="leg1-text" value="Entry" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=10;fontColor=#202124;" parent="1" vertex="1">
      <mxGeometry x="1455" y="77" width="80" height="20" as="geometry"/>
    </mxCell>
    <mxCell id="leg2" value="" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;fillColor=#FEEFC3;strokeColor=#E37400;strokeWidth=2;" parent="1" vertex="1">
      <mxGeometry x="1430" y="100" width="20" height="15" as="geometry"/>
    </mxCell>
    <mxCell id="leg2-text" value="Routing" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=10;fontColor=#202124;" parent="1" vertex="1">
      <mxGeometry x="1455" y="97" width="80" height="20" as="geometry"/>
    </mxCell>
    <mxCell id="leg3" value="" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;fillColor=#FAD2CF;strokeColor=#C5221F;strokeWidth=2;" parent="1" vertex="1">
      <mxGeometry x="1430" y="120" width="20" height="15" as="geometry"/>
    </mxCell>
    <mxCell id="leg3-text" value="Agents" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=10;fontColor=#202124;" parent="1" vertex="1">
      <mxGeometry x="1455" y="117" width="80" height="20" as="geometry"/>
    </mxCell>
    <mxCell id="leg4" value="" style="rounded=0;whiteSpace=wrap;html=1;sketch=1;fillColor=#CEEAD6;strokeColor=#188038;strokeWidth=2;" parent="1" vertex="1">
      <mxGeometry x="1430" y="140" width="20" height="15" as="geometry"/>
    </mxCell>
    <mxCell id="leg4-text" value="Infra" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=10;fontColor=#202124;" parent="1" vertex="1">
      <mxGeometry x="1455" y="137" width="80" height="20" as="geometry"/>
    </mxCell>
  </root>
</mxGraphModel>