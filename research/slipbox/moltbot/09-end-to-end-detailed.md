# Clawdbot 端到端架构详细图表

本文档提供 Clawdbot 系统的端到端详细架构分析。采用统一的 6 层架构模型，与 [01-system-overview.md](01-system-overview.md) 保持一致。

## 统一架构层次（6 层）

| 层 | 名称 | 角色 |
|---|---|---|
| 1 | Entry Layer | 入口层：UI、Channel Plugins、HTTP Endpoints |
| 2 | Gateway Layer | 网关层：协调者，HTTP/WS 服务，Channel 管理 |
| 3 | Routing Layer | 路由层：Preflight、路由解析、会话键生成 |
| 4 | Agents Layer | 代理层：Agent 运行时、工具系统、认证轮换 |
| 5 | Infrastructure Layer | 基础设施层：纯工具箱，被动服务 |
| 6 | External Services | 外部服务：LLM 提供商 |

**关键设计原则：**
- 依赖方向单向自顶向下
- Gateway 是协调者，独立于 Infrastructure Layer
- Infrastructure Layer 是纯支撑服务层（Servant Pattern），从不调用上层

## 目录

1. [系统全景图](#第一部分系统全景图)
   - 1.1 系统分层架构
   - 1.2 端到端数据流
   - 1.3 组件依赖关系图
2. [Gateway Layer 详细图](#第二部分gateway-layer-详细图)
   - 2.1 Gateway 协议和通信
   - 2.2 Channel 管理
3. [Agents Layer 详细图](#第三部分agents-layer-详细图)
   - 3.1 工具系统内部结构
   - 3.2 流式事件状态机
   - 3.3 认证轮换机制
   - 3.4 会话管理
4. [Infrastructure Layer 详细图](#第四部分infrastructure-layer-详细图)
   - 4.1 并发和队列机制
   - 4.2 配置系统
   - 4.3 工具服务分类
5. [时序图与关键文件](#第五部分时序图与关键文件)
   - 端到端详细时序图
   - 简化时序图
   - 错误处理时序图
   - 关键文件清单

---

# 第一部分：系统全景图

## 1.1 系统分层架构（完整组件视图）

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                     Clawdbot 端到端系统全景 (详细版)                                          │
│                                                                                                              │
│  ╔═══════════════════════════════════════════════════════════════════════════════════════════════════════╗  │
│  ║                                  1. ENTRY LAYER (入口层)                                               ║  │
│  ╠═══════════════════════════════════════════════════════════════════════════════════════════════════════╣  │
│  ║                                                                                                        ║  │
│  ║   ┌─────────────────────────────────────────┐    ┌─────────────────────────────────────────┐          ║  │
│  ║   │         Channel Plugins                 │    │         User Interfaces                  │          ║  │
│  ║   │  ┌─────────┐ ┌─────────┐ ┌─────────┐   │    │  ┌─────────┐ ┌─────────┐ ┌─────────┐   │          ║  │
│  ║   │  │Telegram │ │ Discord │ │  Slack  │   │    │  │   CLI   │ │   TUI   │ │ Control │   │          ║  │
│  ║   │  │ Grammy  │ │ Carbon  │ │  Bolt   │   │    │  │Commander│ │  Pi-TUI │ │   UI    │   │          ║  │
│  ║   │  └─────────┘ └─────────┘ └─────────┘   │    │  └─────────┘ └─────────┘ └─────────┘   │          ║  │
│  ║   │  ┌─────────┐ ┌─────────┐ ┌─────────┐   │    │  ┌─────────┐ ┌─────────┐               │          ║  │
│  ║   │  │WhatsApp │ │ Signal  │ │ Matrix  │   │    │  │  Mobile │ │ OpenAI  │               │          ║  │
│  ║   │  │ Baileys │ │         │ │         │   │    │  │  Apps   │ │   API   │               │          ║  │
│  ║   │  └─────────┘ └─────────┘ └─────────┘   │    │  └─────────┘ └─────────┘               │          ║  │
│  ║   └──────────────────┬──────────────────────┘    └──────────────────┬────────────────────┘          ║  │
│  ║                      │                                              │                              ║  │
│  ║                      └───────────────────────┬──────────────────────┘                              ║  │
│  ║                                              │                                                      ║  │
│  ╚══════════════════════════════════════════════╪══════════════════════════════════════════════════════╝  │
│                                                 │                                                          │
│                                                 ▼                                                          │
│  ╔═══════════════════════════════════════════════════════════════════════════════════════════════════════╗  │
│  ║                                  2. GATEWAY LAYER (网关层) - 协调者                                    ║  │
│  ╠═══════════════════════════════════════════════════════════════════════════════════════════════════════╣  │
│  ║                                                                                                        ║  │
│  ║  ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║  │                              Gateway Server (server.impl.ts)                                      │ ║  │
│  ║  │                                                                                                   │ ║  │
│  ║  │  ┌───────────────────┐    ┌───────────────────┐    ┌───────────────────┐    ┌─────────────────┐  │ ║  │
│  ║  │  │   HTTP Server     │    │  WebSocket Server │    │   Node Registry   │    │ Channel Manager │  │ ║  │
│  ║  │  │  ┌─────────────┐  │    │  ┌─────────────┐  │    │  ┌─────────────┐  │    │  ┌───────────┐  │  │ ║  │
│  ║  │  │  │ /control-ui │  │    │  │ GatewayWs   │  │    │  │ register()  │  │    │  │ start/stop│  │  │ ║  │
│  ║  │  │  │ /v1/chat/*  │  │    │  │ Client      │  │    │  │ invoke()    │  │    │  │ getRuntime│  │  │ ║  │
│  ║  │  │  │ /hooks/*    │  │    │  │ pending map │  │    │  │ broadcast() │  │    │  │ abortCtrl │  │  │ ║  │
│  ║  │  │  │ /a2ui/*     │  │    │  │ backoff     │  │    │  │ disconnect  │  │    │  │ snapshot  │  │  │ ║  │
│  ║  │  │  └─────────────┘  │    │  └─────────────┘  │    │  └─────────────┘  │    │  └───────────┘  │  │ ║  │
│  ║  │  └───────────────────┘    └───────────────────┘    └───────────────────┘    └─────────────────┘  │ ║  │
│  ║  │                                                                                                   │ ║  │
│  ║  │                              ┌─────────────────────────────────────┐                              │ ║  │
│  ║  │                              │      Request Handlers (40+)        │                              │ ║  │
│  ║  │                              │  agent, chat, config, channels,    │                              │ ║  │
│  ║  │                              │  health, sessions, send, cron...   │                              │ ║  │
│  ║  │                              └─────────────────────────────────────┘                              │ ║  │
│  ║  └──────────────────────────────────────────────────────────────────────────────────────────────────┘ ║  │
│  ║                                              │                                                        ║  │
│  ╚══════════════════════════════════════════════╪════════════════════════════════════════════════════════╝  │
│                                                 │                                                            │
│                                                 ▼                                                            │
│  ╔═══════════════════════════════════════════════════════════════════════════════════════════════════════╗  │
│  ║                                  3. ROUTING LAYER (路由层)                                             ║  │
│  ╠═══════════════════════════════════════════════════════════════════════════════════════════════════════╣  │
│  ║                                                                                                        ║  │
│  ║   ┌───────────────────┐    ┌───────────────────┐    ┌───────────────────┐    ┌───────────────────┐   ║  │
│  ║   │  Preflight Check  │───>│  Route Resolution │───>│ Session Key Gen   │───>│ Inbound Debouncer │   ║  │
│  ║   │  • Allowlist      │    │  • Agent Binding  │    │ • agent:id:ch:dm  │    │ • Merge rapid msg │   ║  │
│  ║   │  • Mention check  │    │  • Priority match │    │ • Thread suffix   │    │ • Control cmd skip│   ║  │
│  ║   │  • Bot self-check │    │  • Default agent  │    │ • Subagent prefix │    │ • Buffer timeout  │   ║  │
│  ║   └───────────────────┘    └───────────────────┘    └───────────────────┘    └─────────┬─────────┘   ║  │
│  ║                                                                                        │              ║  │
│  ╚════════════════════════════════════════════════════════════════════════════════════════╪══════════════╝  │
│                                                                                           │                  │
│                                                                                           ▼                  │
│  ╔═══════════════════════════════════════════════════════════════════════════════════════════════════════╗  │
│  ║                                  4. AGENTS LAYER (代理层)                                              ║  │
│  ╠═══════════════════════════════════════════════════════════════════════════════════════════════════════╣  │
│  ║                                                                                                        ║  │
│  ║  ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║  │                              Agent Runtime (pi-embedded-runner)                                   │ ║  │
│  ║  │                                                                                                   │ ║  │
│  ║  │  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │ ║  │
│  ║  │  │                              runEmbeddedPiAgent() 主流程                                     │ │ ║  │
│  ║  │  │                                                                                              │ │ ║  │
│  ║  │  │    ┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐          │ │ ║  │
│  ║  │  │    │ 1. Resolve   │────>│ 2. Auth      │────>│ 3. Session   │────>│ 4. Create    │          │ │ ║  │
│  ║  │  │    │    Model     │     │    Profile   │     │    Lock      │     │    Tools     │          │ │ ║  │
│  ║  │  │    │              │     │              │     │              │     │              │          │ │ ║  │
│  ║  │  │    │ provider/    │     │ filter       │     │ exclusive    │     │ policy       │          │ │ ║  │
│  ║  │  │    │ modelId      │     │ cooldown     │     │ file lock    │     │ pipeline     │          │ │ ║  │
│  ║  │  │    └──────────────┘     └──────────────┘     └──────────────┘     └──────────────┘          │ │ ║  │
│  ║  │  │            │                   │                   │                   │                     │ │ ║  │
│  ║  │  │            └───────────────────┼───────────────────┼───────────────────┘                     │ │ ║  │
│  ║  │  │                                │                   │                                         │ │ ║  │
│  ║  │  │                                ▼                   ▼                                         │ │ ║  │
│  ║  │  │    ┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐          │ │ ║  │
│  ║  │  │    │ 5. Load      │────>│ 6. Stream    │────>│ 7. Execute   │────>│ 8. Persist   │          │ │ ║  │
│  ║  │  │    │    History   │     │    Request   │     │    Tools     │     │    Result    │          │ │ ║  │
│  ║  │  │    │              │     │              │     │              │     │              │          │ │ ║  │
│  ║  │  │    │ SessionMgr   │     │ pi-ai lib    │     │ bash/memory  │     │ JSONL append │          │ │ ║  │
│  ║  │  │    │ history lim  │     │ delta events │     │ message/web  │     │ mark success │          │ │ ║  │
│  ║  │  │    └──────────────┘     └──────────────┘     └──────────────┘     └──────────────┘          │ │ ║  │
│  ║  │  └─────────────────────────────────────────────────────────────────────────────────────────────┘ │ ║  │
│  ║  │                                                                                                   │ ║  │
│  ║  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────┐  │ ║  │
│  ║  │  │    Tool System      │  │  Streaming Handler  │  │   Auth Profiles     │  │ Session Manager │  │ ║  │
│  ║  │  │  ┌───────────────┐  │  │  ┌───────────────┐  │  │  ┌───────────────┐  │  │  ┌───────────┐  │  │ ║  │
│  ║  │  │  │ createTools() │  │  │  │ subscribePI() │  │  │  │ resolveOrder()│  │  │  │ .jsonl    │  │  │ ║  │
│  ║  │  │  │ policyFilter  │  │  │  │ eventHandler  │  │  │  │ filterCooldown│  │  │  │ writeLock │  │  │ ║  │
│  ║  │  │  │ bashExec      │  │  │  │ blockChunker  │  │  │  │ markFailure   │  │  │  │ compaction│  │  │ ║  │
│  ║  │  │  │ resultProc    │  │  │  │ deduplication │  │  │  │ calculateCD   │  │  │  │ histLimit │  │  │ ║  │
│  ║  │  │  └───────────────┘  │  │  └───────────────┘  │  │  └───────────────┘  │  │  └───────────┘  │  │ ║  │
│  ║  │  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘  └─────────────────┘  │ ║  │
│  ║  └──────────────────────────────────────────────────────────────────────────────────────────────────┘ ║  │
│  ║                                              │                                                        ║  │
│  ╚══════════════════════════════════════════════╪════════════════════════════════════════════════════════╝  │
│                                                 │                                                            │
│                                                 ▼                                                            │
│  ╔═══════════════════════════════════════════════════════════════════════════════════════════════════════╗  │
│  ║                       5. INFRASTRUCTURE LAYER (基础设施层) - 纯工具箱                                   ║  │
│  ╠═══════════════════════════════════════════════════════════════════════════════════════════════════════╣  │
│  ║  被上层调用，从不调用上层 (Servant Pattern)                                                             ║  │
│  ║                                                                                                        ║  │
│  ║  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐   ║  │
│  ║  │   Command Queue     │  │   Config System     │  │   Health Monitor    │  │    Diagnostics      │   ║  │
│  ║  │  ┌───────────────┐  │  │  ┌───────────────┐  │  │  ┌───────────────┐  │  │  ┌───────────────┐  │   ║  │
│  ║  │  │ Main Lane     │  │  │  │ loadConfig()  │  │  │  │ buildSnapshot │  │  │  │ SubsystemLog  │  │   ║  │
│  ║  │  │ Cron Lane     │  │  │  │ hotReload()   │  │  │  │ healthCache   │  │  │  │ DiagEvents    │  │   ║  │
│  ║  │  │ Subagent Lane │  │  │  │ envSubstitute │  │  │  │ presenceVer   │  │  │  │ UsageTrack    │  │   ║  │
│  ║  │  │ Nested Lane   │  │  │  │ jsonSchema    │  │  │  │ broadcast     │  │  │  │ AgentEvents   │  │   ║  │
│  ║  │  └───────────────┘  │  │  └───────────────┘  │  │  └───────────────┘  │  │  └───────────────┘  │   ║  │
│  ║  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘   ║  │
│  ║                                                                                                        ║  │
│  ║  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐   ║  │
│  ║  │   System Services   │  │    Event System     │  │   Process Utils     │  │   Network Utils     │   ║  │
│  ║  │  ┌───────────────┐  │  │  ┌───────────────┐  │  │  ┌───────────────┐  │  │  ┌───────────────┐  │   ║  │
│  ║  │  │ gateway-lock  │  │  │  │ agent-events  │  │  │  │ exec          │  │  │  │ bonjour       │  │   ║  │
│  ║  │  │ ports         │  │  │  │ system-events │  │  │  │ spawn-utils   │  │  │  │ tailscale     │  │   ║  │
│  ║  │  │ env           │  │  │  │ heartbeat     │  │  │  │ archive       │  │  │  │ ssh-tunnel    │  │   ║  │
│  ║  │  │ machine-name  │  │  │  │               │  │  │  │               │  │  │  │ fetch         │  │   ║  │
│  ║  │  └───────────────┘  │  │  └───────────────┘  │  │  └───────────────┘  │  │  └───────────────┘  │   ║  │
│  ║  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘   ║  │
│  ║                                                                                                        ║  │
│  ╚════════════════════════════════════════════════════════════════════════════════════════════════════════╝  │
│                                                                                                              │
│  ╔═══════════════════════════════════════════════════════════════════════════════════════════════════════╗  │
│  ║                                  6. EXTERNAL SERVICES (外部服务)                                       ║  │
│  ╠═══════════════════════════════════════════════════════════════════════════════════════════════════════╣  │
│  ║                                                                                                        ║  │
│  ║   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 ║  │
│  ║   │  Anthropic  │  │   Google    │  │   OpenAI    │  │   GitHub    │  │   Other     │                 ║  │
│  ║   │  Claude API │  │  Gemini API │  │  GPT API    │  │  Copilot    │  │  Providers  │                 ║  │
│  ║   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘                 ║  │
│  ║                                                                                                        ║  │
│  ╚════════════════════════════════════════════════════════════════════════════════════════════════════════╝  │
│                                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 1.2 端到端数据流（请求生命周期）

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                          请求生命周期数据流                                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────┐
  │ User sends  │
  │ message via │
  │ Telegram    │
  └──────┬──────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ STEP 1: Channel Reception                                                                               │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ Grammy SDK → bot.on("message") → getTelegramSequentialKey() → createTelegramMessageProcessor()     │ │
  │ │                                                                                                      │ │
  │ │ Input:  Telegram Update { message, chat, from }                                                     │ │
  │ │ Output: MessageContext { body, from, to, provider: "telegram", chatId, ... }                        │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ STEP 2: Preflight & Routing                                                                             │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ preflightTelegramMessage() → resolveAgentRoute() → generateSessionKey()                             │ │
  │ │                                                                                                      │ │
  │ │ Checks:   allowlist, mention requirements, bot self-check                                           │ │
  │ │ Routing:  binding.peer > binding.guild > binding.account > binding.channel > default               │ │
  │ │ Output:   ResolvedRoute { agentId, sessionKey: "agent:default:telegram:dm:123456789" }             │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ STEP 3: Inbound Debouncing & Dispatch                                                                   │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ createInboundDebouncer() → dispatchInboundMessage() → dispatchReplyFromConfig()                     │ │
  │ │                                                                                                      │ │
  │ │ Debounce: Merge rapid messages (300ms window), skip for control commands                            │ │
  │ │ Dispatch: Record diagnostic event, set typing indicator                                              │ │
  │ │ Output:   Merged message ready for agent processing                                                  │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ STEP 4: Command Queue Enqueue                                                                           │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ enqueueCommandInLane(Main, task) → check activeCount vs maxConcurrent                               │ │
  │ │                                                                                                      │ │
  │ │ Lane:     Main (serial execution for message processing)                                            │ │
  │ │ Wait:     If queue full, wait with exponential backoff                                              │ │
  │ │ Execute:  When slot available, increment activeCount and run                                         │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ STEP 5: Agent Initialization                                                                            │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ getReplyFromConfig() → runPreparedReply() → runReplyAgent()                                         │ │
  │ │                                                                                                      │ │
  │ │ Init:     resolveSessionAgentId(), resolveDefaultModel(), ensureAgentWorkspace()                    │ │
  │ │ Directives: Parse @model, /think, /verbose from message                                              │ │
  │ │ Output:   PreparedReply { model, thinkLevel, verboseLevel, ... }                                    │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ STEP 6: Auth Profile Resolution                                                                         │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ resolveAuthProfileOrder() → filterValidProfiles() → getApiKeyForModel()                             │ │
  │ │                                                                                                      │ │
  │ │ Load:     ~/.clawdbot/credentials/<provider>.json                                                   │ │
  │ │ Filter:   Exclude cooldown profiles (errorCount > 0, cooldownUntil > now)                           │ │
  │ │ Priority: user > agent config > lastGood > lastUsed                                                  │ │
  │ │ Output:   { apiKey, profileId, authMode }                                                            │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ STEP 7: Session Lock & History                                                                          │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ acquireSessionWriteLock() → SessionManager.open() → limitHistoryTurns()                             │ │
  │ │                                                                                                      │ │
  │ │ Lock:     Exclusive file lock on <session>.jsonl.lock (10s timeout, 30m stale check)               │ │
  │ │ Load:     Parse JSONL, rebuild message history                                                       │ │
  │ │ Limit:    Apply dmHistoryLimit if configured (keep last N user turns)                               │ │
  │ │ Output:   SessionManager with messages[], tools ready                                                │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ STEP 8: Tool Creation & Policy                                                                          │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ createClawdbotCodingTools() → applyToolPolicyPipeline() → normalizeToolParameters()                 │ │
  │ │                                                                                                      │ │
  │ │ Create:   Built-in (exec, read, write) + Channel (message, telegram_*) + Custom                     │ │
  │ │ Pipeline: profile → provider → global → agent → group → sandbox → subagent                          │ │
  │ │ Normalize: JSON Schema, Claude compatibility patches                                                 │ │
  │ │ Output:   Tool[] array ready for LLM                                                                 │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ STEP 9: LLM Stream Request                                                                              │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ runEmbeddedAttempt() → streamSimple() (pi-ai) → Provider API                                        │ │
  │ │                                                                                                      │ │
  │ │ Request:  { messages, tools, model, stream: true }                                                  │ │
  │ │ Provider: Anthropic Claude / Google Gemini / OpenAI GPT / GitHub Copilot                            │ │
  │ │ Response: Server-Sent Events (delta stream)                                                          │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ STEP 10: Streaming Event Processing                                                                     │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ subscribeEmbeddedPiSession() → eventHandler.dispatch() → state machine updates                      │ │
  │ │                                                                                                      │ │
  │ │ Events:   agent_start → message_start → message_update(loop) → message_end                          │ │
  │ │           → tool_execution_start → tool_execution_end → agent_end                                   │ │
  │ │ State:    assistantTexts[], toolMetas[], blockBuffer, blockState { thinking, final }                │ │
  │ │ Process:  Delta accumulation, <think>/<final> tag filtering, block chunking                         │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ STEP 11: Tool Execution (if tool_use)                                                                   │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ handleToolExecutionStart() → execute tool → handleToolExecutionEnd()                                │ │
  │ │                                                                                                      │ │
  │ │ Bash:     Security check → environment setup → spawn process → capture output → truncate result     │ │
  │ │ Message:  Track pendingMessagingTexts → on success: commit to sentTexts → deduplication check       │ │
  │ │ Result:   Submit tool result back to LLM for next iteration                                          │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ STEP 12: Response Finalization                                                                          │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ finalizeAssistantTexts() → buildReplyPayloads() → persist to session                                │ │
  │ │                                                                                                      │ │
  │ │ Finalize: Strip block tags, merge text blocks, apply reasoning filter                                │ │
  │ │ Payloads: Convert to ReplyPayload[] { text, mediaUrl, replyToId, isError }                          │ │
  │ │ Persist:  Append to JSONL, release write lock, mark profile success                                  │ │
  │ │ Output:   EmbeddedPiRunResult { payloads, meta, didSendViaMessagingTool }                            │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ STEP 13: Reply Delivery                                                                                 │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ createReplyDispatcher() → dispatchTelegramMessage() → deliverReplies() → Telegram Bot API           │ │
  │ │                                                                                                      │ │
  │ │ Chunking: Split long messages (4096 char limit for Telegram)                                        │ │
  │ │ TTS:      Optional text-to-speech conversion                                                         │ │
  │ │ Reactions: Remove typing indicator, add completion reaction if configured                            │ │
  │ │ Output:   Message delivered to user                                                                  │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌─────────────┐
  │ User sees   │
  │ reply in    │
  │ Telegram    │
  └─────────────┘
```

---

## 1.3 组件依赖关系图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                          组件依赖关系图                                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

                                    ┌─────────────────────────┐
                                    │    Channel Plugins      │
                                    │  (Telegram/Discord/...) │
                                    └───────────┬─────────────┘
                                                │
                                                │ uses
                                                ▼
┌─────────────────────────┐           ┌─────────────────────────┐           ┌─────────────────────────┐
│      Config System      │◄──────────│      Routing Layer      │──────────>│     Command Queue       │
│  ┌───────────────────┐  │  reads    │  ┌───────────────────┐  │  enqueues │  ┌───────────────────┐  │
│  │ loadConfig()      │  │           │  │ resolveAgentRoute │  │           │  │ enqueueInLane()   │  │
│  │ hotReload()       │  │           │  │ generateSessionKey│  │           │  │ Main/Cron/Subagent│  │
│  └───────────────────┘  │           │  └───────────────────┘  │           │  └───────────────────┘  │
└───────────┬─────────────┘           └───────────┬─────────────┘           └───────────┬─────────────┘
            │                                     │                                     │
            │ configures                          │ routes to                           │ schedules
            ▼                                     ▼                                     ▼
┌───────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                         Agent Runtime                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                    runEmbeddedPiAgent()                                              │  │
│  │                                                                                                      │  │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐           │  │
│  │  │  Auth Profiles  │───>│ Session Manager │───>│  Tool System    │───>│ Stream Handler  │           │  │
│  │  │                 │    │                 │    │                 │    │                 │           │  │
│  │  │ getApiKey()     │    │ acquireLock()   │    │ createTools()   │    │ subscribe()     │           │  │
│  │  │ markFailure()   │    │ loadHistory()   │    │ policyFilter()  │    │ eventHandler()  │           │  │
│  │  │ calculateCD()   │    │ persist()       │    │ executeTools()  │    │ blockChunk()    │           │  │
│  │  └────────┬────────┘    └────────┬────────┘    └────────┬────────┘    └────────┬────────┘           │  │
│  │           │                      │                      │                      │                    │  │
│  │           │                      │                      │                      │                    │  │
│  │           ▼                      ▼                      ▼                      ▼                    │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │  │                                 Shared Dependencies                                          │   │  │
│  │  │                                                                                              │   │  │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │   │  │
│  │  │  │ pi-ai lib   │  │ File System │  │ Process Mgr │  │ Diagnostics │  │ SubsystemLog│        │   │  │
│  │  │  │ (LLM calls) │  │ (JSONL I/O) │  │ (bash exec) │  │ (events)    │  │ (logging)   │        │   │  │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │   │  │
│  │  └─────────────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────────────────────────────────────────────────────┘
            │
            │ returns
            ▼
┌─────────────────────────┐           ┌─────────────────────────┐           ┌─────────────────────────┐
│    Reply Dispatcher     │──────────>│     Channel Send        │──────────>│   External APIs         │
│  ┌───────────────────┐  │  sends    │  ┌───────────────────┐  │  calls    │  ┌───────────────────┐  │
│  │ buildPayloads()   │  │           │  │ deliverReplies()  │  │           │  │ Telegram Bot API  │  │
│  │ chunkMessages()   │  │           │  │ chunkForChannel() │  │           │  │ Discord API       │  │
│  └───────────────────┘  │           │  └───────────────────┘  │           │  │ Slack API         │  │
└─────────────────────────┘           └─────────────────────────┘           └─────────────────────────┘
```

---

# 第二部分：Gateway Layer 详细图

## 2.1 Gateway 协议和通信

```
┌─────────────────────────────────────────────────────────────────┐
│                  Gateway Protocol & Communication                │
├─────────────────────────────────────────────────────────────────┤
│  Protocol Frames (协议帧)                                       │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ RequestFrame:  { method, params, idempotencyKey }          │ │
│  │ ResponseFrame: { ok, payload, error }                      │ │
│  │ EventFrame:    { event, payload }                          │ │
│  │ HelloOk:       { version, caps, permissions }              │ │
│  └────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  Server Architecture                                            │
│                                                                  │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │ HTTP Server │    │ WebSocket   │    │ Node        │         │
│  │ (Hono)      │    │ Handler     │    │ Registry    │         │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘         │
│         │                  │                  │                 │
│         └────────────┬─────┴──────────────────┘                 │
│                      │                                          │
│              ┌───────┴───────┐                                  │
│              │ GatewayRequest │                                 │
│              │ Handlers       │                                 │
│              │ (40+ methods)  │                                 │
│              └───────────────┘                                  │
├─────────────────────────────────────────────────────────────────┤
│  HTTP Endpoints                                                 │
│  /control-ui    → Control UI (Browser)                         │
│  /v1/chat/*     → OpenAI Chat Completions API                  │
│  /responses/*   → Open Responses API                           │
│  /hooks/*       → Webhooks (Slack, etc.)                       │
│  /a2ui/*        → Canvas Host                                  │
│  /tools/invoke  → Direct tool invocation                       │
├─────────────────────────────────────────────────────────────────┤
│  Client Communication                                           │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ GatewayClient (WebSocket)                                  │ │
│  │ ├── Pending requests: Map<id, {resolve, reject, timer}>   │ │
│  │ ├── Backoff/reconnect: exponential with jitter            │ │
│  │ ├── Stall detection: lastTick + 30s interval              │ │
│  │ └── Sequence numbering: lastSeq for ordering              │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### Gateway 关键概念

| 概念 | 说明 |
|------|------|
| **RequestFrame** | 支持幂等键 (`idempotencyKey`)，防止重复请求 |
| **Node Registry** | 管理移动设备/节点连接，支持 RPC 调用和广播 |
| **Stall Detection** | 30 秒无响应检测，触发重连 |
| **Backoff/Reconnect** | 指数退避 + jitter，防止惊群效应 |

## 2.2 Channel 管理

```
┌─────────────────────────────────────────────────────────────────┐
│                     Channel Manager                              │
├─────────────────────────────────────────────────────────────────┤
│  Channel Lifecycle                                              │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ start() → activate SDK → register handlers → ready         │ │
│  │ stop()  → cleanup → disconnect → remove from registry      │ │
│  │ restart() → stop() → start() (with backoff)                │ │
│  └────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  Per-Channel Components                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  Runtime State  │  │  AbortController│  │  Health Status  │ │
│  │  • connected    │  │  • signal       │  │  • lastPing     │ │
│  │  • authenticated│  │  • abort()      │  │  • errorCount   │ │
│  │  • botInfo      │  │                 │  │  • uptime       │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  Channel Plugin Interface                                       │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ activate(config, deps) → Promise<ChannelRuntime>           │ │
│  │ deactivate()           → Promise<void>                     │ │
│  │ getSnapshot()          → ChannelSnapshot                   │ │
│  │ sendMessage(payload)   → Promise<MessageResult>            │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

---

# 第三部分：Agents Layer 详细图

## 3.1 工具系统内部结构

```
┌─────────────────────────────────────────────────────────────────┐
│                    Tool System Architecture                      │
├─────────────────────────────────────────────────────────────────┤
│  Tool Registration (工具注册)                                   │
│  ├── createClawdbotCodingTools() - 工具创建入口                │
│  ├── Built-in Tools (exec, read, write, edit, ...)            │
│  ├── Channel Tools (message, telegram_*, discord_*, ...)      │
│  └── Custom Tools (via plugins)                                │
├─────────────────────────────────────────────────────────────────┤
│  Tool Policy Pipeline (策略过滤链)                              │
│  profilePolicy → providerPolicy → globalPolicy                 │
│       → agentPolicy → groupPolicy → sandboxPolicy → subagentPolicy
├─────────────────────────────────────────────────────────────────┤
│  Tool Execution (工具执行)                                      │
│  ├── Bash Execution Pipeline (安全检查→环境→进程→结果)        │
│  ├── Tool Result Processing (截断、清理、错误处理)             │
│  └── Messaging Tool Deduplication (消息工具去重)               │
└─────────────────────────────────────────────────────────────────┘
```

### 工具系统详细流程图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                   Tool System Detailed Flow                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────────────────────┐
                              │   createClawdbotCodingTools()   │
                              │         工具创建入口            │
                              └───────────────┬─────────────────┘
                                              │
              ┌───────────────────────────────┼───────────────────────────────┐
              │                               │                               │
              ▼                               ▼                               ▼
   ┌─────────────────────┐       ┌─────────────────────┐       ┌─────────────────────┐
   │   Built-in Tools    │       │   Channel Tools     │       │   Custom Tools      │
   │  ┌───────────────┐  │       │  ┌───────────────┐  │       │  ┌───────────────┐  │
   │  │ exec (bash)   │  │       │  │ message       │  │       │  │ Plugin tools  │  │
   │  │ read          │  │       │  │ telegram_*    │  │       │  │ MCP tools     │  │
   │  │ write         │  │       │  │ discord_*     │  │       │  │ Custom exec   │  │
   │  │ edit          │  │       │  │ slack_*       │  │       │  └───────────────┘  │
   │  │ glob          │  │       │  │ whatsapp_*    │  │       └─────────────────────┘
   │  │ grep          │  │       │  └───────────────┘  │
   │  │ memory_*      │  │       └─────────────────────┘
   │  │ web_*         │  │
   │  └───────────────┘  │
   └─────────────────────┘
              │                               │                               │
              └───────────────────────────────┼───────────────────────────────┘
                                              │
                                              ▼
                              ┌─────────────────────────────────┐
                              │   applyToolPolicyPipeline()     │
                              │         策略过滤管道            │
                              └───────────────┬─────────────────┘
                                              │
    ┌─────────────────────────────────────────┼─────────────────────────────────────────┐
    │                                         │                                         │
    ▼                                         ▼                                         ▼
┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐
│ profile    │─>│ provider   │─>│  global    │─>│  agent     │─>│  group     │─>│ sandbox    │
│ Policy     │  │ Policy     │  │  Policy    │  │  Policy    │  │  Policy    │  │ Policy     │
│            │  │            │  │            │  │            │  │            │  │            │
│ 用户配置   │  │ 提供商限制 │  │ 全局规则   │  │ Agent规则  │  │ 群组规则   │  │ 沙箱限制   │
└────────────┘  └────────────┘  └────────────┘  └────────────┘  └────────────┘  └────────────┘
                                              │
                                              ▼
                              ┌─────────────────────────────────┐
                              │   normalizeToolParameters()     │
                              │     JSON Schema 标准化          │
                              └───────────────┬─────────────────┘
                                              │
                                              ▼
                              ┌─────────────────────────────────┐
                              │      Tool[] ready for LLM       │
                              └─────────────────────────────────┘
```

### Bash 执行管道详细图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                  Bash Execution Pipeline                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

  ┌──────────────────┐
  │ LLM requests     │
  │ exec tool        │
  └────────┬─────────┘
           │
           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐
  │ PHASE 1: Security Check                                                                     │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ - Check sandbox mode (restrictive/permissive)                                           │ │
  │ │ - Validate command against blocklist                                                    │ │
  │ │ - Check for dangerous patterns (rm -rf /, sudo, etc.)                                  │ │
  │ │ - Verify working directory permissions                                                  │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────┘
           │
           ▼ Pass
  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐
  │ PHASE 2: Environment Setup                                                                  │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ - Set working directory (cwd)                                                           │ │
  │ │ - Apply environment variables from config                                               │ │
  │ │ - Set timeout limits                                                                    │ │
  │ │ - Configure output capture (stdout/stderr)                                              │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────┘
           │
           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐
  │ PHASE 3: Process Spawn                                                                      │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ - spawn('bash', ['-c', command])                                                        │ │
  │ │ - Attach abort signal listener                                                          │ │
  │ │ - Start timeout timer                                                                   │ │
  │ │ - Stream stdout/stderr to buffers                                                       │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────┘
           │
           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐
  │ PHASE 4: Result Processing                                                                  │
  │ ┌─────────────────────────────────────────────────────────────────────────────────────────┐ │
  │ │ - Capture exit code                                                                     │ │
  │ │ - Combine stdout + stderr                                                               │ │
  │ │ - Truncate output if > maxOutputLength (default 100KB)                                 │ │
  │ │ - Format result: { stdout, stderr, exitCode, truncated }                               │ │
  │ └─────────────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────┘
           │
           ▼
  ┌──────────────────┐
  │ Return tool      │
  │ result to LLM    │
  └──────────────────┘
```

### 工具系统关键概念

| 概念 | 说明 |
|------|------|
| **Tool Policy Pipeline** | 多层过滤器，按优先级逐层过滤可用工具。每层可以 allow/deny/modify 工具 |
| **Bash Execution Pipeline** | 命令注入防护 → 环境变量设置 → 进程管理 → 结果清理 |
| **Messaging Tool Deduplication** | 归一化文本比较，避免重复发送相同消息。使用 `normalizeText()` 函数比较 |
| **Tool Result Truncation** | 防止超大输出占用过多 token，默认 100KB 限制 |

---

## 3.2 流式事件状态机

```
┌─────────────────────────────────────────────────────────────────┐
│              Streaming Event State Machine                       │
├─────────────────────────────────────────────────────────────────┤
│  EmbeddedPiSubscribeState (状态结构)                            │
│  {                                                               │
│    assistantTexts: []           # 累积的助手文本块              │
│    toolMetas: []                # 工具调用元数据                │
│    blockBuffer: ""              # 待发送块缓冲                  │
│    blockState: {                                                │
│      thinking: boolean          # <think> 标签状态              │
│      final: boolean             # <final> 标签状态              │
│      inlineCode: {...}          # 代码块跨度追踪                │
│    }                                                            │
│    compactionInFlight: boolean  # 压缩操作中                    │
│    messagingToolSentTexts: []   # 已发送消息追踪                │
│  }                                                               │
├─────────────────────────────────────────────────────────────────┤
│  Event Flow (事件流转)                                          │
│                                                                  │
│  agent_start ──→ message_start ──→ message_update (循环)       │
│       │              │                    │                     │
│       │              │              ┌─────┴─────┐               │
│       │              │              │           │               │
│       │              │         text_delta  tool_use_delta       │
│       │              │              │           │               │
│       │              │              └─────┬─────┘               │
│       │              │                    │                     │
│       │         message_end ←─────────────┘                     │
│       │              │                                          │
│       │    tool_execution_start ──→ tool_execution_end         │
│       │              │                                          │
│       └───── auto_compaction_start ──→ auto_compaction_end     │
│                      │                                          │
│                 agent_end                                       │
└─────────────────────────────────────────────────────────────────┘
```

### 流式事件详细状态机图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              Streaming Event State Machine                                       │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

                                    ┌─────────────────┐
                                    │  IDLE / START   │
                                    └────────┬────────┘
                                             │
                                             │ agent_start
                                             ▼
                              ┌──────────────────────────────┐
                              │      AGENT_RUNNING           │
                              │  ┌────────────────────────┐  │
                              │  │ Initialize state:      │  │
                              │  │ - assistantTexts = []  │  │
                              │  │ - toolMetas = []       │  │
                              │  │ - blockBuffer = ""     │  │
                              │  └────────────────────────┘  │
                              └──────────────┬───────────────┘
                                             │
                                             │ message_start
                                             ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                   MESSAGE_STREAMING                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                                                                                              ││
│  │    ┌──────────────┐         ┌──────────────┐         ┌──────────────┐                       ││
│  │    │ text_delta   │         │tool_use_delta│         │ message_end  │                       ││
│  │    └──────┬───────┘         └──────┬───────┘         └──────┬───────┘                       ││
│  │           │                        │                        │                               ││
│  │           ▼                        ▼                        ▼                               ││
│  │  ┌────────────────┐      ┌────────────────┐      ┌────────────────┐                         ││
│  │  │ Process Delta  │      │ Accumulate     │      │ Finalize       │                         ││
│  │  │                │      │ Tool Input     │      │ Message        │                         ││
│  │  │ - Parse tags   │      │                │      │                │                         ││
│  │  │ - Filter think │      │ - toolId       │      │ - Strip tags   │                         ││
│  │  │ - Accumulate   │      │ - toolName     │      │ - Merge blocks │                         ││
│  │  │ - Chunk buffer │      │ - input JSON   │      │ - Save to state│                         ││
│  │  └────────────────┘      └────────────────┘      └────────────────┘                         ││
│  │           │                        │                        │                               ││
│  │           └────────────────────────┴────────────────────────┘                               ││
│  │                                    │                                                        ││
│  │                          (loop until message_end)                                           ││
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                             │
                                             │ message_end (with tool_use)
                                             ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                   TOOL_EXECUTION                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                                                                                              ││
│  │  tool_execution_start                                                                        ││
│  │         │                                                                                    ││
│  │         ▼                                                                                    ││
│  │  ┌────────────────────────────────────────────────────────────────────────────────────────┐ ││
│  │  │ Execute Tool                                                                            │ ││
│  │  │                                                                                         │ ││
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐              │ ││
│  │  │  │ Messaging?  │    │   Bash?     │    │   Read?     │    │   Other?    │              │ ││
│  │  │  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘              │ ││
│  │  │         │                  │                  │                  │                     │ ││
│  │  │         ▼                  ▼                  ▼                  ▼                     │ ││
│  │  │  Track pending      Security check      Read file         Execute                     │ ││
│  │  │  message text       + spawn process     content           handler                     │ ││
│  │  │                                                                                         │ ││
│  │  └────────────────────────────────────────────────────────────────────────────────────────┘ ││
│  │         │                                                                                    ││
│  │         ▼                                                                                    ││
│  │  tool_execution_end                                                                          ││
│  │         │                                                                                    ││
│  │         ▼                                                                                    ││
│  │  ┌────────────────────────────────────────────────────────────────────────────────────────┐ ││
│  │  │ On Success (messaging tool):                                                            │ ││
│  │  │ - Move pendingText → sentTexts                                                          │ ││
│  │  │ - Deduplication check for final reply                                                   │ ││
│  │  └────────────────────────────────────────────────────────────────────────────────────────┘ ││
│  │                                                                                              ││
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                             │
                                             │ (back to message_start for next turn)
                                             │ OR
                                             │ agent_end
                                             ▼
                              ┌──────────────────────────────┐
                              │         COMPLETED            │
                              │  ┌────────────────────────┐  │
                              │  │ Finalize:              │  │
                              │  │ - Build reply payloads │  │
                              │  │ - Persist to session   │  │
                              │  │ - Mark profile success │  │
                              │  └────────────────────────┘  │
                              └──────────────────────────────┘
```

### Delta 处理和标签过滤

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              Delta Processing & Tag Filtering                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

  Input: "Let me <think>consider the options...</think> The answer is 42."
         │
         ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐
  │ Tag State Machine                                                                           │
  │                                                                                              │
  │  ┌──────────┐  "<think>"   ┌──────────┐  "</think>"  ┌──────────┐                          │
  │  │ NORMAL   │─────────────>│ THINKING │─────────────>│ NORMAL   │                          │
  │  │          │              │ (filter) │              │          │                          │
  │  └──────────┘              └──────────┘              └──────────┘                          │
  │       │                                                   │                                │
  │       │ "<final>"                                         │                                │
  │       ▼                                                   │                                │
  │  ┌──────────┐  "</final>"                                 │                                │
  │  │  FINAL   │─────────────────────────────────────────────┘                                │
  │  │ (keep)   │                                                                              │
  │  └──────────┘                                                                              │
  │                                                                                              │
  └─────────────────────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
  Output: "Let me  The answer is 42."  (thinking content filtered)
```

### 流式事件关键概念

| 概念 | 说明 |
|------|------|
| **Delta Processing** | 增量文本累积，支持 `<think>`/`<final>` 标签过滤 |
| **Block Chunking** | 按 sentence/paragraph/text_end 模式分块发送 |
| **Compaction Retry** | 上下文溢出时自动触发压缩，支持多次重试 |
| **Message Deduplication** | 比较 `messagingToolSentTexts` 避免重复发送相同内容 |

---

## 3.3 认证轮换机制

```
┌─────────────────────────────────────────────────────────────────┐
│                 Auth Profile Rotation                            │
├─────────────────────────────────────────────────────────────────┤
│  Profile Store (认证存储)                                       │
│  ~/.clawdbot/credentials/<provider>.json                        │
│  {                                                               │
│    profiles: [                                                  │
│      { id, type: "api_key"|"token"|"oauth", key/token, ... }   │
│    ],                                                           │
│    usage: {                                                     │
│      "<profileId>": {                                           │
│        lastUsed, cooldownUntil, disabledUntil,                 │
│        errorCount, failureCounts: { auth, rate_limit, ... }    │
│      }                                                          │
│    }                                                            │
│  }                                                               │
├─────────────────────────────────────────────────────────────────┤
│  Rotation Algorithm (轮换算法)                                  │
│                                                                  │
│  1. 过滤有效 profiles (非冷却、非禁用)                         │
│  2. 排序优先级:                                                 │
│     - user 指定 > agent 配置 > lastGood > lastUsed             │
│  3. 尝试执行，失败时:                                          │
│     - markAuthProfileFailure(reason)                           │
│     - calculateCooldownMs(errorCount)                          │
│       60s → 5min → 25min → 1h (指数退避)                       │
│  4. 全部失败 → FailoverError → 选择 fallback 模型              │
└─────────────────────────────────────────────────────────────────┘
```

### Cooldown 计算逻辑

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              Cooldown Calculation                                                │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

  calculateCooldownMs(errorCount):

  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐
  │                                                                                              │
  │  Formula: min(1 hour, 60s * 5^(errorCount - 1))                                            │
  │                                                                                              │
  │  ┌───────────┬─────────────────┬────────────────────────────────────────────────┐          │
  │  │ errorCount│ Cooldown        │ Visual                                         │          │
  │  ├───────────┼─────────────────┼────────────────────────────────────────────────┤          │
  │  │ 1         │ 60s (1min)      │ ====                                           │          │
  │  │ 2         │ 300s (5min)     │ ====================                           │          │
  │  │ 3         │ 1500s (25min)   │ ============================================   │          │
  │  │ 4+        │ 3600s (1hr max) │ ========================================================  │
  │  └───────────┴─────────────────┴────────────────────────────────────────────────┘          │
  │                                                                                              │
  └─────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 认证轮换关键概念

| 概念 | 说明 |
|------|------|
| **Cooldown Calculation** | 指数退避 `min(1h, 60s * 5^(errorCount-1))` |
| **Failure Categories** | auth/rate_limit/billing/timeout/context_overflow |
| **Failover** | 所有 profile 失败时切换到 fallback 模型 |
| **Profile Priority** | user > agent config > lastGood > lastUsed |

---

## 3.4 会话管理

```
┌─────────────────────────────────────────────────────────────────┐
│                  Session Management                              │
├─────────────────────────────────────────────────────────────────┤
│  Session File Structure (会话文件)                              │
│  ~/.clawdbot/agents/<agentId>/sessions/<sessionKey>.jsonl       │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Line 1: { type: "session", id, cwd }                      │  │
│  │ Line 2: { type: "message", message: { role: "user" } }    │  │
│  │ Line 3: { type: "message", message: { role: "assistant" }}│  │
│  │ ...                                                        │  │
│  │ Line N: { type: "compaction", summary, keepFrom }         │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  Write Lock (写锁机制)                                          │
│  <session>.jsonl.lock: { pid, createdAt }                       │
│                                                                  │
│  acquire: exclusive file → wait/retry (10s) → stale check (30m)│
│  release: decrement count → delete lock file                    │
├─────────────────────────────────────────────────────────────────┤
│  Compaction (压缩)                                              │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 1. splitMessagesByTokenShare() - 按 token 均分          │   │
│  │ 2. summarizeInStages() - 分阶段摘要                      │   │
│  │ 3. mergePartialSummaries() - 合并部分摘要                │   │
│  │ 4. 附加: toolFailures + fileOperations                   │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 会话管理关键概念

| 概念 | 说明 |
|------|------|
| **JSONL Format** | 每行一个 JSON 对象，追加写入，支持增量读取 |
| **Write Lock** | 防止多进程并发写入，自动检测死锁 (30m stale threshold) |
| **History Limiting** | DM 会话可配置 `dmHistoryLimit` 保留最近 N 轮对话 |
| **Compaction** | 上下文溢出时自动触发，分阶段摘要 + 合并 |

---

# 第四部分：Infrastructure Layer 详细图

Infrastructure Layer 是纯工具箱层，提供支撑服务，被上层调用，从不调用上层（Servant Pattern）。

## 4.1 并发和队列机制

```
┌─────────────────────────────────────────────────────────────────┐
│                Lane-Based Command Queue                          │
├─────────────────────────────────────────────────────────────────┤
│  Lanes (命令车道)                                               │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Main     │ 默认，串行执行，用于主消息处理                │    │
│  │ Cron     │ 允许并行，用于后台定时任务                    │    │
│  │ Subagent │ 子代理执行，与主车道隔离                      │    │
│  │ Nested   │ 深度嵌套调用                                  │    │
│  └─────────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────────┤
│  Execution Flow                                                 │
│                                                                  │
│  enqueueCommandInLane(lane, task)                               │
│       │                                                         │
│       ▼                                                         │
│  activeCount < maxConcurrent?                                   │
│  │                                                              │
│  ├─ Yes → 立即执行, activeCount++                              │
│  │                                                              │
│  └─ No  → 入队等待                                             │
│             │                                                   │
│             ▼                                                   │
│       task 完成时:                                              │
│       activeCount--, 检查队列, 执行下一个                       │
└─────────────────────────────────────────────────────────────────┘
```

### Lane 隔离和用途

| Lane | maxConcurrent | 用途 |
|------|---------------|------|
| **Main** | 1 | 主消息处理，严格串行 |
| **Cron** | 5 | 后台定时任务，允许并行 |
| **Subagent** | 3 | 子代理执行，与主车道隔离 |
| **Nested** | 2 | 深度嵌套调用，限制并发 |

### 队列关键概念

| 概念 | 说明 |
|------|------|
| **Lane Isolation** | 不同类型任务隔离，避免相互阻塞 |
| **Backpressure** | 队列大小监控，防止内存溢出 |
| **Diagnostic Hooks** | `logLaneEnqueue`/`logLaneDequeue` 用于遥测 |
| **Warn Threshold** | `warnAfterMs` 超时后记录警告日志 |

---

## 4.2 配置和生命周期

```
┌─────────────────────────────────────────────────────────────────┐
│                 Config System & Lifecycle                        │
├─────────────────────────────────────────────────────────────────┤
│  Config Loading                                                 │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ parseConfigJson5()                                         │ │
│  │     ↓                                                      │ │
│  │ Environment Variable Substitution (${VAR})                 │ │
│  │     ↓                                                      │ │
│  │ JSON Schema Validation                                     │ │
│  │     ↓                                                      │ │
│  │ ClawdbotConfig Object                                      │ │
│  └────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  Gateway Startup Sequence                                       │
│                                                                  │
│  1. loadConfig()           - 加载配置文件                       │
│  2. loadGatewayPlugins()   - 加载插件                           │
│  3. createChannelManager() - 创建通道管理器                     │
│  4. startServer()          - 启动 HTTP/WS 服务                  │
│  5. launchSidecars():                                           │
│     ├─ Browser control server                                  │
│     ├─ Gmail watcher                                           │
│     └─ Plugin services                                         │
│  6. startChannels()        - 启动所有配置的通道                 │
│  7. HeartbeatRunner.start()- 启动心跳                           │
├─────────────────────────────────────────────────────────────────┤
│  Hot Reload                                                     │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ 1. File watcher on clawdbot.json                           │ │
│  │ 2. Detect change via hash comparison                       │ │
│  │ 3. Parse + validate new config                             │ │
│  │ 4. Per-subsystem reload handlers                           │ │
│  │ 5. Rollback on error                                       │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 配置系统关键概念

| 概念 | 说明 |
|------|------|
| **JSON5 Support** | 支持注释、尾逗号等 JSON5 语法，提升配置可读性 |
| **Environment Substitution** | `${VAR}` 在解析时替换为环境变量，支持默认值 |
| **Presence Version** | 增量状态推送，减少网络开销，客户端可跳过旧版本 |
| **Per-Subsystem Reload** | 各子系统独立处理配置变更，最小化重启影响 |

---

# 第五部分：时序图与关键文件

## 端到端详细时序图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                          端到端消息处理详细时序图                                                        │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

  Telegram        Channel         Routing        Command       Agent          Tools         Auth          Session       LLM
  Bot             Manager         Layer          Queue         Runtime        System        Profiles      Manager       Provider
    │                │               │              │              │              │             │             │            │
    │ 新消息        │               │              │              │              │             │             │            │
    │───────────────>│              │              │              │              │             │             │            │
    │                │              │              │              │              │             │             │            │
    │                │ preflight    │              │              │              │             │             │            │
    │                │ (allowlist)  │              │              │              │             │             │            │
    │                │──────────────>│             │              │              │             │             │            │
    │                │              │              │              │              │             │             │            │
    │                │              │ resolve      │              │              │             │             │            │
    │                │              │ AgentRoute   │              │              │             │             │            │
    │                │              │─────────────>│              │              │             │             │            │
    │                │              │              │              │              │             │             │            │
    │                │              │              │ enqueue      │              │             │             │            │
    │                │              │              │ (Main lane)  │              │             │             │            │
    │                │              │              │─────────────>│              │             │             │            │
    │                │              │              │              │              │             │             │            │
    │                │              │              │              │ create       │             │             │            │
    │                │              │              │              │ tools        │             │             │            │
    │                │              │              │              │─────────────>│             │             │            │
    │                │              │              │              │              │             │             │            │
    │                │              │              │              │ resolve      │             │             │            │
    │                │              │              │              │ profile      │             │             │            │
    │                │              │              │              │──────────────────────────>│             │            │
    │                │              │              │              │              │             │             │            │
    │                │              │              │              │ acquire      │             │             │            │
    │                │              │              │              │ write lock   │             │             │            │
    │                │              │              │              │────────────────────────────────────────>│            │
    │                │              │              │              │              │             │             │            │
    │                │              │              │              │ stream       │             │             │            │
    │                │              │              │              │ request      │             │             │            │
    │                │              │              │              │─────────────────────────────────────────────────────>│
    │                │              │              │              │              │             │             │            │
    │                │              │              │              │              │             │             │   delta    │
    │                │              │              │              │<─────────────────────────────────────────────────────│
    │                │              │              │              │              │             │             │            │
    │                │              │              │              │ execute tool │             │             │            │
    │                │              │              │              │─────────────>│             │             │            │
    │                │              │              │              │              │             │             │            │
    │                │              │              │              │ tool result  │             │             │            │
    │                │              │              │              │<─────────────│             │             │            │
    │                │              │              │              │              │             │             │            │
    │                │              │              │              │ submit       │             │             │            │
    │                │              │              │              │ result       │             │             │            │
    │                │              │              │              │─────────────────────────────────────────────────────>│
    │                │              │              │              │              │             │             │            │
    │                │              │              │              │              │             │             │  message   │
    │                │              │              │              │              │             │             │  _end      │
    │                │              │              │              │<─────────────────────────────────────────────────────│
    │                │              │              │              │              │             │             │            │
    │                │              │              │              │ persist      │             │             │            │
    │                │              │              │              │ to session   │             │             │            │
    │                │              │              │              │────────────────────────────────────────>│            │
    │                │              │              │              │              │             │             │            │
    │                │              │              │              │ mark profile │             │             │            │
    │                │              │              │              │ success      │             │             │            │
    │                │              │              │              │──────────────────────────>│             │            │
    │                │              │              │              │              │             │             │            │
    │                │              │ reply        │              │              │             │             │            │
    │                │              │ payload      │              │              │             │             │            │
    │                │<─────────────│              │              │              │             │             │            │
    │                │              │              │              │              │             │             │            │
    │ send message   │              │              │              │              │             │             │            │
    │<───────────────│              │              │              │              │             │             │            │
    │                │              │              │              │              │             │             │            │
```

---

## 简化时序图 (垂直布局)

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                  消息处理简化时序                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

  [1] User sends message via Telegram
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐
  │ CHANNEL RECEPTION                                                                           │
  │   Grammy SDK → bot.on("message") → MessageContext creation                                 │
  └─────────────────────────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐
  │ PREFLIGHT & ROUTING                                                                         │
  │   preflightTelegramMessage() → resolveAgentRoute() → generateSessionKey()                  │
  │   Output: ResolvedRoute { agentId, sessionKey }                                            │
  └─────────────────────────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐
  │ COMMAND QUEUE                                                                               │
  │   enqueueCommandInLane(Main, task)                                                         │
  │   Wait for slot → Execute when available                                                   │
  └─────────────────────────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐
  │ AGENT INITIALIZATION                                                                        │
  │   resolveAuthProfile() → acquireSessionLock() → loadHistory() → createTools()             │
  └─────────────────────────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐
  │ LLM STREAMING                                                                               │
  │   streamRequest() → process deltas → tool_use? → execute tools → submit result            │
  │                                                                                             │
  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
  │   │ Event Loop:                                                                          │   │
  │   │   message_start → message_update (text/tool) → message_end                          │   │
  │   │        ↓                    ↓                       ↓                               │   │
  │   │   [if tool_use] → tool_execution_start → execute → tool_execution_end               │   │
  │   │        ↓                                                                            │   │
  │   │   [loop until agent_end]                                                            │   │
  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │
  └─────────────────────────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐
  │ RESPONSE FINALIZATION                                                                       │
  │   finalizeResponse() → buildPayloads() → persist to JSONL → release lock                  │
  └─────────────────────────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐
  │ REPLY DELIVERY                                                                              │
  │   dispatchReply() → chunk messages → send via Telegram Bot API                             │
  └─────────────────────────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  [13] User sees reply in Telegram
```

---

## 关键文件清单

### Gateway Layer

| 文件 | 职责 |
|------|------|
| `src/gateway/server.impl.ts` | Gateway 主入口，服务器初始化和生命周期管理 |
| `src/gateway/server-http.ts` | HTTP 端点，API 路由和静态文件服务 |
| `src/gateway/server-ws-runtime.ts` | WebSocket 处理，实时通信和事件推送 |
| `src/gateway/node-registry.ts` | 节点注册，移动设备连接管理 |
| `src/gateway/channel-manager.ts` | Channel 管理，启停和运行时状态 |
| `src/gateway/config-reload.ts` | 热重载，配置变更检测和应用 |

### Agents Layer

| 文件 | 职责 |
|------|------|
| `src/agents/pi-embedded-runner/run.ts` | Agent 主运行入口，orchestrates 整个 agent 执行流程 |
| `src/agents/pi-embedded-subscribe.ts` | 流式事件订阅，处理 LLM 返回的 delta events |
| `src/agents/pi-tools.ts` | 工具系统核心，工具创建和策略过滤 |
| `src/agents/auth-profiles/order.ts` | 认证轮换逻辑，profile 排序和选择 |
| `src/agents/auth-profiles/usage.ts` | 冷却计算，错误追踪和退避策略 |
| `src/agents/session-write-lock.ts` | 会话写锁，防止并发写入冲突 |
| `src/agents/compaction.ts` | 压缩摘要，上下文溢出时的历史压缩 |

### Infrastructure Layer (纯工具箱)

| 文件 | 职责 |
|------|------|
| `src/process/command-queue.ts` | 命令队列，lane-based 并发控制 |
| `src/config/io.ts` | 配置加载，JSON5 解析和环境变量替换 |
| `src/infra/gateway-lock.ts` | Gateway 锁，防止多实例冲突 |
| `src/infra/ports.ts` | 端口管理，可用端口检测 |
| `src/infra/agent-events.ts` | Agent 事件，诊断和遥测 |
| `src/infra/fetch.ts` | HTTP 请求工具 |
| `src/infra/dedupe.ts` | 去重工具 |

### Routing & Channels

| 文件 | 职责 |
|------|------|
| `src/routing/resolve-route.ts` | 路由解析，agent binding 和 session key 生成 |
| `src/auto-reply/dispatch.ts` | 消息分发，入站消息 debounce 和 dispatch |
| `src/auto-reply/reply/get-reply.ts` | 获取回复，prepareReply 和 runReplyAgent |
| `src/telegram/bot-message-dispatch.ts` | Telegram 分发，Grammy SDK 集成 |

### Streaming & Events

| 文件 | 职责 |
|------|------|
| `src/agents/pi-embedded-subscribe.ts` | 事件订阅主入口 |
| `src/agents/stream/block-chunker.ts` | 块分割，按模式切分响应文本 |
| `src/agents/stream/tag-filter.ts` | 标签过滤，`<think>`/`<final>` 处理 |
| `src/agents/stream/delta-accumulator.ts` | Delta 累积，增量文本合并 |

### Tools System

| 文件 | 职责 |
|------|------|
| `src/agents/tools/bash-exec.ts` | Bash 执行，安全检查和进程管理 |
| `src/agents/tools/messaging.ts` | 消息工具，跨渠道消息发送 |
| `src/agents/tools/policy-pipeline.ts` | 策略管道，多层工具过滤 |
| `src/agents/tools/result-processor.ts` | 结果处理，截断和格式化 |

---

## 代码路径快速参考

```
消息入口 (Telegram 示例):
  src/telegram/bot-message-dispatch.ts:createTelegramMessageProcessor()
    → src/routing/resolve-route.ts:resolveAgentRoute()
    → src/auto-reply/dispatch.ts:dispatchInboundMessage()
    → src/auto-reply/reply/get-reply.ts:getReplyFromConfig()

Agent 执行:
  src/agents/pi-embedded-runner/run.ts:runEmbeddedPiAgent()
    → src/agents/auth-profiles/order.ts:resolveAuthProfileOrder()
    → src/agents/session-write-lock.ts:acquireSessionWriteLock()
    → src/agents/pi-tools.ts:createClawdbotCodingTools()
    → src/agents/pi-embedded-subscribe.ts:subscribeEmbeddedPiSession()

流式处理:
  src/agents/pi-embedded-subscribe.ts:subscribeEmbeddedPiSession()
    → handleMessageStart()
    → handleMessageUpdate() (text_delta / tool_use_delta)
    → handleMessageEnd()
    → handleToolExecutionStart()
    → handleToolExecutionEnd()
    → handleAgentEnd()

工具执行:
  src/agents/pi-tools.ts:executeToolHandler()
    → src/agents/tools/bash-exec.ts:executeBashCommand()
    → src/agents/tools/messaging.ts:sendMessage()
    → src/agents/tools/result-processor.ts:processToolResult()

Gateway 启动:
  src/gateway/server.impl.ts:startGateway()
    → src/config/io.ts:loadConfig()
    → src/gateway/server-http.ts:createHttpServer()
    → src/gateway/server-ws-runtime.ts:createWsHandler()
    → src/gateway/node-registry.ts:createNodeRegistry()
```
