# Clawdbot Architecture Diagram

> 团队内部参考 | 16:9 宽屏布局 | Agent Layer 为核心

---

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐  ┌───────────────────────┐ │
│  │                        ENTRY LAYER (入口层)                              │  │   INFRASTRUCTURE     │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐  │  │   (基础设施层)        │ │
│  │  │  Telegram    │  │   WeChat     │  │   Discord    │  │   Web UI    │  │  │                       │ │
│  │  │  ┌───────┐   │  │  ┌───────┐   │  │  ┌───────┐   │  │ ┌────────┐  │  │  │  ┌─────────────────┐ │ │
│  │  │  │  Bot  │   │  │  │  MP   │   │  │  │  Bot  │   │  │ │ Control│  │  │  │  │ Config Manager  │ │ │
│  │  │  └───────┘   │  │  └───────┘   │  │  └───────┘   │  │ │ Panel  │  │  │  │  │ (配置管理)       │ │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │ └────────┘  │  │  │  └─────────────────┘ │ │
│  │                                                         └─────────────┘  │  │                       │ │
│  └──────────────────────────────────────────┬──────────────────────────────┘  │  ┌─────────────────┐ │ │
│                                              │                                │  │ Media Processing│ │ │
│                                              ▼                                │  │ (媒体处理)       │ │ │
│  ┌─────────────────────────────────────────────────────────────────────────┐  │  └─────────────────┘ │ │
│  │                       GATEWAY LAYER (网关层)                             │  │                       │ │
│  │                                                                          │  │  ┌─────────────────┐ │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │  │  │ Memory Store    │ │ │
│  │  │                     连接模式 (Connection Modes)                  │    │  │  │ (存储引擎)       │ │ │
│  │  │                                                                  │    │  │  └─────────────────┘ │ │
│  │  │  ┌──────────────────────┐      ┌──────────────────────────────┐ │    │  │                       │ │
│  │  │  │     LOCAL MODE       │      │        REMOTE MODE           │ │    │  │  ┌─────────────────┐ │ │
│  │  │  │     (本地模式)        │      │        (远程模式)             │ │    │  │  │ Sessions Mgr    │ │ │
│  │  │  │                      │      │                              │ │    │  │  │ (会话管理)       │ │ │
│  │  │  │  宿主: 用户本机       │      │  宿主: 腾讯云VM / VPS        │ │    │  │  └─────────────────┘ │ │
│  │  │  │  (Mac/PC/Linux)     │      │                              │ │    │  │                       │ │
│  │  │  │                      │      │  部署: 直接安装 或 Docker    │ │    │  │  ┌─────────────────┐ │ │
│  │  │  │  端口: localhost     │      │  端口: 0.0.0.0:18789        │ │    │  │  │ Logging         │ │ │
│  │  │  │       :18789        │      │       (公网暴露)              │ │    │  │  │ (日志系统)       │ │ │
│  │  │  └──────────────────────┘      └──────────────────────────────┘ │    │  │  └─────────────────┘ │ │
│  │  │                                                                  │    │  │                       │ │
│  │  │  ┌────────────────────────────────────────────────────────────┐ │    │  │  ┌─────────────────┐ │ │
│  │  │  │                  TAILSCALE MODE (可选)                     │ │    │  │  │ Tool Sandbox    │ │ │
│  │  │  │  通过 Tailscale VPN 安全连接本地与远程节点                   │ │    │  │  │ (工具执行沙箱)   │ │ │
│  │  │  │  无需公网暴露端口，内网穿透                                  │ │    │  │  │ Docker 容器隔离  │ │ │
│  │  │  └────────────────────────────────────────────────────────────┘ │    │  │  │ 限制文件/进程    │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘    │  │  └─────────────────┘ │ │
│  │                                                                          │  │                       │ │
│  │                                                                          │  │  ┌─────────────────┐ │ │
│  │                                                                          │  │  │ Hooks System    │ │ │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐            │  │  │ (钩子系统)       │ │ │
│  │  │ WebSocket  │ │  HTTP API  │ │    Node    │ │ Cron Jobs  │            │  │  │  PreToolUse     │ │ │
│  │  │ Handlers   │ │  (REST)    │ │ Management │ │ (定时任务)  │            │  │  │  PostToolUse    │ │ │
│  │  │ (实时消息)  │ │ :18789    │ │ (设备管理)  │ │            │            │  │  │  Notification   │ │ │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘            │  │  └─────────────────┘ │ │
│  └──────────────────────────────────────┬──────────────────────────────────┘  │                       │ │
│                                          │                                    │  ┌─────────────────┐ │ │
│                                          ▼                                    │  │ Binaries Mgr    │ │ │
│  ╔══════════════════════════════════════════════════════════════════════════╗ │  │ (二进制管理)     │ │ │
│  ║                                                                          ║ │  └─────────────────┘ │ │
│  ║                        ★ AGENT LAYER (代理层) ★                          ║ │                       │ │
│  ║                           [ 架构核心 / Core ]                            ║ │         ▲             │ │
│  ║                                                                          ║ │         │             │ │
│  ║  ┌──────────────────┐ ┌──────────────────┐ ┌────────────────────────┐   ║ │    Servant Pattern   │ │
│  ║  │     Session      │ │      Memory      │ │   LLM Orchestration    │   ║ │    (单向依赖)         │ │
│  ║  │    (短期记忆)     │ │     (长期记忆)    │ │      (AI 调度)         │   ║ │         │             │ │
│  ║  │ ┌──────────────┐ │ │ ┌──────────────┐ │ │ ┌────────────────────┐ │   ║ │         │             │ │
│  ║  │ │ 对话上下文    │ │ │ │ 向量检索     │ │ │ │ Provider Router    │ │   ║ │         ▼             │ │
│  ║  │ │ 工具状态     │ │ │ │ 用户画像     │ │ │ │ Streaming Handler  │ │   ║ │                       │ │
│  ║  │ │ 临时变量     │ │ │ │ 历史摘要     │ │ │ │ Token Management   │ │   ║ │  所有层均可调用       │ │
│  ║  │ └──────────────┘ │ │ └──────────────┘ │ │ └────────────────────┘ │   ║ │  Infrastructure      │ │
│  ║  └──────────────────┘ └──────────────────┘ └────────────────────────┘   ║ │  但反向不依赖         │ │
│  ║                                                                          ║ │                       │ │
│  ║  ┌────────────────────────────────────────────────────────────────────┐ ║ │                       │ │
│  ║  │                         TOOLS (工具层)                              │ ║ │                       │ │
│  ║  │                                                                     │ ║ │                       │ │
│  ║  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌─────────────────────┐│ ║ │                       │ │
│  ║  │  │ File Ops  │ │  Browser  │ │   Shell   │ │    MCP Tools        ││ ║ │                       │ │
│  ║  │  │ (文件系统) │ │  (浏览器)  │ │ (代码执行) │ │  ┌───────────────┐ ││ ║ │                       │ │
│  ║  │  │  Read     │ │  Fetch    │ │  Bash     │ │  │ Calendar      │ ││ ║ │                       │ │
│  ║  │  │  Write    │ │  Search   │ │  Python   │ │  │ Email         │ ││ ║ │                       │ │
│  ║  │  │  Edit     │ │  Click    │ │  Node     │ │  │ Database      │ ││ ║ │                       │ │
│  ║  │  └───────────┘ └───────────┘ └───────────┘ │  │ Custom APIs   │ ││ ║ │                       │ │
│  ║  │                                            │  └───────────────┘ ││ ║ │                       │ │
│  ║  │  ┌──────────────────────────────────────────────────────────────┐│ ║ │                       │ │
│  ║  │  │                    Skills (技能系统)                          ││ ║ │                       │ │
│  ║  │  │  /commit  /review-pr  /test  /deploy  /doc-gen  ...         ││ ║ │                       │ │
│  ║  │  └──────────────────────────────────────────────────────────────┘│ ║ │                       │ │
│  ║  └────────────────────────────────────────────────────────────────────┘ ║ │                       │ │
│  ║                                                                          ║ │                       │ │
│  ╚══════════════════════════════════╤═══════════════════════════════════════╝ │                       │ │
│                                      │                                        └───────────────────────┘ │
│                                      ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                            EXTERNAL SERVICES (外部服务层)                                        │ │
│  │                                                                                                  │ │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐                │ │
│  │  │   Anthropic    │  │    OpenAI      │  │    Google      │  │    Deepgram    │                │ │
│  │  │    Claude      │  │     GPT        │  │    Gemini      │  │    (STT/TTS)   │                │ │
│  │  │  ┌──────────┐  │  │  ┌──────────┐  │  │  ┌──────────┐  │  │  ┌──────────┐  │                │ │
│  │  │  │ Opus 4.5 │  │  │  │ GPT-4o   │  │  │  │ 2.0 Flash│  │  │  │  Voice   │  │                │ │
│  │  │  │ Sonnet   │  │  │  │ o1       │  │  │  │ Pro      │  │  │  │  API     │  │                │ │
│  │  │  │ Haiku    │  │  │  │ o3       │  │  │  │ Ultra    │  │  │  └──────────┘  │                │ │
│  │  │  └──────────┘  │  │  └──────────┘  │  │  └──────────┘  │  │                │                │ │
│  │  └────────────────┘  └────────────────┘  └────────────────┘  └────────────────┘                │ │
│  │                                                                                                  │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Agentic Loop: AI ↔ 工具交互核心流程

**这是 Agent 的核心工作机制 - AI 不直接执行工具，而是输出"想要调用"的请求，由系统拦截执行**

### 三个典型场景并行示例

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    用户请求示例                                                  │
├───────────────────────────┬───────────────────────────┬─────────────────────────────────────────┤
│  场景 A: 代码执行          │  场景 B: 文件处理          │  场景 C: 浏览器操作                      │
│  "运行测试看看有没有问题"   │  "帮我改一下配置文件"       │  "打开 GitHub 看看这个 PR"              │
└───────────────────────────┴───────────────────────────┴─────────────────────────────────────────┘
                │                         │                              │
                ▼                         ▼                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  1. AI 分析意图                                                                                  │
│     AI 看到消息 + 可用工具列表                                                                    │
│     可用工具: [bash, read, write, edit, browser, glob, grep, ...]                               │
├───────────────────────────┬───────────────────────────┬─────────────────────────────────────────┤
│  识别: 需要执行命令        │  识别: 需要读取+编辑文件    │  识别: 需要打开网页                      │
└───────────────────────────┴───────────────────────────┴─────────────────────────────────────────┘
                │                         │                              │
                ▼                         ▼                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  2. AI 输出工具调用请求 (AI 不直接执行，而是输出 "我想调用这个工具")                               │
├───────────────────────────┬───────────────────────────┬─────────────────────────────────────────┤
│  {                        │  {                        │  {                                      │
│    tool: "bash",          │    tool: "read",          │    tool: "browser",                     │
│    args: {                │    args: {                │    args: {                              │
│      command: "pnpm test" │      file: "config.json"  │      action: "navigate",               │
│    }                      │    }                      │      url: "github.com/org/repo/pull/1" │
│  }                        │  }                        │    }                                    │
│                           │                           │  }                                      │
└───────────────────────────┴───────────────────────────┴─────────────────────────────────────────┘
                │                         │                              │
                ▼                         ▼                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  3. 系统拦截解析请求                                                                              │
│     Agent Runtime 解析 AI 的输出，识别出这是一个工具调用请求                                       │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                │                         │                              │
                ▼                         ▼                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  4. 安全检查 (PreToolUse Hook)                                                                   │
│     Hooks System 检查: 工具是否允许？参数是否安全？是否需要人工确认？                               │
├───────────────────────────┬───────────────────────────┬─────────────────────────────────────────┤
│  检查: pnpm test 是否安全  │  检查: 文件路径是否允许    │  检查: URL 是否在白名单                  │
│  ✓ 通过 (测试命令安全)     │  ✓ 通过 (工作区内文件)     │  ✓ 通过 (github.com 允许)               │
└───────────────────────────┴───────────────────────────┴─────────────────────────────────────────┘
                │ ✓                       │ ✓                            │ ✓
                ▼                         ▼                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  5. 执行工具 (可能在 Tool Sandbox 中隔离执行)                                                     │
├───────────────────────────┬───────────────────────────┬─────────────────────────────────────────┤
│  exec("pnpm test")        │  readFile("config.json")  │  browser.navigate(url)                  │
│  → 运行测试脚本            │  → 返回文件内容            │  → 打开页面截图                          │
└───────────────────────────┴───────────────────────────┴─────────────────────────────────────────┘
                │                         │                              │
                ▼                         ▼                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  6. 后处理 (PostToolUse Hook) - 记录执行日志、处理错误、更新统计                                   │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                │                         │                              │
                ▼                         ▼                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  7. 返回结果给 AI                                                                                │
├───────────────────────────┬───────────────────────────┬─────────────────────────────────────────┤
│  { stdout: "Tests: 42     │  { content: "{...}"       │  { screenshot: <image>,                 │
│    passed, 0 failed" }    │  }                        │    title: "PR #1: Fix bug" }            │
└───────────────────────────┴───────────────────────────┴─────────────────────────────────────────┘
                │                         │                              │
                ▼                         ▼                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  8. AI 继续处理                                                                                  │
│     AI 可能: a) 调用更多工具 → 回到步骤 2 (循环)   b) 生成最终回复 → 结束                         │
├───────────────────────────┬───────────────────────────┬─────────────────────────────────────────┤
│  → 结束，回复测试结果       │  → 继续调用 edit 工具      │  → 结束，总结 PR 内容                    │
│                           │     修改配置后回复          │                                         │
└───────────────────────────┴───────────────────────────┴─────────────────────────────────────────┘
                │                         │                              │
                ▼                         ▼                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  AI 最终回复                                                                                     │
├───────────────────────────┬───────────────────────────┬─────────────────────────────────────────┤
│ "测试全部通过！42 个用例    │ "已修改 config.json，      │ "这个 PR 主要修复了登录页面              │
│  均成功，没有发现问题。"    │  将 debug 改为 false。"    │  的 bug，改动了 3 个文件..."            │
└───────────────────────────┴───────────────────────────┴─────────────────────────────────────────┘
```

---

## Agentic Loop 简化视图

```
                    ┌─────────────────────────────────────────────┐
                    │                                             │
                    ▼                                             │
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐        │
│  User   │───▶│   AI    │───▶│ System  │───▶│  Tool   │        │
│ Message │    │ Analyze │    │ Parse   │    │ Execute │        │
└─────────┘    └────┬────┘    └────┬────┘    └────┬────┘        │
                    │              │              │              │
                    │         PreToolUse     PostToolUse        │
                    │           Hook           Hook             │
                    │              │              │              │
                    │              ▼              ▼              │
                    │         ┌─────────────────────┐            │
                    │         │    Tool Result      │────────────┘
                    │         └─────────────────────┘   (循环直到完成)
                    │
                    ▼
             ┌─────────────┐
             │ Final Reply │
             └─────────────┘
```

### 场景 B 详细流程 (文件处理需要多轮工具调用)

```
用户: "帮我把 config.json 里的 debug 改成 false"

     ┌──────────────────────────────────────────────────────────────────┐
     │                        第一轮: 读取文件                           │
     │  AI → { tool: "read", args: { file: "config.json" } }           │
     │  结果 → { content: '{"debug": true, "port": 3000}' }            │
     └──────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌──────────────────────────────────────────────────────────────────┐
     │                        第二轮: 编辑文件                           │
     │  AI → { tool: "edit", args: {                                   │
     │           file: "config.json",                                   │
     │           old: '"debug": true',                                  │
     │           new: '"debug": false'                                  │
     │        }}                                                        │
     │  结果 → { success: true }                                        │
     └──────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌──────────────────────────────────────────────────────────────────┐
     │                        最终回复                                   │
     │  AI: "已将 config.json 中的 debug 从 true 改为 false。"          │
     └──────────────────────────────────────────────────────────────────┘
```

---

## 图例 (Legend)

| 符号 | 含义 |
|------|------|
| `═══` | 核心层边框 (Agent Layer) |
| `───` | 普通层边框 |
| `───▶` / `→` | 数据流向 |
| `★` | 核心模块标记 |
| `✓` / `✗` | 通过/拒绝 |

---

## 层级说明 (Layer Description)

| 层级 | 英文名 | 职责 |
|------|--------|------|
| 入口层 | Entry Layer | 接收各渠道消息，标准化为内部格式 |
| 网关层 | Gateway Layer | 路由、认证、Local/Remote/Tailscale 模式分发 |
| 代理层 | Agent Layer | **核心层** - 记忆管理、AI 调度、Agentic Loop 执行 |
| 外部服务 | External Services | LLM API、语音服务等第三方接口 |
| 基础设施 | Infrastructure | 配置、日志、安全、媒体处理等支撑服务 (Servant Pattern) |

---

## Gateway 模式对比

| 模式 | 宿主 | 端口 | 部署方式 | 适用场景 |
|------|------|------|----------|----------|
| **Local** | 用户本机 (Mac/PC/Linux) | `localhost:18789` | 直接安装 | 个人使用，数据本地 |
| **Remote** | 腾讯云VM / 其他VPS | `0.0.0.0:18789` | 直接安装 或 Docker | 团队共享，24/7 在线 |
| **Tailscale** | 任意 (通过 VPN) | 内网地址 | 同上 | 安全连接，无需公网暴露 |

## Tool Sandbox 说明

> **Sandbox 是工具执行隔离功能，不是 Gateway 部署方式**

- **用途**: 将 AI 的工具执行（exec、read、write 等）放入 Docker 容器中运行
- **隔离范围**: 文件系统和进程访问
- **配置位置**: `agents.defaults.sandbox`
- **详细文档**: [Sandboxing](/gateway/sandboxing)

---

## 验证清单 (Checklist)

- [x] 所有层都有展示 (Entry, Gateway, Agent, External, Infrastructure)
- [x] Agent Layer 居中且强调 (双线边框 + ★ 标记)
- [x] Local/Remote/Tailscale 模式清晰呈现 (含宿主和端口说明)
- [x] **Agentic Loop 完整流程** (1-8 步骤，含循环机制)
- [x] Session/Memory 明确展示
- [x] 工具交互流程完整 (PreToolUse → Execute → PostToolUse)
- [x] Infrastructure 纵向贯穿 (右侧)
- [x] 外部服务展示 (底部)
- [x] 中英混合标签
- [x] Servant Pattern 说明

---

*Generated for team reference | 团队内部参考*
