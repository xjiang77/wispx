# 构建自主Agent

**Claude Agent SDK 与 Anthropic 哲学**

基于 Thariq Shihipar 的 "Claude Agent SDK Workshop"

一个超越工具的框架，通过 Unix 原语和文件系统构建自己上下文的 Agent。

---

## AI 集成的演进

从无状态特性到**自主**轨迹。

### Level 1: 特性（Features）
**无状态**

一次性任务。分类、摘要。

> 提示示例: "将这封邮件标记为垃圾邮件。"

### Level 2: 工作流（Workflows）
**确定性**

结构化循环、RAG、固定逻辑流程。

> 提示示例: "根据这个代码库，建议下一个编辑。"

### Level 3: Agent
**自主**

上下文构建、轨迹决策、长时间运行（10-30分钟）。

> 提示示例: "重构这个遗留模块并编写测试。"

---

## Anthropic 方法论

基于 Claude Code 经验构建的技术栈。

Anthropic 工程师发现自己在反复重建相同的框架。SDK 基于**三个核心支柱**封装了这个框架：

### Unix 原语
Agent 应该使用标准接口如 Bash 和文件系统，而不是为每个操作构建脆弱的自定义工具。

### 上下文工程
上下文不仅仅是聊天历史；它是文件系统的状态。Agent 必须通过文件管理自己的状态。

### 代码生成用于逻辑
使用代码生成来解决推理问题（例如，编写脚本查询 API），而不是依赖 LLM "猜测"输出。

---

## 核心 Agent 循环

可靠的 Agent 在持续的 **收集-行动-验证** 循环中运行。

### 收集上下文（Gather Context）
- Grep、搜索、读取文件、SQL 查询

**问题：** 用户经常倾倒上下文。Agent 需要工具来探索，而不仅仅是预先提供的窗口。

### 执行行动（Take Action）
- 编写代码、执行 Bash、调用 API

**方法：** 利用代码生成或 Bash 进行灵活执行。

### 验证工作（Verify Work）
- Lint、编译、检查存在性

**规则：** 如果你不能验证工作，它就不应该是一个自主 Agent。

---

## 行动三位一体

在工具、Bash 和代码生成之间选择。

| 方法 | 最适合 | 优点 | 缺点 |
|------|--------|------|------|
| **结构化工具** | 原子性、安全的操作（如发送邮件） | 高度结构化、可靠、快速 | 高上下文使用、低可组合性、无可发现性 |
| **Bash** | 导航、文件操作、管道数据 | 低上下文使用、高度可组合（grep \| wc -l） | 发现延迟较高（需要 `--help`） |
| **代码生成** | 复杂推理、数据分析 | 最大灵活性、动态逻辑 | 最高延迟（需要链接/编译） |

---

## Bash 就是你所需要的一切

Bash 作为 Agent 推理的通用连接器。

### 概念

Bash 是最初的"代码模式"。它允许 Agent 使用现有软件，而不是为每个能力构建自定义工具。

- **记忆：** 将结果存储到文件
- **可组合性：** 管道输出
- **软件访问：** ffmpeg、jq、sqlite

### 示例
```bash
$ cat large_data.csv | awk -F, '$3 > 100 {print $1}' > high_value.txt

$ sqlite3 data.db "SELECT * FROM sales WHERE region='US'"

$ ffmpeg -i input.mp4 -ss 00:00:10 -t 00:00:20 output.mp4
```

**Anthropic 方式：** 使用标准 Unix 原语，而不是自定义的 "搜索 CSV" 工具。

---

## 上下文工程与文件系统

文件系统是 Agent 的长期记忆。

### 渐进式上下文披露

Agent "cd" 进入目录，只在需要时发现相关文件，防止上下文窗口溢出。

### 处理长输出

不要将 500 行 API JSON 倾倒到聊天中。将其写入文件，然后让 Agent grep 它需要的特定行。

### 文件结构示例
```
/project_root
├── /data
│   ├── output.json    ← 记忆库
│   └── logs.txt
├── /skills
│   ├── skills.md      ← 能力定义
│   └── postgres_query.py
└── /src
```

---

## 策略：用代码生成解决非编码任务

使用编码逻辑解决通用业务问题。

### 转换流程

1. **请求**（自然语言）
   - 任务：围绕妙蛙花构建一个竞技宝可梦团队。

2. **Agent 逻辑**（代码生成）
   - Agent 编写 TypeScript SDK 查询 PokeAPI。它不猜测数据；它获取数据。

3. **输出**（数据驱动）
   - 妙蛙花和队友的数据可视化

### 模式推广

- **查询：** 不要阅读 100 封邮件。编写脚本按发送者过滤并汇总价格。
- **数据趋势：** 不要发现趋势。编写 Python 绘制数据图表。

---

## 关键步骤：验证

如果你不能验证它，就不要为它构建自主 Agent。

### 确定性验证
编译器、Linter、类型检查器。

如果代码无法编译，Agent 会立即知道失败了。

### 基于规则的验证
启发式方法。

"如果写入文件，先检查文件是否存在。"
"如果输出为空，重试。"

### 对抗性验证 / 子 Agent
使用单独的 Agent 会话来批评第一个 Agent 的工作。

---

## 子 Agent 与并行化

在不污染主上下文窗口的情况下扩展能力。

### 架构
```
        Action: Search Sheet 1              Action: Search Sheet 2
              ↓                                    ↓
    ┌─────────────┐                      ┌─────────────┐
    │ Sub-Agent A │ ←──────────────────→ │ Sub-Agent B │
    └─────────────┘                      └─────────────┘
              ↓                                    ↓
        Value Found: $400                   Value Found: $200
                        ↘                ↙
                    ┌──────────────────┐
                    │  Manager Agent   │
                    │ (Clean Context)  │
                    └──────────────────┘
```

**说明：** 子 Agent 执行繁杂的工作（读取数千行）。Manager 只接收干净的最终答案，保持上下文卫生。

---

## 安全性："瑞士奶酪"模型

缓解致命三联体：代码执行 + 文件系统 + 数据泄露

### 模型层（Model Layer）
RLHF 和对齐。
拒绝做有害的事。

### 框架层（Harness Layer）
权限和解析器。
在执行前解析 Bash 命令以阻止危险标志。

### 沙箱层（Sandbox Layer）
网络隔离和监狱。
Docker/Cloudflare 容器。
如果被攻破，Agent 被困在没有生产密钥的一次性环境中。

---

## 原型工作流

从 CLI 到生产 SDK。

### 1. 从 Claude Code 开始
在终端中手动原型化逻辑。

### 2. 提取模式
将成功的逻辑（例如 SQL 模式）保存为可重用脚本或"技能"。

### 3. 迁移到 SDK
将经过验证的逻辑包装在 Agent SDK 中用于生产。

> **"简单不等于容易。"** 最终的 Agent 代码应该很小；智能在于提示和文件结构。

---

## Agent 工程师的心智模型

构建和调试自主系统的基本规则

### 阅读日志
调试 Agent 循环的唯一方法是逐行阅读日志。查找幻觉、工具误用和细微偏差。
```bash
> agent.log | tail -f
```

### 保持 Bash 风格
默认使用 Bash/文件。只对原子安全性使用自定义工具。过度工程化工具会导致脆弱性和安全风险。
```bash
> rm -rf /tmp/sandbox/*
```

### 为可逆性设计
Agent 在可逆环境（Git、编码）中表现出色，而不是不可逆环境。优先选择错误可以轻松撤销的环境。
```bash
> git reset --hard HEAD~1
```

### 丢弃代码
Agent 能力发展很快；每 6 个月重写你的框架。遗留框架很快成为技术债务。
```bash
> rm harness_v1.py
```

---

## 将哲学应用于实践

超越简单编码助手的用例。

### 电子表格 Agent
**问题：** 搜索 10 万行。

**解决方案：** Agent 将 CSV 转换为 SQLite 或 Python 脚本进行过滤。**永远不加载整个表格。**

```
CSV 文件 → Agent 处理 → SQLite/Python 脚本 → 过滤结果（<100行）
(100k行)                    (Pandas df.query(...))
```

### 仪表板构建
**问题：** 动态 UI。

**解决方案：** Agent 在沙箱内运行本地开发服务器（React/Vite）；用户实时看到更新的实时预览。

```
本地开发服务器 → 沙箱环境 → 实时预览 → Agent 控制器
(npm run dev)    (port: 3000)  (React/Vite)   (Watching for changes...)
```

### 网络安全
**问题：** 日志分析。

**解决方案：** Agent 使用 Bash 来 `grep` 日志、隔离模式并**总结**威胁。

```
日志文件           → Bash 工具                              → 威胁摘要
(access.log,        (grep -r "Failed password" /var/log      • IP 192.168.1.50: 50 次失败登录尝试
auth.log)            | awk '{print $11}' | sort | uniq -c)   • 检测到潜在暴力破解
```

---

## 未来：构建自己上下文的 Agent

# 收集
# 行动
# 验证

摆脱僵化的工作流。拥抱开发者工具。开始使用 SDK 构建，使用沙箱，记住：**Bash 就是你所需要的一切。**

---

**资源：** Claude Agent SDK | Anthropic Workshop
