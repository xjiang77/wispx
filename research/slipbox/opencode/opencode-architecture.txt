┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                              OpenCode 技术架构                                                               │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌──────────┐  ┌────────────┐  ╔══════════════════════════════════════════════════════════════════════════════════════╗  ┌───────────┐
│  CLIENT  │  │   SERVER   │  ║                          CORE PROCESSING LAYER                                       ║  │ EXTERNAL  │
│  (蓝)    │→ │   (黄)     │→ ║                              (绿)                                                     ║→ │   (红)    │
├──────────┤  ├────────────┤  ╠══════════════════════════════════════════════════════════════════════════════════════╣  ├───────────┤
│Interfaces│  │ Hono HTTP  │  ║ ┌──────────────────────────────────────────────────────────────────────────────────┐ ║  │   LLM     │
│──────────│  │ ──────────  │  ║ │ AI SDK (Vercel AI SDK)                                                          │ ║  │ Providers │
│ TUI      │  │ REST API   │  ║ │ ┌───────────┐ ┌─────────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────┐ │ ║  │───────────│
│ Desktop  │  │ SSE Stream │  ║ │ │streamText │ │wrapLanguageModel│ │generateObject│ │Provider Route│ │Model Sel │ │ ║  │ Anthropic │
│ VS Code  │  │ Middleware │  ║ │ └───────────┘ └─────────────────┘ └──────────────┘ └──────────────┘ └──────────┘ │ ║  │ OpenAI    │
│ CLI      │  │ Static     │  ║ └──────────────────────────────────────────────────────────────────────────────────┘ ║  │ Google    │
│ Mobile   │  ├────────────┤  ║ ┌──────────────────────────────────────────────────────────────────────────────────┐ ║  │ 20+ more  │
├──────────┤  │ Session    │  ║ │ AGENT LAYER (代理层)                                                             │ ║  ├───────────┤
│ Protocol │  │ ──────────  │  ║ │ ┌──────────────────────────────────────────────────────────────────────────┐   │ ║  │   MCP     │
│──────────│  │ Store      │  ║ │ │ Agent Modes: [build] [plan] [explore] [general] [custom]                 │   │ ║  │  Servers  │
│ HTTP/REST│  │ Converse   │  ║ │ └──────────────────────────────────────────────────────────────────────────┘   │ ║  │───────────│
│ SSE      │  │ AbortCtrl  │  ║ │ ┌──────────────────────────────────────────────────────────────────────────┐   │ ║  │ stdio     │
├──────────┤  ├────────────┤  ║ │ │ SessionPrompt.loop() - while (true) {                                    │   │ ║  │ HTTP/SSE  │
│ Input    │  │ Permission │  ║ │ │  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌───────────────┐       │   │ ║  ├───────────┤
│──────────│  │ ──────────  │  ║ │ │  │ 获取状态 │ →  │ 调用 LLM │ →  │ 处理响应 │ →  │ 执行工具/Skill│       │   │ ║  │   LSP     │
│ Text/Cmd │  │ ToolApprv  │  ║ │ │  │ messages │    │streamText│    │ text/tool│    │  (见执行层)   │       │   │ ║  │  Servers  │
│ Files    │  │ Sandbox    │  ║ │ │  └──────────┘    └──────────┘    └──────────┘    └───────────────┘       │   │ ║  │───────────│
│          │  │ AllowBlock │  ║ │ │      ↑                                                   │               │   │ ║  │14+ Langs  │
│          │  ├────────────┤  ║ │ │      └───────────────────── result ←─────────────────────┘               │   │ ║  │           │
│          │  │ EventBus   │  ║ │ │ }   [终止条件: finish_reason=stop | length | 无tool_calls]               │   │ ║  │           │
│          │  │ → SSE      │  ║ │ └──────────────────────────────────────────────────────────────────────────┘   │ ║  │           │
│          │  │            │  ║ └──────────────────────────────────────────────────────────────────────────────────┘ ║  │           │
│          │  │            │  ║ ┌──────────────────────────────────────────────────────────────────────────────────┐ ║  │           │
│          │  │            │  ║ │ EXECUTION LAYER (执行层)                                                         │ ║  │           │
│          │  │            │  ║ │ ┌────────────────────────────────────────────────────────────────────────────┐   │ ║  │           │
│          │  │            │  ║ │ │ Skills (高级抽象) [紫色] - 用户定义的能力扩展                              │   │ ║  │           │
│          │  │            │  ║ │ │ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐                     │   │ ║  │           │
│          │  │            │  ║ │ │ │/commit │ │/review │ │ /iwiki │ │ /pptx  │ │/custom │ ...                 │   │ ║  │           │
│          │  │            │  ║ │ │ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘                     │   │ ║  │           │
│          │  │            │  ║ │ └────────────────────────────────────┬───────────────────────────────────────┘   │ ║  │           │
│          │  │            │  ║ │                                      ↓ 展开为工具调用序列                        │ ║  │           │
│          │  │            │  ║ │ ┌────────────────────────────────────────────────────────────────────────────┐   │ ║  │           │
│          │  │            │  ║ │ │ Tools (基础工具): validate → [ctx.ask() 权限] → execute → result          │   │ ║  │           │
│          │  │            │  ║ │ │ ┌────┐ ┌────┐ ┌─────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌───────┐ ┌────┐ ...    │   │ ║  │           │
│          │  │            │  ║ │ │ │bash│ │read│ │write│ │edit│ │grep│ │glob│ │task│ │webfetch│ │mcp │        │   │ ║  │           │
│          │  │            │  ║ │ │ └────┘ └────┘ └─────┘ └────┘ └────┘ └────┘ └────┘ └───────┘ └────┘        │   │ ║  │           │
│          │  │            │  ║ │ └────────────────────────────────────────────────────────────────────────────┘   │ ║  │           │
│          │  │            │  ║ └──────────────────────────────────────────────────────────────────────────────────┘ ║  │           │
│          │  │            │  ║ ┌──────────────────────────────────────────────────────────────────────────────────┐ ║  │           │
│          │  │            │  ║ │ PROVIDER & MCP LAYER (连接层)                                                    │ ║  │           │
│          │  │            │  ║ │ ┌─────────────────────────────────────┐ ┌──────────────────────────────────────┐ │ ║  │           │
│          │  │            │  ║ │ │ Provider Abstraction                │ │ MCP Client                           │ │ ║  │           │
│          │  │            │  ║ │ │ 统一接口连接 20+ LLM                 │ │ 连接外部工具和服务                    │ │ ║  │           │
│          │  │            │  ║ │ │ ┌─────────┐┌──────┐┌──────┐ +20     │ │ ┌─────┐┌────┐┌───┐┌────────────┐     │ │ ║  │           │
│          │  │            │  ║ │ │ │Anthropic││OpenAI││Google│ more... │ │ │stdio││HTTP││SSE││ErrorHandler│     │ │ ║  │           │
│          │  │            │  ║ │ │ └─────────┘└──────┘└──────┘         │ │ └─────┘└────┘└───┘└────────────┘     │ │ ║  │           │
│          │  │            │  ║ │ └─────────────────────────────────────┘ └──────────────────────────────────────┘ │ ║  │           │
│          │  │            │  ║ └──────────────────────────────────────────────────────────────────────────────────┘ ║  │           │
└──────────┘  └────────────┘  ╚══════════════════════════════════════════════════════════════════════════════════════╝  └───────────┘
      ↑              ↑                                              ↓
      └──────────────┴──────────────────────────────────────────────┘
                              (response via SSE)

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                              INFRASTRUCTURE (灰)                                                             │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │
│  │File System│ │ Event Bus │ │  Config   │ │  Logging  │ │   Cache   │ │  Crypto   │ │Process IPC│ │  Sandbox  │           │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘           │
│  ┌──────────────────────────┐ ┌────────────────────────────┐ ┌──────────────────────────┐ ┌──────────────────────────┐     │
│  │       Bun Runtime        │ │  OS (macOS/Linux/Windows)  │ │   Network (HTTP/SSE/IPC) │ │  Security (Permissions)  │     │
│  └──────────────────────────┘ └────────────────────────────┘ └──────────────────────────┘ └──────────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────┐
│          图例              │
├────────────────────────────┤
│ ┌────┐ Client (蓝)        │
│ ├────┤ Server (黄)        │
│ ╔════╗ Core   (绿)        │
│ ┌────┐ External(红)       │
│ ┌────┐ Skill  (紫)        │
│ ┌────┐ Infra  (灰)        │
│ →    request              │
│ ⤏    response (dashed)    │
└────────────────────────────┘
